<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>gRPC(Go)教程(五)---拦截器Interceptor -</title><meta name=Description content="gRPC拦截器使用"><meta property="og:title" content="gRPC(Go)教程(五)---拦截器Interceptor"><meta property="og:description" content="gRPC拦截器使用"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.yudlk.com/posts/grpc/05-interceptor/"><meta property="og:image" content="https://blog.yudlk.com/img/jinx.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-02T22:00:00+00:00"><meta property="article:modified_time" content="2021-01-02T22:00:00+00:00"><meta property="og:site_name" content="qpt的个人博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.yudlk.com/img/jinx.png"><meta name=twitter:title content="gRPC(Go)教程(五)---拦截器Interceptor"><meta name=twitter:description content="gRPC拦截器使用"><meta name=application-name content="指月小筑"><meta name=apple-mobile-web-app-title content="指月小筑"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.yudlk.com/posts/grpc/05-interceptor/><link rel=prev href=https://blog.yudlk.com/posts/grpc/04-encryption-tls/><link rel=next href=https://blog.yudlk.com/posts/grpc/06-auth/><link rel=stylesheet href=/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"gRPC(Go)教程(五)---拦截器Interceptor","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.yudlk.com\/posts\/grpc\/05-interceptor\/"},"image":["https:\/\/blog.yudlk.com\/img\/jinx.png"],"genre":"posts","keywords":"gRPC","wordcount":2801,"url":"https:\/\/blog.yudlk.com\/posts\/grpc\/05-interceptor\/","datePublished":"2021-01-02T22:00:00+00:00","dateModified":"2021-01-02T22:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"qpt"},"description":"gRPC拦截器使用"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title>指月小筑</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=指月小筑>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/ title=关于>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title>指月小筑</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title=指月小筑>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">gRPC(Go)教程(五)---拦截器Interceptor</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/lixd title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>qpt</a></span>&nbsp;<span class=post-category>included in <a href=/categories/grpc/><i class="far fa-folder fa-fw" aria-hidden=true></i>gRPC</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-01-02>2021-01-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2801 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-概述>1. 概述</a></li><li><a href=#2-定义>2. 定义</a><ul><li><a href=#客户端拦截器>客户端拦截器</a></li><li><a href=#服务端拦截器>服务端拦截器</a></li></ul></li><li><a href=#3-unaryinterceptor>3. UnaryInterceptor</a><ul><li><a href=#client>Client</a></li><li><a href=#server>Server</a></li><li><a href=#test>Test</a></li></ul></li><li><a href=#4-streaminterceptor>4. StreamInterceptor</a><ul><li><a href=#client-1>Client</a></li><li><a href=#server-1>Server</a></li><li><a href=#test-1>Test</a></li></ul></li><li><a href=#5-小结>5. 小结</a></li><li><a href=#6-参考>6. 参考</a></li></ul></nav></div></div><div class=content id=content><p>本文主要介绍了 gPRC中 的拦截器(Interceptor)和具体使用实例。</p><h2 id=1-概述>1. 概述</h2><blockquote><p>gRPC 系列相关代码见 <a href=https://github.com/lixd/grpc-go-example target=_blank rel="noopener noreffer">Github</a></p></blockquote><p>gRPC 提供了 Interceptor 功能，包括客户端拦截器和服务端拦截器。可以在接收到请求或者发起请求之前优先对请求中的数据做一些处理后再转交给指定的服务处理并响应，很适合在这里处理验证、日志等流程。</p><p>gRPC-go 在 v1.28.0版本增加了多 interceptor 支持，可以在不借助第三方库（go-grpc-middleware）的情况下添加多个 interceptor 了。</p><blockquote><p>go-grpc-middleware 中也提供了多种常用 interceptor ，可以直接使用。</p></blockquote><p>在 gRPC 中，根据拦截的方法类型不同可以分为拦截 Unary 方法的<strong>一元拦截器</strong>，和作用于 Stream 方法的<strong>流拦截器</strong>。</p><p>同时还分为<strong>服务端拦截器</strong>和<strong>客户端拦截器</strong>，所以一共有以下4种类型:</p><ul><li>grpc.UnaryServerInterceptor</li><li>grpc.StreamServerInterceptor</li><li>grpc.UnaryClientInterceptor</li><li>grpc.StreamClientInterceptor</li></ul><h2 id=2-定义>2. 定义</h2><h3 id=客户端拦截器>客户端拦截器</h3><p>使用客户端拦截器 只需要在 Dial的时候指定相应的 DialOption 即可。</p><h4 id=unary-interceptor>Unary Interceptor</h4><p>客户端一元拦截器类型为 <code>grpc.UnaryClientInterceptor</code>，具体如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UnaryClientInterceptor</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>method</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>ClientConn</span><span class=p>,</span> <span class=nx>invoker</span> <span class=nx>UnaryInvoker</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>CallOption</span><span class=p>)</span> <span class=kt>error</span>
</span></span></code></pre></div><p>可以看到，所谓的<strong>拦截器其实就是一个函数</strong>，可以分为<code>预处理(pre-processing)</code>、<code>调用RPC方法(invoking RPC method)</code>、<code>后处理(post-processing)</code>三个阶段。</p><p>参数含义如下:</p><ul><li>ctx：Go语言中的上下文，一般和 Goroutine 配合使用，起到超时控制的效果</li><li>method：当前调用的 RPC 方法名</li><li>req：本次请求的参数，只有在<code>处理前</code>阶段修改才有效</li><li>reply：本次请求响应，需要在<code>处理后</code>阶段才能获取到</li><li>cc：gRPC 连接信息</li><li>invoker：可以看做是当前 RPC 方法，一般在拦截器中调用 invoker 能达到调用 RPC 方法的效果，当然底层也是 gRPC 在处理。</li><li>opts：本次调用指定的 options 信息</li></ul><p>作为一个客户端拦截器，可以在<code>处理前</code>检查 req 看看本次请求带没带 token 之类的鉴权数据，没有的话就可以在拦截器中加上。</p><h4 id=stream-interceptor>Stream Interceptor</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>StreamClientInterceptor</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>desc</span> <span class=o>*</span><span class=nx>StreamDesc</span><span class=p>,</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>ClientConn</span><span class=p>,</span> <span class=nx>method</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>streamer</span> <span class=nx>Streamer</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=nx>ClientStream</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></div><p>由于 StreamAPI 和 UnaryAPI有所不同，因此拦截器方面也有所区别，比如 req 参数变成了 streamer 。同时其拦截过程也有所不同，不在是处理 req resp，而是对 streamer 这个流对象进行包装，比如说实现自己的 SendMsg 和 RecvMsg 方法。</p><p>然后在这些方法中的<code>预处理(pre-processing)</code>、<code>调用RPC方法(invoking RPC method)</code>、<code>后处理(post-processing)</code>各个阶段加入自己的逻辑。</p><h3 id=服务端拦截器>服务端拦截器</h3><p>服务端拦截器和客户端拦截器类似，就不做过多描述。使用客户端拦截器 只需要在 NewServer 的时候指定相应的 ServerOption 即可。</p><h4 id=unary-interceptor-1>Unary Interceptor</h4><p>定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UnaryServerInterceptor</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>UnaryServerInfo</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>UnaryHandler</span><span class=p>)</span> <span class=p>(</span><span class=nx>resp</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></div><p>参数具体含义如下：</p><ul><li>ctx context.Context：请求上下文</li><li>req interface{}：RPC 方法的请求参数</li><li>info *UnaryServerInfo：RPC 方法的所有信息</li><li>handler UnaryHandler：RPC 方法真正执行的逻辑</li></ul><h4 id=stream-interceptor-1>Stream Interceptor</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>StreamServerInterceptor</span> <span class=kd>func</span><span class=p>(</span><span class=nx>srv</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>ss</span> <span class=nx>ServerStream</span><span class=p>,</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>StreamServerInfo</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>StreamHandler</span><span class=p>)</span> <span class=kt>error</span>
</span></span></code></pre></div><h2 id=3-unaryinterceptor>3. UnaryInterceptor</h2><p>一元拦截器可以分为3个阶段：</p><ul><li>1）预处理(pre-processing)</li><li>2）调用RPC方法(invoking RPC method)</li><li>3）后处理(post-processing)</li></ul><h3 id=client>Client</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// unaryInterceptor 一个简单的 unary interceptor 示例。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>unaryInterceptor</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>method</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConn</span><span class=p>,</span> <span class=nx>invoker</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryInvoker</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pre-processing
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nf>invoker</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reply</span><span class=p>,</span> <span class=nx>cc</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span> <span class=c1>// invoking RPC method
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// post-processing
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>end</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nf>logger</span><span class=p>(</span><span class=s>&#34;RPC: %s, req:%v start time: %s, end time: %s, err: %v&#34;</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>start</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>),</span> <span class=nx>end</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>invoker(ctx, method, req, reply, cc, opts...)</code> 是真正调用 RPC 方法。因此我们可以在调用前后增加自己的逻辑：比如调用前检查一下参数之类的，调用后记录一下本次请求处理耗时等。</p><p>建立连接时通过 grpc.WithUnaryInterceptor 指定要加载的拦截器即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>creds</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>credentials</span><span class=p>.</span><span class=nf>NewClientTLSFromFile</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=s>&#34;x509/server.crt&#34;</span><span class=p>),</span> <span class=s>&#34;www.lixueduan.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to load credentials: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 建立连接时指定要加载的拦截器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=o>*</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithTransportCredentials</span><span class=p>(</span><span class=nx>creds</span><span class=p>),</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithUnaryInterceptor</span><span class=p>(</span><span class=nx>unaryInterceptor</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>ecpb</span><span class=p>.</span><span class=nf>NewEchoClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>callUnaryEcho</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=s>&#34;hello world&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=server>Server</h3><p>服务端的一元拦截器和客户端类似：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>unaryInterceptor</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryServerInfo</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryHandler</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>handler</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>end</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 记录请求参数 耗时 错误信息等数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>logger</span><span class=p>(</span><span class=s>&#34;RPC: %s,req:%v start time: %s, end time: %s, err: %v&#34;</span><span class=p>,</span> <span class=nx>info</span><span class=p>.</span><span class=nx>FullMethod</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>start</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>),</span> <span class=nx>end</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>服务端则是在 NewServer 时指定拦截器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%d&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>creds</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>credentials</span><span class=p>.</span><span class=nf>NewServerTLSFromFile</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=s>&#34;x509/server.crt&#34;</span><span class=p>),</span> <span class=nx>data</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=s>&#34;x509/server.key&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to create credentials: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>Creds</span><span class=p>(</span><span class=nx>creds</span><span class=p>),</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>UnaryInterceptor</span><span class=p>(</span><span class=nx>unaryInterceptor</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterEchoServer</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server gRPC on 0.0.0.0&#34;</span> <span class=o>+</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%d&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=test>Test</h3><p>Server</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>2021/01/24 19:18:09 Server gRPC on 0.0.0.0:50051
</span></span><span class=line><span class=cl>unary echoing message <span class=s2>&#34;hello world&#34;</span>
</span></span><span class=line><span class=cl>LOG:    RPC: /echo.Echo/UnaryEcho,req:message:<span class=s2>&#34;hello world&#34;</span> start time: 2021-01-24T19:18:10+08:00, end time: 2021-01-24T19:18:10+08:00, err: &lt;nil&gt;
</span></span></code></pre></div><p>Client</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>LOG:    RPC: /echo.Echo/UnaryEcho, req:message:<span class=s2>&#34;hello world&#34;</span> start time: 2021-01-24T19:18:10+08:00, end time: 2021-01-24T19:18:10+08:00, err: &lt;nil&gt;
</span></span><span class=line><span class=cl>UnaryEcho:  hello world
</span></span></code></pre></div><h2 id=4-streaminterceptor>4. StreamInterceptor</h2><p>流拦截器过程和一元拦截器有所不同，不过同样可以分为3个阶段：</p><ul><li>1）预处理(pre-processing)</li><li>2）调用RPC方法(invoking RPC method)</li><li>3）后处理(post-processing)</li></ul><p>预处理阶段和一元拦截器类似，但是调用RPC方法和后处理这两个阶段则完全不同。</p><p>StreamAPI 的请求和响应都是通过 Stream 进行传递的，更进一步是通过 Streamer 调用 SendMsg 和 RecvMsg 这两个方法获取的。</p><p>然后 Streamer 又是调用RPC方法来获取的，所以在流拦截器中我们可以<strong>对 Streamer 进行包装，然后实现 SendMsg 和 RecvMsg 这两个方法</strong>。</p><h3 id=client-1>Client</h3><p>本例中通过结构体嵌入的方式，对 Streamer 进行包装，在 SendMsg 和 RecvMsg 之前打印出具体的值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// wrappedStream  用于包装 grpc.ClientStream 结构体并拦截其对应的方法。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>wrappedStream</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientStream</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newWrappedStream</span><span class=p>(</span><span class=nx>s</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientStream</span><span class=p>)</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientStream</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>wrappedStream</span><span class=p>{</span><span class=nx>s</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>wrappedStream</span><span class=p>)</span> <span class=nf>RecvMsg</span><span class=p>(</span><span class=nx>m</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>logger</span><span class=p>(</span><span class=s>&#34;Receive a message (Type: %T) at %v&#34;</span><span class=p>,</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nx>ClientStream</span><span class=p>.</span><span class=nf>RecvMsg</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>wrappedStream</span><span class=p>)</span> <span class=nf>SendMsg</span><span class=p>(</span><span class=nx>m</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>logger</span><span class=p>(</span><span class=s>&#34;Send a message (Type: %T) at %v&#34;</span><span class=p>,</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nx>ClientStream</span><span class=p>.</span><span class=nf>SendMsg</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// streamInterceptor 一个简单的 stream interceptor 示例。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>streamInterceptor</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>desc</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>StreamDesc</span><span class=p>,</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConn</span><span class=p>,</span> <span class=nx>method</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>streamer</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>Streamer</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientStream</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>streamer</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>desc</span><span class=p>,</span> <span class=nx>cc</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 返回的是自定义的封装过的 stream
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nf>newWrappedStream</span><span class=p>(</span><span class=nx>s</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>连接时则通过 <code>grpc.WithStreamInterceptor</code> 指定要加载的拦截器。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>creds</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>credentials</span><span class=p>.</span><span class=nf>NewClientTLSFromFile</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=s>&#34;x509/server.crt&#34;</span><span class=p>),</span> <span class=s>&#34;www.lixueduan.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to load credentials: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 建立连接时指定要加载的拦截器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=o>*</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithTransportCredentials</span><span class=p>(</span><span class=nx>creds</span><span class=p>),</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithStreamInterceptor</span><span class=p>(</span><span class=nx>streamInterceptor</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>ecpb</span><span class=p>.</span><span class=nf>NewEchoClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// callUnaryEcho(client, &#34;hello world&#34;)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>callBidiStreamingEcho</span><span class=p>(</span><span class=nx>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=server-1>Server</h3><p>和客户端类似。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>wrappedStream</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>grpc</span><span class=p>.</span><span class=nx>ServerStream</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newWrappedStream</span><span class=p>(</span><span class=nx>s</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>)</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ServerStream</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>wrappedStream</span><span class=p>{</span><span class=nx>s</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>wrappedStream</span><span class=p>)</span> <span class=nf>RecvMsg</span><span class=p>(</span><span class=nx>m</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>logger</span><span class=p>(</span><span class=s>&#34;Receive a message (Type: %T) at %s&#34;</span><span class=p>,</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>.</span><span class=nf>RecvMsg</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>wrappedStream</span><span class=p>)</span> <span class=nf>SendMsg</span><span class=p>(</span><span class=nx>m</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>logger</span><span class=p>(</span><span class=s>&#34;Send a message (Type: %T) at %v&#34;</span><span class=p>,</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>.</span><span class=nf>SendMsg</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>streamInterceptor</span><span class=p>(</span><span class=nx>srv</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>ss</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>,</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>StreamServerInfo</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>StreamHandler</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 包装 grpc.ServerStream 以替换 RecvMsg SendMsg这两个方法。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nf>handler</span><span class=p>(</span><span class=nx>srv</span><span class=p>,</span> <span class=nf>newWrappedStream</span><span class=p>(</span><span class=nx>ss</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>logger</span><span class=p>(</span><span class=s>&#34;RPC failed with error %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>相似的，通过<code>grpc.StreamInterceptor</code>指定要加载的拦截器。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%d&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>creds</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>credentials</span><span class=p>.</span><span class=nf>NewServerTLSFromFile</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=s>&#34;x509/server.crt&#34;</span><span class=p>),</span> <span class=nx>data</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=s>&#34;x509/server.key&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to create credentials: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>Creds</span><span class=p>(</span><span class=nx>creds</span><span class=p>),</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>StreamInterceptor</span><span class=p>(</span><span class=nx>streamInterceptor</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterEchoServer</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server gRPC on 0.0.0.0&#34;</span> <span class=o>+</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%d&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=test-1>Test</h3><p>Server</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>lixd@17x:~/17x/projects/grpc-go-example/features/interceptor/server$ go run main.go 
</span></span><span class=line><span class=cl>2021/01/24 19:58:12 Server gRPC on 0.0.0.0:50051
</span></span><span class=line><span class=cl>LOG:    Receive a message <span class=o>(</span>Type: *echo.EchoRequest<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span><span class=line><span class=cl>bidi echoing message <span class=s2>&#34;Request 1&#34;</span>
</span></span><span class=line><span class=cl>LOG:    Send a message <span class=o>(</span>Type: *echo.EchoResponse<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span><span class=line><span class=cl>LOG:    Receive a message <span class=o>(</span>Type: *echo.EchoRequest<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span><span class=line><span class=cl>bidi echoing message <span class=s2>&#34;Request 2&#34;</span>
</span></span><span class=line><span class=cl>LOG:    Send a message <span class=o>(</span>Type: *echo.EchoResponse<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span><span class=line><span class=cl>LOG:    Receive a message <span class=o>(</span>Type: *echo.EchoRequest<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span></code></pre></div><p>Client</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>lixd@17x:~/17x/projects/grpc-go-example/features/interceptor/client$ go run main.go 
</span></span><span class=line><span class=cl>LOG:    Send a message <span class=o>(</span>Type: *echo.EchoRequest<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span><span class=line><span class=cl>LOG:    Send a message <span class=o>(</span>Type: *echo.EchoRequest<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span><span class=line><span class=cl>LOG:    Receive a message <span class=o>(</span>Type: *echo.EchoResponse<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span><span class=line><span class=cl>BidiStreaming Echo:  Request <span class=m>1</span>
</span></span><span class=line><span class=cl>LOG:    Receive a message <span class=o>(</span>Type: *echo.EchoResponse<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span><span class=line><span class=cl>BidiStreaming Echo:  Request <span class=m>2</span>
</span></span><span class=line><span class=cl>LOG:    Receive a message <span class=o>(</span>Type: *echo.EchoResponse<span class=o>)</span> at 2021-01-24T19:58:14+08:00
</span></span></code></pre></div><h2 id=5-小结>5. 小结</h2><p><strong>1）拦截器分类与定义</strong>
gRPC 拦截器可以分为：一元拦截器和流拦截器，服务端拦截器和客户端拦截器。</p><p>一共有以下4种类型:</p><ul><li>grpc.UnaryServerInterceptor</li><li>grpc.StreamServerInterceptor</li><li>grpc.UnaryClientInterceptor</li><li>grpc.StreamClientInterceptor</li></ul><p>拦截器本质上就是一个特定类型的函数，所以实现拦截器只需要实现对应类型方法（<strong>方法签名相同</strong>）即可。</p><p><strong>2）拦截器执行过程</strong></p><p><strong>一元拦截器</strong></p><ul><li>1）预处理</li><li>2）调用RPC方法</li><li>3）后处理</li></ul><p><strong>流拦截器</strong></p><ul><li>1）预处理</li><li>2）调用RPC方法 获取 Streamer</li><li>3）后处理<ul><li>调用 SendMsg 、RecvMsg 之前</li><li>调用 SendMsg 、RecvMsg</li><li>调用 SendMsg 、RecvMsg 之后</li></ul></li></ul><p><strong>3）拦截器使用及执行顺序</strong></p><p><strong>配置多个拦截器时，会按照参数传入顺序依次执行</strong></p><p>所以，<strong>如果想配置一个 Recovery 拦截器则必须放在第一个</strong>，放在最后则无法捕获前面执行的拦截器中触发的 panic。</p><p>同时也可以将 一元和流拦截器一起配置，gRPC 会根据不同方法选择对应类型的拦截器执行。</p><p>最后推荐一下这个 <a href=https://github.com/grpc-ecosystem/go-grpc-middleware target=_blank rel="noopener noreffer">go-grpc-middleware</a>，该仓库提供了多种常用拦截器。</p><blockquote><p>gRPC 系列相关代码见 <a href=https://github.com/lixd/grpc-go-example target=_blank rel="noopener noreffer">Github</a></p></blockquote><h2 id=6-参考>6. 参考</h2><p><code>https://eddycjy.com/posts/go/grpc/2018-10-10-interceptor/</code></p><p><code>https://github.com/grpc/grpc-go</code></p><p><code>https://github.com/grpc-ecosystem/go-grpc-middleware</code></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-01-02</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.yudlk.com/posts/grpc/05-interceptor/ data-title=gRPC(Go)教程(五)---拦截器Interceptor data-hashtags=gRPC><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.yudlk.com/posts/grpc/05-interceptor/ data-hashtag=gRPC><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.yudlk.com/posts/grpc/05-interceptor/ data-title=gRPC(Go)教程(五)---拦截器Interceptor><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.yudlk.com/posts/grpc/05-interceptor/ data-title=gRPC(Go)教程(五)---拦截器Interceptor><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.yudlk.com/posts/grpc/05-interceptor/ data-title=gRPC(Go)教程(五)---拦截器Interceptor><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/grpc/>gRPC</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/grpc/04-encryption-tls/ class=prev rel=prev title=gRPC(Go)教程(四)---通过SSL/TLS建立安全连接><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>gRPC(Go)教程(四)---通过SSL/TLS建立安全连接</a>
<a href=/posts/grpc/06-auth/ class=next rel=next title=gRPC(Go)教程(六)---自定义身份校验>gRPC(Go)教程(六)---自定义身份校验<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/lixd target=_blank>qpt</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a rel="license external nofollow noopener noreffer" href=https://beian.miit.gov.cn/ target=_blank>渝ICP备20005680号-1</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.480e58b2c2a8605d406f34667e92ff8f1ae50cfee5b653bead570f004839a983.js integrity="sha256-SA5YssKoYF1AbzRmfpL/jxrlDP7ltlO+rVcPAEg5qYM="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-FL23FNP7CM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-FL23FNP7CM" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b7c98449a6edf8492a8f3404e6d06a0",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7693630257897132" crossorigin=anonymous></script></body></html>