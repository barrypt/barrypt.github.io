<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Tekton教程(一)---云原生 CICD: Tekton 初体验 -</title><meta name=Description content="在 k8s 集群中快速部署 tekton pipeline、trigger、dashboard 等组件"><meta property="og:title" content="Tekton教程(一)---云原生 CICD: Tekton 初体验"><meta property="og:description" content="在 k8s 集群中快速部署 tekton pipeline、trigger、dashboard 等组件"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.yudlk.com/posts/tekton/01-deploy-tekton/"><meta property="og:image" content="https://blog.yudlk.com/img/jinx.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-01T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-01T00:00:00+00:00"><meta property="og:site_name" content="qpt的个人博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.yudlk.com/img/jinx.png"><meta name=twitter:title content="Tekton教程(一)---云原生 CICD: Tekton 初体验"><meta name=twitter:description content="在 k8s 集群中快速部署 tekton pipeline、trigger、dashboard 等组件"><meta name=application-name content="面对疾风"><meta name=apple-mobile-web-app-title content="面对疾风"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.yudlk.com/posts/tekton/01-deploy-tekton/><link rel=prev href=https://blog.yudlk.com/posts/kubernetes/15-kind-kubernetes-in-docker/><link rel=next href=https://blog.yudlk.com/posts/tekton/02-tekton-task-pipeline/><link rel=stylesheet href=/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Tekton教程(一)---云原生 CICD: Tekton 初体验","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.yudlk.com\/posts\/tekton\/01-deploy-tekton\/"},"image":["https:\/\/blog.yudlk.com\/img\/jinx.png"],"genre":"posts","keywords":"tekton","wordcount":2481,"url":"https:\/\/blog.yudlk.com\/posts\/tekton\/01-deploy-tekton\/","datePublished":"2023-01-01T00:00:00+00:00","dateModified":"2023-01-01T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"qpt"},"description":"在 k8s 集群中快速部署 tekton pipeline、trigger、dashboard 等组件"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title>面对疾风</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=面对疾风>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/ title=关于>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title>面对疾风</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title=面对疾风>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Tekton教程(一)---云原生 CICD: Tekton 初体验</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/barrypt title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>qpt</a></span>&nbsp;<span class=post-category>included in <a href=/categories/tekton/><i class="far fa-folder fa-fw" aria-hidden=true></i>tekton</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-01-01>2023-01-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2481 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-tekton-是什么>1. Tekton 是什么？</a><ul><li><a href=#优点>优点</a></li><li><a href=#组件>组件</a></li></ul></li><li><a href=#2-部署>2. 部署</a><ul><li><a href=#环境准备>环境准备</a></li><li><a href=#部署-pipeline>部署 Pipeline</a></li><li><a href=#部署-trigger>部署 Trigger</a></li><li><a href=#部署-dashboard>部署 Dashboard</a></li></ul></li><li><a href=#3-demo>3. Demo</a></li></ul></nav></div></div><div class=content id=content><p>本文主要记录了如何在 k8s 上快速部署云原生的 CI/CD 框架 tekton 的各个组件，包括 pipeline、trigger、dashboard 等，最后运行了一个简单的 demo 以体验 tekton 的功能。</p><h2 id=1-tekton-是什么>1. Tekton 是什么？</h2><p><a href=https://tekton.dev/ target=_blank rel="noopener noreffer">Tekton</a> 是一款功能非常强大而灵活的开源的 CI/CD 云原生框架。Tekton 的前身是 Knative 项目的 build-pipeline 项目，这个项目是为了给 build 模块增加 pipeline 的功能，但是随着不同的功能加入到 Knative build 模块中，build 模块越来越变得像一个通用的 CI/CD 系统，于是，索性将 build-pipeline 剥离出 Knative，就变成了现在的 Tekton，而 Tekton 也从此致力于提供全功能、标准化的云原生 CI/CD 解决方案。</p><p>即：<strong>Tekton 是云原生的 CI/CD 框架，是云原生的的 CI/CD 解决方案</strong>。</p><h3 id=优点>优点</h3><p>Tekton 为 CI/CD 系统提供了诸多好处：</p><ul><li><strong>可定制</strong>：Tekton 是完全可定制的，具有高度的灵活性，我们可以定义非常详细的构建块目录，供开发人员在各种场景中使用。<ul><li>比较基础的功能，应该是所有 CI/CD 系统都有这个功能</li></ul></li><li><strong>可重复使用</strong>：Tekton 是完全可移植的，任何人都可以使用给定的流水线并重用其构建块，可以使得开发人员无需"造轮子"就可以快速构建复杂的流水线。<ul><li>所有工作都运行在 pod 中，对外部系统无依赖，无缝迁移</li></ul></li><li><strong>可扩展</strong>：<code>Tekton Catalog</code>是社区驱动的 Tekton 构建块存储库，我们可以使用 <code>Tekton Catalog</code>中定义的组件快速创建新的流水线并扩展现有管道。<ul><li>dockerhub 之于 docker，用于存放 Tekton 自己的模块</li></ul></li><li><strong>标准化</strong>：Tekton 在你的 Kubernetes 集群上作为扩展安装和运行，并使用完善的 Kubernetes 资源模型，Tekton 工作负载在 Kubernetes Pod 内执行。<ul><li>云原生体现之一，完全兼容 k8s 标准，对环境没有要求，只要是标准 k8s 集群就能运行</li></ul></li><li><strong>伸缩性</strong>：要增加工作负载容量，只需添加新的节点到 k8s 集群即可，Tekton 可随集群扩展，无需重新定义资源分配或对管道进行任何其他修改。<ul><li>云原生体现之一，完全利用 k8s 的能力</li></ul></li></ul><blockquote><p>感觉<strong>云原生的 CI/CD 框架</strong>指的应该是 tekton 完全兼容 k8s 资源模型，可以在任意标准 k8s 集群中部署，同时能够充分利用 k8s 的各项能力，比如伸缩性，只要 k8s 集群添加节点即可，tekton 不需要做任何工作。</p><p>即：Tekton 能够很好的和 k8s 配合。</p></blockquote><h3 id=组件>组件</h3><p>Tekton 由一些列组件组成：</p><ul><li><code>Tekton Pipelines</code>：是 Tekton 的基础，它定义了一组 Kubernetes CRD 作为构建块，我们可以使用这些对象来组装 CI/CD 流水线。</li><li><code>Tekton Triggers</code>：允许我们根据事件来实例化流水线，例如，可以我们在每次将 PR 合并到 GitHub 仓库的时候触发流水线实例和构建工作。</li><li><code>Tekton CLI</code>：提供了一个名为 <code>tkn</code>的命令行界面，它构建在 Kubernetes CLI 之上，运行和 Tekton 进行交互。</li><li><code>Tekton Dashboard</code>：是 <code>Tekton Pipelines</code>的基于 Web 的一个图形界面，可以线上有关流水线执行的相关信息。</li><li><code>Tekton Catalog</code>：是一个由社区贡献的高质量 Tekton 构建块（任务、流水线等）存储库，可以直接在我们自己的流水线中使用这些构建块。</li><li><code>Tekton Hub</code>：是一个用于访问 <code>Tekton Catalog</code>的 Web 图形界面工具。</li><li><code>Tekton Operator</code>：是一个 Kubernetes Operator，可以让我们在 Kubernetes 集群上安装、更新、删除 Tekton 项目。</li></ul><p>因此我们只要部署 <strong>Tekton Pipelines</strong> 以及 <strong>Tekton Triggers</strong> 就能拥有完成的 CI/CD 流程，为了便于查看可以在部署一个 <strong>Tekton Dashboard</strong>。</p><h2 id=2-部署>2. 部署</h2><p>本文主要记录 tektoncd 的部署过程。整个部署实际很简单，不过 tektoncd 所有镜像默认存放在 gcr.io 的，导致国内使用比较困难，镜像问题算是部署中最大的一个难点。</p><p>因此在写这篇文章时将当前用到的所有镜像都推送到了 <a href="https://hub.docker.com/u/barrypt96?page=1" target=_blank rel="noopener noreffer">dockerhub/barrypt96</a> 这个用户下，大家可以直接使用，同时文章里提供了脚本用于将官方 yaml 中的镜像替换为 <a href="https://hub.docker.com/u/barrypt96?page=1" target=_blank rel="noopener noreffer">dockerhub/barrypt96</a> 下的镜像，从而解决使用官方 yaml 部署导致的无法从 gcr.io 拉取镜像的问题。</p><blockquote><p>根据这篇文章操作，不出意外的话应该几分钟就能完成部署，整个过程非常丝滑~</p></blockquote><p>本文部署的各个组件版本分别是</p><ul><li>Pipeline v0.43.2</li><li>Trigger v0.22.1</li><li>Dashboard v0.31.0</li></ul><p>由于国内的特殊环境，整个部署过程分为以下几部分：</p><ul><li>1）下载对应版本的 yaml 文件</li><li>2）替换 yaml 文件中的镜像</li><li>3）从 dockerhub 拉取镜像<ul><li>这一步可以忽略，只是习惯在部署前先准备好镜像</li></ul></li><li>4）Apply 到 k8s 集群</li></ul><h3 id=环境准备>环境准备</h3><p>首先我们需要一个 k8s 集群，单节点即可。</p><p>如果没有 k8s 环境的话可以参数这篇文章：<a href=https://www.lixueduan.com/posts/kubernetes/11-install-by-kubeclipper/ target=_blank rel="noopener noreffer">Kubernetes教程(十一)&mdash;使用 KubeClipper 通过一条命令快速创建 k8s 集群</a>，快速搭建一个。</p><p>使用 kubeclipper 工具，大概两三分钟就能创建出一个 k8s 集群，本文的演示环境也是通过该工具推出来的，非常好用~</p><h3 id=部署-pipeline>部署 Pipeline</h3><p>下载 0.43.2 版本的 yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>curl https://storage.googleapis.com/tekton-releases/pipeline/previous/v0.43.2/release.yaml -o pipeline.yaml
</span></span></code></pre></div><p>使用 sed 命令挨个替换镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/controller:v0.43.2@sha256:e1a541216f70bfc519739e056111d0f69e7959913e28ccbf98ce9fe2fd0dd406/barrypt96\/tektoncd-pipeline-cmd-controller:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/resolvers:v0.43.2@sha256:5ea2565c256a5085ee422d4778166fd1fe0f985ff6e3816542728379433f30db/barrypt96\/tektoncd-pipeline-cmd-resolvers:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/webhook:v0.43.2@sha256:e2bc5e55370049efa5ed3e16868ecec65fb9cdb6df0fd7e08568a8b6f3193186/barrypt96\/tektoncd-pipeline-cmd-webhook:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/kubeconfigwriter:v0.43.2@sha256:449fae542ca42a94171c7e6fe41af4451c62126743f77b47f09bbcecc932145e/barrypt96\/tektoncd-pipeline-cmd-kubeconfigwriter:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/git-init:v0.43.2@sha256:cd5fb697a91af1883917e5e8ab230566bff60fd1310fb2d0e12badcee7db5db6/barrypt96\/tektoncd-pipeline-cmd-git-init:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/entrypoint:v0.43.2@sha256:50333090b874cdff1706d9f4de9d367270586d91a3204f223ad3c9c8f8b5968b/barrypt96\/tektoncd-pipeline-cmd-entrypoint:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/nop:v0.43.2@sha256:6c99e85668d5c5d383ee341fb22affb71ea2908f5615a3ec0157980ac1891ef4/barrypt96\/tektoncd-pipeline-cmd-nop:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/sidecarlogresults:v0.43.2@sha256:8c7e3dbb3cbfa76e9d291d869d50c93b4b9001dab6e3143d5db7b4e297144814/barrypt96\/tektoncd-pipeline-cmd-sidecarlogresults:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/imagedigestexporter:v0.43.2@sha256:768185690a3c5b5a79c764fe3d66bac8351136a14dd82d9fd7da019789b4ed95/barrypt96\/tektoncd-pipeline-cmd-imagedigestexporter:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/pullrequest-init:v0.43.2@sha256:8f5809192c455ea3a657203337e139482b06ffdef1a32d3ad494d6bcdb7c1465/barrypt96\/tektoncd-pipeline-cmd-pullrequest-init:v0.43.2/&#39;</span> pipeline.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/pipeline\/cmd\/workingdirinit:v0.43.2@sha256:707cf41528b19e7b20925fcfe17b1ebf8e61a22fe824df6b79c17b36f81a2d19/barrypt96\/tektoncd-pipeline-cmd-workingdirinit:v0.43.2/&#39;</span> pipeline.yaml
</span></span></code></pre></div><p>从 dockerhub 拉取镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=nv>tag</span><span class=o>=</span>v0.43.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>images</span><span class=o>=</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>controller
</span></span></span><span class=line><span class=cl><span class=s2>entrypoint
</span></span></span><span class=line><span class=cl><span class=s2>git-init
</span></span></span><span class=line><span class=cl><span class=s2>imagedigestexporter
</span></span></span><span class=line><span class=cl><span class=s2>kubeconfigwriter
</span></span></span><span class=line><span class=cl><span class=s2>nop
</span></span></span><span class=line><span class=cl><span class=s2>pullrequest-init
</span></span></span><span class=line><span class=cl><span class=s2>resolvers
</span></span></span><span class=line><span class=cl><span class=s2>sidecarlogresults
</span></span></span><span class=line><span class=cl><span class=s2>webhook
</span></span></span><span class=line><span class=cl><span class=s2>workingdirinit
</span></span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> image in <span class=nv>$images</span><span class=p>;</span><span class=k>do</span> ctr --namespace k8s.io image pull docker.io/barrypt96/tektoncd-pipeline-cmd-<span class=nv>$image</span>:<span class=nv>$tag</span><span class=p>;</span><span class=k>done</span>
</span></span></code></pre></div><p>apply 到 k8s</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>kubectl apply -f pipeline.yaml
</span></span></code></pre></div><p>会启动 3 个 pod</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@caas-console ~<span class=o>]</span><span class=c1># kubectl get po -A|grep tekton</span>
</span></span><span class=line><span class=cl>tekton-pipelines-resolvers   tekton-pipelines-remote-resolvers-774848479b-x6759   1/1     Running   <span class=m>0</span>          44s
</span></span><span class=line><span class=cl>tekton-pipelines             tekton-pipelines-controller-68fb8c9df6-r755w         1/1     Running   <span class=m>0</span>          44s
</span></span><span class=line><span class=cl>tekton-pipelines             tekton-pipelines-webhook-b54b6d464-ppb7f             1/1     Running   <span class=m>0</span>          44s
</span></span></code></pre></div><h3 id=部署-trigger>部署 Trigger</h3><p>先下载 v0.22.1 版本对应的两个 yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>curl https://storage.googleapis.com/tekton-releases/triggers/previous/v0.22.1/release.yaml -o trigger-release.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl https://storage.googleapis.com/tekton-releases/triggers/previous/v0.22.1/interceptors.yaml -o trigger-interceptors.yaml
</span></span></code></pre></div><p>然后使用 sed 替换镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/triggers\/cmd\/controller:v0.22.1@sha256:47f18d03c08ebc8ef474dd62e7d83ead3c4aa802c72668dafb73fd6afedd305f/barrypt96\/tektoncd-triggers-cmd-controller:v0.22.1/&#39;</span> trigger-release.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/triggers\/cmd\/webhook:v0.22.1@sha256:9a124b2ead10a6bc3ae1d32d05b9fe664465cfe6d09830ef89f3987a443a5c86/barrypt96\/tektoncd-triggers-cmd-webhook:v0.22.1/&#39;</span> trigger-release.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/triggers\/cmd\/eventlistenersink:v0.22.1@sha256:bd8b2ec63012605739dc74871d1a20634d1055ed3d77864a582a9b5f2d22ab92/barrypt96\/tektoncd-triggers-cmd-eventlistenersink:v0.22.1/&#39;</span> trigger-release.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/triggers\/cmd\/controller:v0.22.1@sha256:47f18d03c08ebc8ef474dd62e7d83ead3c4aa802c72668dafb73fd6afedd305f/barrypt96\/tektoncd-triggers-cmd-controller:v0.22.1/&#39;</span> trigger-interceptors.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/triggers\/cmd\/eventlistenersink:v0.22.1@sha256:bd8b2ec63012605739dc74871d1a20634d1055ed3d77864a582a9b5f2d22ab92/barrypt96\/tektoncd-triggers-cmd-eventlistenersink:v0.22.1/&#39;</span> trigger-interceptors.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/triggers\/cmd\/webhook:v0.22.1@sha256:9a124b2ead10a6bc3ae1d32d05b9fe664465cfe6d09830ef89f3987a443a5c86/barrypt96\/tektoncd-triggers-cmd-webhook:v0.22.1/&#39;</span> trigger-interceptors.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/triggers\/cmd\/interceptors:v0.22.1@sha256:eda7af449fb82b06e952da0f5c0d1c2a3eddbab041e43065d37f67523c60c494/barrypt96\/tektoncd-triggers-cmd-interceptors:v0.22.1/&#39;</span> trigger-interceptors.yaml
</span></span></code></pre></div><p>接着拉取镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=nv>tag</span><span class=o>=</span>v0.22.1
</span></span><span class=line><span class=cl><span class=nv>dockerUserName</span><span class=o>=</span>barrypt96
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>images</span><span class=o>=</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>controller
</span></span></span><span class=line><span class=cl><span class=s2>eventlistenersink
</span></span></span><span class=line><span class=cl><span class=s2>interceptors
</span></span></span><span class=line><span class=cl><span class=s2>webhook
</span></span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> image in <span class=nv>$images</span><span class=p>;</span><span class=k>do</span> ctr --namespace k8s.io image pull docker.io/<span class=nv>$dockerUserName</span>/tektoncd-triggers-cmd-<span class=nv>$image</span>:<span class=nv>$tag</span><span class=p>;</span><span class=k>done</span>
</span></span></code></pre></div><p>最后 apply 到 k8s</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>kubectl apply -f trigger-release.yaml
</span></span><span class=line><span class=cl>kubectl apply -f trigger-interceptors.yaml
</span></span></code></pre></div><p>Trigger 也会启动 3 个 pod</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@caas-console ~<span class=o>]</span><span class=c1># kubectl get po -A|grep tekton-triggers</span>
</span></span><span class=line><span class=cl>tekton-pipelines             tekton-triggers-controller-5969f786d6-pbrkl          1/1     Running   <span class=m>0</span>          2m16s
</span></span><span class=line><span class=cl>tekton-pipelines             tekton-triggers-core-interceptors-77d6499b44-svbsb   1/1     Running   <span class=m>0</span>          2m13s
</span></span><span class=line><span class=cl>tekton-pipelines             tekton-triggers-webhook-67559d98cf-2nz98             1/1     Running   <span class=m>0</span>          2m16s
</span></span></code></pre></div><h3 id=部署-dashboard>部署 Dashboard</h3><p>为了对用户更友好，Tekton 也有一个<a href=https://tekton.dev/docs/dashboard/ target=_blank rel="noopener noreffer">Dashboard</a>，可以使用如下命令进行安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>curl https://storage.googleapis.com/tekton-releases/dashboard/previous/v0.31.0/tekton-dashboard-release.yaml -o tekton-dashboard-release.yaml
</span></span></code></pre></div><p>同样的，替换镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sed -i <span class=s1>&#39;s/gcr.io\/tekton-releases\/github.com\/tektoncd\/dashboard\/cmd\/dashboard:v0.31.0@sha256:454a405aa4f874a0c22db7ab47ccb225a95addd3de904084e35c5de78e4f2c48/barrypt96\/tektoncd-dashboard-cmd-dashboard:v0.31.0/&#39;</span> tekton-dashboard-release.yaml
</span></span></code></pre></div><p>然后拉取镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=nv>tag</span><span class=o>=</span>v0.31.0
</span></span><span class=line><span class=cl><span class=nv>dockerUserName</span><span class=o>=</span>barrypt96
</span></span><span class=line><span class=cl><span class=nv>images</span><span class=o>=</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>dashboard
</span></span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> image in <span class=nv>$images</span><span class=p>;</span><span class=k>do</span> ctr --namespace k8s.io image pull docker.io/<span class=nv>$dockerUserName</span>/tektoncd-dashboard-cmd-<span class=nv>$image</span>:<span class=nv>$tag</span><span class=p>;</span><span class=k>done</span>
</span></span></code></pre></div><p>最后 apply 到 k8s</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>kubectl apply -f tekton-dashboard-release.yaml
</span></span></code></pre></div><p>Dashboard 只会启动一个 pod</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@caas-console ~<span class=o>]</span><span class=c1># kubectl get po -A|grep tekton-dashboard</span>
</span></span><span class=line><span class=cl>tekton-pipelines             tekton-dashboard-6ddf4d8556-k8cfz                    1/1     Running   <span class=m>0</span>          23s
</span></span></code></pre></div><p>外部访问则需要把对应 service 改成 nodePort 类型</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>kubectl -n tekton-pipelines patch svc tekton-dashboard -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;type&#34;:&#34;NodePort&#34;}}&#39;</span>
</span></span><span class=line><span class=cl>kubectl -n tekton-pipelines get svc tekton-dashboard
</span></span></code></pre></div><p>打开浏览器，访问对应节点 IP+NodePort 即可进入 tekton 的 dashboard。</p><p>打开后界面大概是这样子的：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../../../img/tekton/deploy/tekton-dashboard.png data-srcset="../../../img/tekton/deploy/tekton-dashboard.png, ../../../img/tekton/deploy/tekton-dashboard.png 1.5x, ../../../img/tekton/deploy/tekton-dashboard.png 2x" data-sizes=auto alt=../../../img/tekton/deploy/tekton-dashboard.png title=tekton-dashboard.png></p><p>通过界面可以更加直观的看到 tekton 相关的各个资源对象。</p><h2 id=3-demo>3. Demo</h2><p>简单启动一个 task 测试一下 tekton 能否正常运行。</p><p>执行以下命令创建一个 task 对象：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: tekton.dev/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: Task
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: demo
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  steps:
</span></span></span><span class=line><span class=cl><span class=s>    - name: echo
</span></span></span><span class=line><span class=cl><span class=s>      image: alpine
</span></span></span><span class=line><span class=cl><span class=s>      script: |
</span></span></span><span class=line><span class=cl><span class=s>        #!/bin/sh
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;Hello Tekton&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>内容也很简单，就是打印出 “Hello Tekton” 这句话。</p><p>查看一下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@caas-console ~<span class=o>]</span><span class=c1># kubectl get task</span>
</span></span><span class=line><span class=cl>NAME      AGE
</span></span><span class=line><span class=cl>demo      4s
</span></span></code></pre></div><p>执行一下命令创建一个 taskrun，以触发 之前的 task：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF | kubectl create -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: tekton.dev/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: TaskRun
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  generateName: demo-task-run-
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  taskRef:
</span></span></span><span class=line><span class=cl><span class=s>    name: demo
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>查看一下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@caas-console ~<span class=o>]</span><span class=c1># kubectl get taskrun</span>
</span></span><span class=line><span class=cl>NAME                                                             SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME
</span></span><span class=line><span class=cl>demo-task-run-82kdw                                              True        Succeeded   23s         14s
</span></span></code></pre></div><p>因为这个 task 很简单，所以都已经跑完了。</p><p>最后在查看以下具体的 pod 日志，看看是否真的打印出了这句话</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@caas-console ~<span class=o>]</span><span class=c1># kubectl get pod</span>
</span></span><span class=line><span class=cl>NAME                                                              READY   STATUS             RESTARTS      AGE
</span></span><span class=line><span class=cl>demo-task-run-82kdw-pod                                           0/1     Completed          <span class=m>0</span>             2m38s
</span></span><span class=line><span class=cl><span class=o>[</span>root@caas-console ~<span class=o>]</span><span class=c1># kubectl logs demo-task-run-82kdw-pod</span>
</span></span><span class=line><span class=cl>Hello Tekton
</span></span></code></pre></div><p>可以看到，确实打印出了”Hello Tekton“ 这句话，至此说明我们部署的 tenton 是能够正常运行的。</p><p>到这里 tektoncd 的部署就完成了，如果理解不了这个 demo 中做的事情也没关系，后续会有 Tekton 的使用教程~</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-01-01</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.yudlk.com/posts/tekton/01-deploy-tekton/ data-title="Tekton教程(一)---云原生 CICD: Tekton 初体验" data-hashtags=tekton><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.yudlk.com/posts/tekton/01-deploy-tekton/ data-hashtag=tekton><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.yudlk.com/posts/tekton/01-deploy-tekton/ data-title="Tekton教程(一)---云原生 CICD: Tekton 初体验"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.yudlk.com/posts/tekton/01-deploy-tekton/ data-title="Tekton教程(一)---云原生 CICD: Tekton 初体验"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.yudlk.com/posts/tekton/01-deploy-tekton/ data-title="Tekton教程(一)---云原生 CICD: Tekton 初体验"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/tekton/>tekton</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/kubernetes/15-kind-kubernetes-in-docker/ class=prev rel=prev title="Kubernetes教程(十五)---使用 kind 在本地快速部署一个 k8s集群"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Kubernetes教程(十五)---使用 kind 在本地快速部署一个 k8s集群</a>
<a href=/posts/tekton/02-tekton-task-pipeline/ class=next rel=next title="Tekton教程(二)---构建流水线：Task & Pipeline 基本使用">Tekton教程(二)---构建流水线：Task & Pipeline 基本使用<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/barrypt target=_blank>qpt</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.480e58b2c2a8605d406f34667e92ff8f1ae50cfee5b653bead570f004839a983.js integrity="sha256-SA5YssKoYF1AbzRmfpL/jxrlDP7ltlO+rVcPAEg5qYM="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-FL23FNP7CM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-FL23FNP7CM" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b7c98449a6edf8492a8f3404e6d06a0",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7693630257897132" crossorigin=anonymous></script></body></html>