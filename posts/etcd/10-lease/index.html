<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>etcd教程(十)---lease 机制源码分析 -</title><meta name=Description content="通过源码分析 etcd lease 的原理与具体实现"><meta property="og:title" content="etcd教程(十)---lease 机制源码分析"><meta property="og:description" content="通过源码分析 etcd lease 的原理与具体实现"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.yudlk.com/posts/etcd/10-lease/"><meta property="og:image" content="https://blog.yudlk.com/img/jinx.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-17T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-17T00:00:00+00:00"><meta property="og:site_name" content="qpt的个人博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.yudlk.com/img/jinx.png"><meta name=twitter:title content="etcd教程(十)---lease 机制源码分析"><meta name=twitter:description content="通过源码分析 etcd lease 的原理与具体实现"><meta name=application-name content="面对疾风"><meta name=apple-mobile-web-app-title content="面对疾风"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.yudlk.com/posts/etcd/10-lease/><link rel=prev href=https://blog.yudlk.com/posts/etcd/09-raft/><link rel=next href=https://blog.yudlk.com/posts/etcd/11-txn/><link rel=stylesheet href=/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"etcd教程(十)---lease 机制源码分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.yudlk.com\/posts\/etcd\/10-lease\/"},"image":["https:\/\/blog.yudlk.com\/img\/jinx.png"],"genre":"posts","keywords":"etcd","wordcount":5341,"url":"https:\/\/blog.yudlk.com\/posts\/etcd\/10-lease\/","datePublished":"2021-12-17T00:00:00+00:00","dateModified":"2021-12-17T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"qpt"},"description":"通过源码分析 etcd lease 的原理与具体实现"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title>面对疾风</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=面对疾风>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/ title=关于>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title>面对疾风</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title=面对疾风>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">etcd教程(十)---lease 机制源码分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/barrypt title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>qpt</a></span>&nbsp;<span class=post-category>included in <a href=/categories/etcd/><i class="far fa-folder fa-fw" aria-hidden=true></i>etcd</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-12-17>2021-12-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;5341 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;11 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-概述>1. 概述</a></li><li><a href=#2-key-如何关联-lease>2. key 如何关联 Lease</a><ul><li><a href=#21-创建-lease>2.1 创建 Lease</a></li><li><a href=#22-将-key-与-lease-关联>2.2 将 key 与 lease 关联</a></li></ul></li><li><a href=#3-lease-续期>3. Lease 续期</a></li><li><a href=#4-如何高效淘汰过期-lease>4. 如何高效淘汰过期 Lease</a></li><li><a href=#5--checkpoint-机制>5. checkpoint 机制</a></li><li><a href=#6-小结>6. 小结</a></li><li><a href=#7-参考>7. 参考</a></li></ul></nav></div></div><div class=content id=content><p>本文主要记录了 etcd 中 Lease 的大致原理，包括 v2版本到v3版本的优化点，最后通过分析源码了解了具体实现。</p><h2 id=1-概述>1. 概述</h2><blockquote><p>以下源码基于 etcd v3.5.1.</p></blockquote><p>Lease 顾名思义，client 和 etcd server 之间存在一个约定，内容是 etcd server 保证在约定的有效期内（TTL），不会删除你关联到此 Lease 上的 key-value。</p><p>若你未在有效期内续租，那么 etcd server 就会删除 Lease 和其关联的 key-value。</p><blockquote><p>可以简单理解为 key 的有效期。</p></blockquote><p>Lease，是基于<code>主动型上报模式</code>提供的一种<strong>活性检测机制</strong>。</p><p><strong>Lease 整体架构</strong>如下图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-arch.png data-srcset="https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-arch.png, https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-arch.png 1.5x, https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-arch.png 2x" data-sizes=auto alt=https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-arch.png title=lease-arch></p><p>etcd 在启动时会创建 Lessor 模块，而 Lessor 模块启动的时候，它会启动一个常驻 goroutine 以执行以下两个任务，如上图所示：</p><ul><li>一个是<strong>RevokeExpiredLease</strong> 任务，定时检查是否有过期 Lease，发起撤销过期的 Lease 操作。</li><li>一个是<strong>CheckpointScheduledLease</strong>，定时触发更新 Lease 的剩余到期时间的操作。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/etcdserver/server.go 299 行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewServer</span><span class=p>(</span><span class=nx>cfg</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ServerConfig</span><span class=p>)</span> <span class=p>(</span><span class=nx>srv</span> <span class=o>*</span><span class=nx>EtcdServer</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// etcd server 启动时会启动 Lessor 模块
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=nx>srv</span><span class=p>.</span><span class=nx>lessor</span> <span class=p>=</span> <span class=nx>lease</span><span class=p>.</span><span class=nf>NewLessor</span><span class=p>(</span><span class=nx>srv</span><span class=p>.</span><span class=nf>Logger</span><span class=p>(),</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>be</span><span class=p>,</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>cluster</span><span class=p>,</span> <span class=nx>lease</span><span class=p>.</span><span class=nx>LessorConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>MinLeaseTTL</span><span class=p>:</span>                <span class=nb>int64</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nx>minTTL</span><span class=p>.</span><span class=nf>Seconds</span><span class=p>())),</span>
</span></span><span class=line><span class=cl>		<span class=nx>CheckpointInterval</span><span class=p>:</span>         <span class=nx>cfg</span><span class=p>.</span><span class=nx>LeaseCheckpointInterval</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>CheckpointPersist</span><span class=p>:</span>          <span class=nx>cfg</span><span class=p>.</span><span class=nx>LeaseCheckpointPersist</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ExpiredLeasesRetryInterval</span><span class=p>:</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>Cfg</span><span class=p>.</span><span class=nf>ReqTimeout</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 同时还指定了 Checkpointer 方法，如果有开启 LeaseCheckpoint 设置的话
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>Cfg</span><span class=p>.</span><span class=nx>EnableLeaseCheckpoint</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// setting checkpointer enables lease checkpoint feature.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>srv</span><span class=p>.</span><span class=nx>lessor</span><span class=p>.</span><span class=nf>SetCheckpointer</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cp</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpointRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>srv</span><span class=p>.</span><span class=nf>raftRequestOnce</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>InternalRaftRequest</span><span class=p>{</span><span class=nx>LeaseCheckpoint</span><span class=p>:</span> <span class=nx>cp</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// server/lease/lessor.go 204 行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewLessor</span><span class=p>(</span><span class=nx>lg</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span><span class=p>,</span> <span class=nx>b</span> <span class=nx>backend</span><span class=p>.</span><span class=nx>Backend</span><span class=p>,</span> <span class=nx>cluster</span> <span class=nx>cluster</span><span class=p>,</span> <span class=nx>cfg</span> <span class=nx>LessorConfig</span><span class=p>)</span> <span class=nx>Lessor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>newLessor</span><span class=p>(</span><span class=nx>lg</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>cluster</span><span class=p>,</span> <span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newLessor</span><span class=p>(</span><span class=nx>lg</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span><span class=p>,</span> <span class=nx>b</span> <span class=nx>backend</span><span class=p>.</span><span class=nx>Backend</span><span class=p>,</span> <span class=nx>cluster</span> <span class=nx>cluster</span><span class=p>,</span> <span class=nx>cfg</span> <span class=nx>LessorConfig</span><span class=p>)</span> <span class=o>*</span><span class=nx>lessor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>checkpointInterval</span> <span class=o>:=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>CheckpointInterval</span>
</span></span><span class=line><span class=cl>	<span class=nx>expiredLeaseRetryInterval</span> <span class=o>:=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>ExpiredLeasesRetryInterval</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>checkpointInterval</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>checkpointInterval</span> <span class=p>=</span> <span class=nx>defaultLeaseCheckpointInterval</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>expiredLeaseRetryInterval</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>expiredLeaseRetryInterval</span> <span class=p>=</span> <span class=nx>defaultExpiredleaseRetryInterval</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>lessor</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>leaseMap</span><span class=p>:</span>                  <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>LeaseID</span><span class=p>]</span><span class=o>*</span><span class=nx>Lease</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>itemMap</span><span class=p>:</span>                   <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>LeaseItem</span><span class=p>]</span><span class=nx>LeaseID</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>leaseExpiredNotifier</span><span class=p>:</span>      <span class=nf>newLeaseExpiredNotifier</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>leaseCheckpointHeap</span><span class=p>:</span>       <span class=nb>make</span><span class=p>(</span><span class=nx>LeaseQueue</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>:</span>                         <span class=nx>b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>minLeaseTTL</span><span class=p>:</span>               <span class=nx>cfg</span><span class=p>.</span><span class=nx>MinLeaseTTL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>checkpointInterval</span><span class=p>:</span>        <span class=nx>checkpointInterval</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>expiredLeaseRetryInterval</span><span class=p>:</span> <span class=nx>expiredLeaseRetryInterval</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>checkpointPersist</span><span class=p>:</span>         <span class=nx>cfg</span><span class=p>.</span><span class=nx>CheckpointPersist</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=c1>// expiredC is a small buffered chan to avoid unnecessary blocking.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>expiredC</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=p>[]</span><span class=o>*</span><span class=nx>Lease</span><span class=p>,</span> <span class=mi>16</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>stopC</span><span class=p>:</span>    <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>doneC</span><span class=p>:</span>    <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>lg</span><span class=p>:</span>       <span class=nx>lg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>cluster</span><span class=p>:</span>  <span class=nx>cluster</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从 blotdb 中加载lease数据并在内存中重建
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>l</span><span class=p>.</span><span class=nf>initAndRecover</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 这就是图中的两个常驻任务
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>l</span><span class=p>.</span><span class=nf>runLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>l</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// // server/lease/lessor.go 611 行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>runLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nb>close</span><span class=p>(</span><span class=nx>le</span><span class=p>.</span><span class=nx>doneC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>le</span><span class=p>.</span><span class=nf>revokeExpiredLeases</span><span class=p>()</span> <span class=c1>// 移除已经过期的 lease
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>le</span><span class=p>.</span><span class=nf>checkpointScheduledLeases</span><span class=p>()</span> <span class=c1>// 更新lease的剩余到期时间，并将数据给follower节点
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=mi>500</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>le</span><span class=p>.</span><span class=nx>stopC</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Lessor 模块提供了 Grant、Revoke、LeaseTimeToLive、LeaseKeepAlive API 给 client 使用，各接口作用如下:</p><ul><li><strong>Grant</strong>：表示创建一个 TTL 为你指定秒数的 Lease，Lessor 会将 Lease 信息持久化存储在 boltdb 中；</li><li><strong>Revoke</strong>：表示撤销 Lease 并删除其关联的数据；</li><li><strong>LeaseTimeToLive</strong>：表示获取一个 Lease 的有效期、剩余时间；</li><li><strong>LeaseKeepAlive</strong>：表示为 Lease 续期。</li></ul><h2 id=2-key-如何关联-lease>2. key 如何关联 Lease</h2><p>大致分为两步：</p><ul><li>1）创建 Lease</li><li>2）将 key 与 lease 关联</li></ul><p>具体流程如下：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-process.png data-srcset="https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-process.png, https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-process.png 1.5x, https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-process.png 2x" data-sizes=auto alt=https://github.com/barrypt/blog/raw/master/images/etcd/lease/lease-process.png title=lease-process></p><h3 id=21-创建-lease>2.1 创建 Lease</h3><p>client 可通过 clientv3 库的 Lease API 发起 RPC 调用来创建 Lease，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 创建一个TTL为600秒的lease，etcd server返回LeaseID</span>
</span></span><span class=line><span class=cl>$ etcdctl lease grant <span class=m>600</span>
</span></span><span class=line><span class=cl>lease 326975935f48f814 granted with TTL<span class=o>(</span>600s<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看lease的TTL、剩余时间</span>
</span></span><span class=line><span class=cl>$ etcdctl lease timetolive 326975935f48f814
</span></span><span class=line><span class=cl>lease 326975935f48f814 granted with TTL<span class=o>(</span>600s<span class=o>)</span>， remaining<span class=o>(</span>590s<span class=o>)</span>
</span></span></code></pre></div><p>当 Lease server 收到 client 的创建一个有效期 600 秒的 Lease 请求后，会通过 Raft 模块完成日志同步，随后 Apply 模块通过 Lessor 模块的 Grant 接口执行日志条目内容。</p><p>首先 Lessor 的 Grant 接口会把 Lease 保存到内存的 ItemMap 数据结构中，然后它需要持久化 Lease，将 Lease 数据保存到 boltdb 的 Lease bucket 中，返回一个唯一的 LeaseID 给 client。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/lease/lessor.go 272行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>Grant</span><span class=p>(</span><span class=nx>id</span> <span class=nx>LeaseID</span><span class=p>,</span> <span class=nx>ttl</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Lease</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Lease</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ID</span><span class=p>:</span>      <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ttl</span><span class=p>:</span>     <span class=nx>ttl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>itemSet</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>LeaseItem</span><span class=p>]</span><span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>revokec</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>leaseMap</span><span class=p>[</span><span class=nx>id</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>ErrLeaseExists</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>l</span><span class=p>.</span><span class=nx>ttl</span> <span class=p>&lt;</span> <span class=nx>le</span><span class=p>.</span><span class=nx>minLeaseTTL</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nx>ttl</span> <span class=p>=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>minLeaseTTL</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>le</span><span class=p>.</span><span class=nf>isPrimary</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nf>refresh</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nf>forever</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将新建的 lease 存入 lessor 模块中，一个 map 结构
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>le</span><span class=p>.</span><span class=nx>leaseMap</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=nx>l</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将 lease 持久化到 blotdb中。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>l</span><span class=p>.</span><span class=nf>persistTo</span><span class=p>(</span><span class=nx>le</span><span class=p>.</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>leaseTotalTTLs</span><span class=p>.</span><span class=nf>Observe</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>ttl</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>leaseGranted</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>le</span><span class=p>.</span><span class=nf>isPrimary</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>item</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>LeaseWithTime</span><span class=p>{</span><span class=nx>id</span><span class=p>:</span> <span class=nx>l</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>time</span><span class=p>:</span> <span class=nx>l</span><span class=p>.</span><span class=nx>expiry</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>le</span><span class=p>.</span><span class=nx>leaseExpiredNotifier</span><span class=p>.</span><span class=nf>RegisterOrUpdate</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>le</span><span class=p>.</span><span class=nf>scheduleCheckpointIfNeeded</span><span class=p>(</span><span class=nx>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>l</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=22-将-key-与-lease-关联>2.2 将 key 与 lease 关联</h3><p>KV 模块的 API 接口提供了一个"&ndash;lease"参数，你可以通过写入 key 时带上该参数，将 key node 关联到对应的 LeaseID 上。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ etcdctl put node healthy --lease 326975935f48f818
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>$ etcdctl get node -w<span class=o>=</span>json <span class=p>|</span> python -m json.tool
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;kvs&#34;</span>:<span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;create_revision&#34;</span>:24，
</span></span><span class=line><span class=cl>            <span class=s2>&#34;key&#34;</span>:<span class=s2>&#34;bm9kZQ==&#34;</span>，
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Lease&#34;</span>:3632563850270275608，
</span></span><span class=line><span class=cl>            <span class=s2>&#34;mod_revision&#34;</span>:24，
</span></span><span class=line><span class=cl>            <span class=s2>&#34;value&#34;</span>:<span class=s2>&#34;aGVhbHRoeQ==&#34;</span>，
</span></span><span class=line><span class=cl>            <span class=s2>&#34;version&#34;</span>:1
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>当你通过 put 等命令新增一个指定了"&ndash;lease"的 key 时，MVCC 模块它会通过 Lessor 模块的 Attach 方法，将 key 关联到 Lease 的 key 内存集合 ItemSet 中，为了保证持久化，在写入 blotdb 时会将 key 关联的 lease 信息一并写入。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/lease/lessor.go 546行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>Attach</span><span class=p>(</span><span class=nx>id</span> <span class=nx>LeaseID</span><span class=p>,</span> <span class=nx>items</span> <span class=p>[]</span><span class=nx>LeaseItem</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>leaseMap</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>l</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ErrLeaseNotFound</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>l</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>it</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>items</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nx>itemSet</span><span class=p>[</span><span class=nx>it</span><span class=p>]</span> <span class=p>=</span> <span class=kd>struct</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl>		<span class=nx>le</span><span class=p>.</span><span class=nx>itemMap</span><span class=p>[</span><span class=nx>it</span><span class=p>]</span> <span class=p>=</span> <span class=nx>id</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 有 Attach 自然就会有 Detach
</span></span></span><span class=line><span class=cl><span class=c1>// server/lease/lessor.go 573行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>Detach</span><span class=p>(</span><span class=nx>id</span> <span class=nx>LeaseID</span><span class=p>,</span> <span class=nx>items</span> <span class=p>[]</span><span class=nx>LeaseItem</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>leaseMap</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>l</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ErrLeaseNotFound</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>l</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>it</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>items</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>delete</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>itemSet</span><span class=p>,</span> <span class=nx>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>delete</span><span class=p>(</span><span class=nx>le</span><span class=p>.</span><span class=nx>itemMap</span><span class=p>,</span> <span class=nx>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>其中 LeaseItem 其实就是我们提供的 key ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>LeaseItem</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Key</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=3-lease-续期>3. Lease 续期</h2><p>在正常情况下，你的节点存活时，需要定期发送 KeepAlive 请求给 etcd 续期健康状态的 Lease，否则你的 Lease 和关联的数据就会被删除。</p><p><strong>那么如何高效的实现这个需求呢？</strong></p><p>续期性能受多方面影响：</p><ul><li>首先是 TTL，TTL 过长会导致节点异常后，无法及时从 etcd 中删除，影响服务可用性，而过短，则要求 client 频繁发送续期请求。</li><li>其次是 Lease 数，如果 Lease 成千上万个，那么 etcd 可能无法支撑如此大规模的 Lease 数，导致高负载。</li></ul><p><strong>v2 版本</strong></p><p>在早期 v2 版本中，没有 Lease 概念，TTL 属性是在 key 上面，为了保证 key 不删除，即便你的 TTL 相同，client 也需要为每个 TTL、key 创建一个 HTTP/1.x 连接，定时发送续期请求给 etcd server。</p><p>很显然，v2 老版本这种设计，因不支持连接多路复用、相同 TTL 无法复用导致性能较差，无法支撑较大规模的 Lease 场景。</p><p><strong>v3版本</strong></p><p>etcd v3 版本为了解决以上问题，提出了 Lease 特性，TTL 属性转移到了 Lease 上， 同时协议从 HTTP/1.x 优化成 gRPC 协议。</p><ul><li><p>一方面不同 key 若 TTL 相同，可复用同一个 Lease， 显著减少了 Lease 数。</p></li><li><p>另一方面，通过 gRPC HTTP/2 实现了多路复用，流式传输，同一连接可支持为多个 Lease 续期，大大减少了连接数。</p></li></ul><p>通过以上两个优化，实现 Lease 性能大幅提升，满足了各个业务场景诉求。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/lease/lessor.go 391 行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>Renew</span><span class=p>(</span><span class=nx>id</span> <span class=nx>LeaseID</span><span class=p>)</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ... 省略无关代码
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 重置 remaining TTL字段，如果存在的话，这个和 checkPoint有关
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>clearRemainingTTL</span> <span class=o>:=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>cp</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>l</span><span class=p>.</span><span class=nx>remainingTTL</span> <span class=p>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>clearRemainingTTL</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 可以看到，就是将 Remaining_TTL 字段设置为0了
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>le</span><span class=p>.</span><span class=nf>cp</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpointRequest</span><span class=p>{</span><span class=nx>Checkpoints</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpoint</span><span class=p>{{</span><span class=nx>ID</span><span class=p>:</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>ID</span><span class=p>),</span> <span class=nx>Remaining_TTL</span><span class=p>:</span> <span class=mi>0</span><span class=p>}}})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>l</span><span class=p>.</span><span class=nf>refresh</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1>// refresh lease 的过期时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>item</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>LeaseWithTime</span><span class=p>{</span><span class=nx>id</span><span class=p>:</span> <span class=nx>l</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>time</span><span class=p>:</span> <span class=nx>l</span><span class=p>.</span><span class=nx>expiry</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>le</span><span class=p>.</span><span class=nx>leaseExpiredNotifier</span><span class=p>.</span><span class=nf>RegisterOrUpdate</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>leaseRenewed</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nx>ttl</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=4-如何高效淘汰过期-lease>4. 如何高效淘汰过期 Lease</h2><p><strong>淘汰过期 Lease 的工作由 Lessor 模块的一个异步 goroutine 负责</strong>。它会定时从最小堆中取出已过期的 Lease，执行删除 Lease 和其关联的 key 列表数据的 RevokeExpiredLease 任务。</p><p>etcd Lessor 主循环每隔 500ms 执行一次撤销 Lease 检查（RevokeExpiredLease），每次轮询堆顶的元素，若已过期则加入到待淘汰列表，直到堆顶的 Lease 过期时间大于当前，则结束本轮轮询。</p><p><strong>优化前</strong></p><p>etcd 早期的时候，淘汰 Lease 非常暴力。etcd 会直接遍历所有 Lease，逐个检查 Lease 是否过期，过期则从 Lease 关联的 key 集合中，取出 key 列表，删除它们，时间复杂度是 O(N)。</p><p><strong>优化后</strong></p><p>目前 etcd 是基于<strong>最小堆</strong>来管理 Lease，实现快速淘汰过期的 Lease。</p><p>每次新增 Lease、续期的时候，它会插入、更新一个对象到最小堆中，对象含有 LeaseID 和其到期时间 unixnano，<strong>对象之间按到期时间升序排序</strong>。</p><p>使用堆优化后后，插入、更新、删除，它的时间复杂度是 O(Log N)，查询堆顶对象是否过期时间复杂度仅为 O(1)，性能大大提升，可支撑大规模场景下 Lease 的高效淘汰。</p><p><strong>获取到待过期的 LeaseID 后，Leader 是如何通知其他 Follower 节点淘汰它们呢？</strong></p><p>Lessor 模块会将已确认过期的 LeaseID，保存在一个名为 expiredC 的 channel 中，而 etcd server 的主循环会定期从 channel 中获取 LeaseID，发起 revoke 请求，通过 Raft Log 传递给 Follower 节点。</p><p>各个节点收到 revoke Lease 请求后，获取关联到此 Lease 上的 key 列表，从 boltdb 中删除 key，从 Lessor 的 Lease map 内存中删除此 Lease 对象，最后还需要从 boltdb 的 Lease bucket 中删除这个 Lease。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/lease/lessor.go 628行
</span></span></span><span class=line><span class=cl><span class=c1>// 这就是之前提到的 lessor 模块的两个定时任务中的一个
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>revokeExpiredLeases</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>ls</span> <span class=p>[]</span><span class=o>*</span><span class=nx>Lease</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 限制每次定时任务最多只能移除多少个 lease
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 主要是防止同时过期的 lease 太多，阻塞后续的任务
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>revokeLimit</span> <span class=o>:=</span> <span class=nx>leaseRevokeRate</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>le</span><span class=p>.</span><span class=nf>isPrimary</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 找到已经过期的 lease
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>ls</span> <span class=p>=</span> <span class=nx>le</span><span class=p>.</span><span class=nf>findExpiredLeases</span><span class=p>(</span><span class=nx>revokeLimit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ls</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>le</span><span class=p>.</span><span class=nx>stopC</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>           <span class=c1>// 然后发送到 expiredC chan 中，具体的处理逻辑由 etcd server 主循环负责
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=nx>le</span><span class=p>.</span><span class=nx>expiredC</span> <span class=o>&lt;-</span> <span class=nx>ls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// the receiver of expiredC is probably busy handling
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// other stuff
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// let&#39;s try this next time after 500ms
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=5--checkpoint-机制>5. checkpoint 机制</h2><p>为了降低 Lease 特性的实现复杂度，检查 Lease 是否过期、维护最小堆、针对过期的 Lease 发起 revoke 操作，都是 Leader 节点负责的，它类似于 Lease 的仲裁者，通过以上清晰的权责划分。</p><p>那么当 Leader 因重启、crash、磁盘 IO 等异常不可用时，Follower 节点就会发起 Leader 选举，新 Leader 要完成以上职责，必须重建 Lease 过期最小堆等管理数据结构，<strong>那么以上重建可能会触发什么问题呢</strong>？</p><p>当你的集群发生 Leader 切换后，新的 Leader 基于 Lease map 信息，按 Lease 过期时间构建一个最小堆时，etcd 早期版本为了优化性能，并未持久化存储 Lease 剩余 TTL 信息，<strong>因此重建的时候就会自动给所有 Lease 自动续期了</strong>。</p><blockquote><p>如果较频繁出现 Leader 切换，切换时间小于 Lease 的 TTL，这会导致 Lease 永远无法删除，大量 key 堆积，db 大小超过配额等异常。</p></blockquote><p>为了解决这个问题，etcd 引入了检查点机制，也就是 Lessor 模块的**checkpointScheduledLease **定时任务。</p><ul><li><p>一方面，etcd 启动的时候，Leader 节点后台会运行此异步任务，定期批量地将 Lease 剩余的 TTL 基于 Raft Log 同步给 Follower 节点，Follower 节点收到 CheckPoint 请求后，更新内存数据结构 LeaseMap 的剩余 TTL 信息。</p></li><li><p>另一方面，当 Leader 节点收到 KeepAlive 请求的时候，它也会通过 checkpoint 机制把此 Lease 的剩余 TTL 重置，并同步给 Follower 节点，尽量确保续期后集群各个节点的 Lease 剩余 TTL 一致性。</p></li></ul><blockquote><p>最后你要注意的是，此特性对性能有一定影响，目前仍然是试验特性。你可以通过 experimental-enable-lease-checkpoint 参数开启。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/lease/lessor.go 826行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Lease</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ID</span>           <span class=nx>LeaseID</span>
</span></span><span class=line><span class=cl>	<span class=nx>ttl</span>          <span class=kt>int64</span> <span class=c1>// time to live of the lease in seconds
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>remainingTTL</span> <span class=kt>int64</span> <span class=c1>// remaining time to live in seconds, if zero valued it is considered unset and the full ttl should be used
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// expiryMu protects concurrent accesses to expiry
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>expiryMu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>	<span class=c1>// expiry is time when lease should expire. no expiration when expiry.IsZero() is true
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>expiry</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// mu protects concurrent accesses to itemSet
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>mu</span>      <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>itemSet</span> <span class=kd>map</span><span class=p>[</span><span class=nx>LeaseItem</span><span class=p>]</span><span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>revokec</span> <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Lease 中的 remainingTTL 字段就是用于完成这个功能的。</p><p>在 Grant 创建 Lease 时，该字段是没有赋值的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>Grant</span><span class=p>(</span><span class=nx>id</span> <span class=nx>LeaseID</span><span class=p>,</span> <span class=nx>ttl</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Lease</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Lease</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ID</span><span class=p>:</span>      <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ttl</span><span class=p>:</span>     <span class=nx>ttl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>itemSet</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>LeaseItem</span><span class=p>]</span><span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>revokec</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>即，新建的 Lease remainingTTL 字段都为0。</p><p>至于具体的逻辑自然是在<code>checkpointScheduledLease </code>这个定时任务中了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/lease/lessor.go 655 行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>checkpointScheduledLeases</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>cps</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpoint</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 和另一个定时任务一样，同样是加了限制，防止该任务消耗太多时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>leaseCheckpointRate</span><span class=o>/</span><span class=mi>2</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>le</span><span class=p>.</span><span class=nf>isPrimary</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 寻找需要执行 checkPoint 的 Lease，同样是限制了最大个数
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>cps</span> <span class=p>=</span> <span class=nx>le</span><span class=p>.</span><span class=nf>findDueScheduledCheckpoints</span><span class=p>(</span><span class=nx>maxLeaseCheckpointBatchSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>le</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cps</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// cp 是一个方法，调用该方法进行 checkPoint 检查
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>le</span><span class=p>.</span><span class=nf>cp</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpointRequest</span><span class=p>{</span><span class=nx>Checkpoints</span><span class=p>:</span> <span class=nx>cps</span><span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 上面查询时限制了最大查询数，如果最终个数少于指定值，则说明没有更多结果了，退出循环
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 比如限制要找1000个，结果返回值也是1000个，说明后续可能还有没找到的Lease，但是如果只找到了100个，那肯定是找完了。
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cps</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>maxLeaseCheckpointBatchSize</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>至于是怎么找的，其实就是循环从 heap 中取出来的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>findDueScheduledCheckpoints</span><span class=p>(</span><span class=nx>checkpointLimit</span> <span class=kt>int</span><span class=p>)</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpoint</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>le</span><span class=p>.</span><span class=nx>cp</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>now</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>cps</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpoint</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>le</span><span class=p>.</span><span class=nx>leaseCheckpointHeap</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cps</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>checkpointLimit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>lt</span> <span class=o>:=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>leaseCheckpointHeap</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这是一个最小堆，第一个元素的time值就是最小的，如果第一个元素的checkpoint time 都没到，则说明该找的都找到了，直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>lt</span><span class=p>.</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>now</span><span class=p>)</span> <span class=cm>/* lt.time: next checkpoint time */</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>cps</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>heap</span><span class=p>.</span><span class=nf>Pop</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>le</span><span class=p>.</span><span class=nx>leaseCheckpointHeap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>l</span> <span class=o>*</span><span class=nx>Lease</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>ok</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>l</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>leaseMap</span><span class=p>[</span><span class=nx>lt</span><span class=p>.</span><span class=nx>id</span><span class=p>];</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果这个lease都过期了则不检测，由expireCheck任务处理
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=p>!</span><span class=nx>now</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>expiry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>remainingTTL</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>expiry</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>now</span><span class=p>).</span><span class=nf>Seconds</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>remainingTTL</span> <span class=o>&gt;=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>ttl</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>le</span><span class=p>.</span><span class=nx>lg</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>le</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;Checkpointing lease&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>zap</span><span class=p>.</span><span class=nf>Int64</span><span class=p>(</span><span class=s>&#34;leaseID&#34;</span><span class=p>,</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>lt</span><span class=p>.</span><span class=nx>id</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>				<span class=nx>zap</span><span class=p>.</span><span class=nf>Int64</span><span class=p>(</span><span class=s>&#34;remainingTTL&#34;</span><span class=p>,</span> <span class=nx>remainingTTL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>cps</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>cps</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpoint</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>lt</span><span class=p>.</span><span class=nx>id</span><span class=p>),</span> <span class=nx>Remaining_TTL</span><span class=p>:</span> <span class=nx>remainingTTL</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cps</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>继续追踪下去，看下找到只会 etcd 是如何处理的，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>            <span class=c1>// cp 是一个方法，调用该方法进行 checkPoint 检查
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>le</span><span class=p>.</span><span class=nf>cp</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpointRequest</span><span class=p>{</span><span class=nx>Checkpoints</span><span class=p>:</span> <span class=nx>cps</span><span class=p>})</span>
</span></span></code></pre></div><p>如果够仔细的话，可以发送cp 字段其实是在 NewServer 方法中赋值的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/etcdserver/server.go 299 行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewServer</span><span class=p>(</span><span class=nx>cfg</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ServerConfig</span><span class=p>)</span> <span class=p>(</span><span class=nx>srv</span> <span class=o>*</span><span class=nx>EtcdServer</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 因为该功能对性能有一定影响，目前还是试验性功能，需要通过参数指定开启
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>Cfg</span><span class=p>.</span><span class=nx>EnableLeaseCheckpoint</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// setting checkpointer enables lease checkpoint feature.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>srv</span><span class=p>.</span><span class=nx>lessor</span><span class=p>.</span><span class=nf>SetCheckpointer</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cp</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>LeaseCheckpointRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>srv</span><span class=p>.</span><span class=nf>raftRequestOnce</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>InternalRaftRequest</span><span class=p>{</span><span class=nx>LeaseCheckpoint</span><span class=p>:</span> <span class=nx>cp</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>具体逻辑如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/etcdserver/v3_server.go 593行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>EtcdServer</span><span class=p>)</span> <span class=nf>raftRequestOnce</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>r</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>InternalRaftRequest</span><span class=p>)</span> <span class=p>(</span><span class=nx>proto</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>processInternalRaftRequestOnce</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>result</span><span class=p>.</span><span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>result</span><span class=p>.</span><span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>startTime</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=nx>traceutil</span><span class=p>.</span><span class=nx>StartTimeKey</span><span class=p>).(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>);</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>result</span><span class=p>.</span><span class=nx>trace</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>applyStart</span> <span class=o>:=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nf>GetStartTime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// The trace object is created in apply. Here reset the start time to trace
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// the raft request time by the difference between the request start time
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// and apply start time
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>result</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nf>SetStartTime</span><span class=p>(</span><span class=nx>startTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nf>InsertStep</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>applyStart</span><span class=p>,</span> <span class=s>&#34;process raft request&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=nx>traceThreshold</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>result</span><span class=p>.</span><span class=nx>resp</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>再进一步：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/etcdserver/v3_server.go 642行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>EtcdServer</span><span class=p>)</span> <span class=nf>processInternalRaftRequestOnce</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>r</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>InternalRaftRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>applyResult</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里首先获取了本地复制状态机中的 appliedIndex 和 committedIndex
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ai</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>getAppliedIndex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>ci</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>getCommittedIndex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 committedIndex 远超过 appliedIndex（目前阈值为5000）就会报错，此时不再接受新的提案。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ErrTooManyRequests             = errors.New(&#34;etcdserver: too many requests&#34;)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>ci</span> <span class=p>&gt;</span> <span class=nx>ai</span><span class=o>+</span><span class=nx>maxGapBetweenApplyAndCommitIndex</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>ErrTooManyRequests</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>Header</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>RequestHeader</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ID</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>reqIDGen</span><span class=p>.</span><span class=nf>Next</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// check authinfo if it is not InternalAuthenticateRequest
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Authenticate</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>authInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>AuthInfoFromCtx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>authInfo</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nx>Username</span> <span class=p>=</span> <span class=nx>authInfo</span><span class=p>.</span><span class=nx>Username</span>
</span></span><span class=line><span class=cl>			<span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nx>AuthRevision</span> <span class=p>=</span> <span class=nx>authInfo</span><span class=p>.</span><span class=nx>Revision</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Cfg</span><span class=p>.</span><span class=nx>MaxRequestBytes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>ErrRequestTooLarge</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>id</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>ID</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>id</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>id</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nx>ID</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 注册提案Id，后续通过chan以异步的方式接受返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ch</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>w</span><span class=p>.</span><span class=nf>Register</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Cfg</span><span class=p>.</span><span class=nf>ReqTimeout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 到此将这个提案提交到 raft 模块。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nf>Propose</span><span class=p>(</span><span class=nx>cctx</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proposalsFailed</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>w</span><span class=p>.</span><span class=nf>Trigger</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span> <span class=c1>// GC wait
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>proposalsPending</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>proposalsPending</span><span class=p>.</span><span class=nf>Dec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>x</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>x</span><span class=p>.(</span><span class=o>*</span><span class=nx>applyResult</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>cctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=nx>proposalsFailed</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>w</span><span class=p>.</span><span class=nf>Trigger</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span> <span class=c1>// GC wait
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nf>parseProposeCtxErr</span><span class=p>(</span><span class=nx>cctx</span><span class=p>.</span><span class=nf>Err</span><span class=p>(),</span> <span class=nx>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>s</span><span class=p>.</span><span class=nx>done</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>ErrStopped</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>至此 checkPoint 工作就算完成一大半了，remainingTTL 数据被提交到 Raft 模块，然后同步给 Follower，最后 Apply 到状态机。</p><blockquote><p>这样所有的节点都拥有了 Lease 的 remainingTTL 值了。</p></blockquote><p>看下崩溃恢复后，是如何处理的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newLessor</span><span class=p>(</span><span class=nx>lg</span> <span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span><span class=p>,</span> <span class=nx>b</span> <span class=nx>backend</span><span class=p>.</span><span class=nx>Backend</span><span class=p>,</span> <span class=nx>cluster</span> <span class=nx>cluster</span><span class=p>,</span> <span class=nx>cfg</span> <span class=nx>LessorConfig</span><span class=p>)</span> <span class=o>*</span><span class=nx>lessor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>lessor</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从 blotdb 中加载lease数据并在内存中重建
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>l</span><span class=p>.</span><span class=nf>initAndRecover</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Lessor 模块启动的时候就会从 blotdb 中加载数据并重建。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>le</span> <span class=o>*</span><span class=nx>lessor</span><span class=p>)</span> <span class=nf>initAndRecover</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span> <span class=o>:=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>b</span><span class=p>.</span><span class=nf>BatchTx</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>schema</span><span class=p>.</span><span class=nf>UnsafeCreateLeaseBucket</span><span class=p>(</span><span class=nx>tx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>lpbs</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nf>MustUnsafeGetAllLeases</span><span class=p>(</span><span class=nx>tx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>lpb</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lpbs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ID</span> <span class=o>:=</span> <span class=nf>LeaseID</span><span class=p>(</span><span class=nx>lpb</span><span class=p>.</span><span class=nx>ID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>lpb</span><span class=p>.</span><span class=nx>TTL</span> <span class=p>&lt;</span> <span class=nx>le</span><span class=p>.</span><span class=nx>minLeaseTTL</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>lpb</span><span class=p>.</span><span class=nx>TTL</span> <span class=p>=</span> <span class=nx>le</span><span class=p>.</span><span class=nx>minLeaseTTL</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>le</span><span class=p>.</span><span class=nx>leaseMap</span><span class=p>[</span><span class=nx>ID</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Lease</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ID</span><span class=p>:</span>  <span class=nx>ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>ttl</span><span class=p>:</span> <span class=nx>lpb</span><span class=p>.</span><span class=nx>TTL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>itemSet</span><span class=p>:</span>      <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>LeaseItem</span><span class=p>]</span><span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>			<span class=nx>expiry</span><span class=p>:</span>       <span class=nx>forever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>revokec</span><span class=p>:</span>      <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span> 
</span></span><span class=line><span class=cl>			<span class=nx>remainingTTL</span><span class=p>:</span> <span class=nx>lpb</span><span class=p>.</span><span class=nx>RemainingTTL</span><span class=p>,</span> <span class=c1>// 重建时同样带上了 RemainingTTL
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>le</span><span class=p>.</span><span class=nx>leaseExpiredNotifier</span><span class=p>.</span><span class=nf>Init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>heap</span><span class=p>.</span><span class=nf>Init</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>le</span><span class=p>.</span><span class=nx>leaseCheckpointHeap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>le</span><span class=p>.</span><span class=nx>b</span><span class=p>.</span><span class=nf>ForceCommit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>由于重建时也带上了 RemainingTTL，此时就不会向之前那样，每次重建都会默认给 Lease 续期了。</p><p>至此 etcd 的 checkPoint 功能结束，Lease 被自动续期的问题也得以解决。</p><h2 id=6-小结>6. 小结</h2><ul><li>1）Lease 的核心是 TTL，当 Lease 的 TTL 过期时，它会自动删除其关联的 key-value 数据。</li><li>2）v3 版本通过引入 Lease 的概念，将 TTL 和 Key 解耦，支持多 key 共用一个 Lease 来提升性能。同时协议从 HTTP/1.x 优化成 gRPC 协议，支持多路连接复用，显著降低了 server 连接数等资源开销。</li><li>3）Lease 过期通过最小堆来提升效率。</li><li>4）通过 Checkpoint 机制想 follower 同步 Lease 信息来解决 Leader 异常情况下 TTL 自动被续期，可能导致 Lease 永不淘汰的问题而诞生。</li></ul><p>作者能力实在是有限，文中很有可能会有一些错误的理解。所以当你发现了一些违和的地方，也请不吝指教，谢谢你！</p><p>再次感谢你能看到这里！</p><h2 id=7-参考>7. 参考</h2><p><code>https://github.com/etcd-io/etcd</code></p><p><code>etcd 实战课</code></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-12-17</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.yudlk.com/posts/etcd/10-lease/ data-title="etcd教程(十)---lease 机制源码分析" data-hashtags=etcd><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.yudlk.com/posts/etcd/10-lease/ data-hashtag=etcd><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.yudlk.com/posts/etcd/10-lease/ data-title="etcd教程(十)---lease 机制源码分析"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.yudlk.com/posts/etcd/10-lease/ data-title="etcd教程(十)---lease 机制源码分析"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.yudlk.com/posts/etcd/10-lease/ data-title="etcd教程(十)---lease 机制源码分析"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/etcd/>etcd</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/etcd/09-raft/ class=prev rel=prev title="etcd教程(九)---Raft 算法具体实现"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>etcd教程(九)---Raft 算法具体实现</a>
<a href=/posts/etcd/11-txn/ class=next rel=next title="etcd教程(十一)---etcd 事务初体验">etcd教程(十一)---etcd 事务初体验<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/barrypt target=_blank>qpt</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a rel="license external nofollow noopener noreffer" href=https://beian.miit.gov.cn/ target=_blank>渝ICP备20005680号-1</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.480e58b2c2a8605d406f34667e92ff8f1ae50cfee5b653bead570f004839a983.js integrity="sha256-SA5YssKoYF1AbzRmfpL/jxrlDP7ltlO+rVcPAEg5qYM="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-FL23FNP7CM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-FL23FNP7CM" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b7c98449a6edf8492a8f3404e6d06a0",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7693630257897132" crossorigin=anonymous></script></body></html>