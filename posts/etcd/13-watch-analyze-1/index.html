<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>etcd教程(十三)---watch 机制源码分析（上） -</title><meta name=Description content="etcd watch 机制具体实现及源码分析"><meta property="og:title" content="etcd教程(十三)---watch 机制源码分析（上）"><meta property="og:description" content="etcd watch 机制具体实现及源码分析"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.yudlk.com/posts/etcd/13-watch-analyze-1/"><meta property="og:image" content="https://blog.yudlk.com/img/jinx.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-21T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-21T00:00:00+00:00"><meta property="og:site_name" content="qpt的个人博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.yudlk.com/img/jinx.png"><meta name=twitter:title content="etcd教程(十三)---watch 机制源码分析（上）"><meta name=twitter:description content="etcd watch 机制具体实现及源码分析"><meta name=application-name content="面对疾风"><meta name=apple-mobile-web-app-title content="面对疾风"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.yudlk.com/posts/etcd/13-watch-analyze-1/><link rel=prev href=https://blog.yudlk.com/posts/etcd/12-mvcc-analyze/><link rel=next href=https://blog.yudlk.com/posts/etcd/14-watch-analyze-2/><link rel=stylesheet href=/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"etcd教程(十三)---watch 机制源码分析（上）","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.yudlk.com\/posts\/etcd\/13-watch-analyze-1\/"},"image":["https:\/\/blog.yudlk.com\/img\/jinx.png"],"genre":"posts","keywords":"etcd","wordcount":5085,"url":"https:\/\/blog.yudlk.com\/posts\/etcd\/13-watch-analyze-1\/","datePublished":"2022-01-21T00:00:00+00:00","dateModified":"2022-01-21T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"qpt"},"description":"etcd watch 机制具体实现及源码分析"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title>面对疾风</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=面对疾风>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/ title=关于>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title>面对疾风</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title=面对疾风>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">etcd教程(十三)---watch 机制源码分析（上）</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/barrypt title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>qpt</a></span>&nbsp;<span class=post-category>included in <a href=/categories/etcd/><i class="far fa-folder fa-fw" aria-hidden=true></i>etcd</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-01-21>2022-01-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;5085 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;11 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-概述>1. 概述</a><ul><li><a href=#大致流程>大致流程</a></li><li><a href=#watcher-状态划分>watcher 状态划分</a></li></ul></li><li><a href=#2-server>2. Server</a><ul><li><a href=#概述>概述</a></li><li><a href=#watch>Watch</a></li></ul></li><li><a href=#3-sendloop>3. sendLoop</a></li><li><a href=#4-recvloop>4. recvLoop</a></li><li><a href=#5-小结>5. 小结</a></li></ul></nav></div></div><div class=content id=content><p>本文主要通过源码分析了 etcd v3 版本 watch 机制的具体实现（上篇）。</p><h2 id=1-概述>1. 概述</h2><blockquote><p>由于本期内容比较多，分成了上下两篇。</p><p><a href=https://www.lixueduan.com/post/etcd/13-watch-analyze-1/ target=_blank rel="noopener noreffer">etcd教程(十三)&mdash;watch 机制源码分析（上）</a></p><p><a href=https://www.lixueduan.com/post/etcd/14-watch-analyze-2/ target=_blank rel="noopener noreffer">etcd教程(十四)&mdash;watch 机制源码分析（下）</a></p></blockquote><p>为了避免客户端的反复轮询， etcd 提供了 watch 机制。客户端 watch 一系列 key，当这些被 watch 的 key 更新时， etcd 就会通知客户端。</p><p>本文主要为源码分析，，若对etcd watch 机制不熟悉的朋友可以先看下 <a href=https://www.lixueduan.com/post/etcd/05-watch/ target=_blank rel="noopener noreffer">etcd教程(五)&mdash;watch机制原理分析</a>。</p><blockquote><p>以下分析基本 etcd v3.5.1 版本。</p></blockquote><h3 id=大致流程>大致流程</h3><p>整体流程如下图所示，可以分为两个部分:</p><ul><li>1）创建 watcher</li><li>2）watch 事件推送</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-arch.webp data-srcset="https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-arch.webp, https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-arch.webp 1.5x, https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-arch.webp 2x" data-sizes=auto alt=https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-arch.webp title=etcd-v3-watch-arch></p><p><strong>1）创建 watcher</strong></p><ul><li>发起一个 watch key 请求的时候，etcd 的 gRPCWatchServer 收到 watch 请求后，会创建一个 serverWatchStream, 它负责接收 client 的 gRPC Stream 的 create/cancel watcher 请求 (recvLoop goroutine)，并将从 MVCC 模块接收的 Watch 事件转发给 client(sendLoop goroutine)。</li><li>当 serverWatchStream 收到 create watcher 请求后，serverWatchStream 会调用 MVCC 模块的 WatchStream 子模块分配一个 watcher id，并将 watcher 注册到 MVCC 的 WatchableKV 模块。</li><li>在 etcd 启动的时候，WatchableKV 模块会运行 syncWatchersLoop 和 syncVictimsLoop goroutine，分别负责不同场景下的事件推送，它们也是 Watch 特性可靠性的核心之一。</li></ul><p><strong>2）watch 事件推送</strong></p><ul><li>当你创建完成 watcher 后，此时你执行 put hello 修改操作时，请求经过 KVServer、Raft 模块后 Apply 到状态机时，在 MVCC 的 put 事务中，它会将本次修改的后的 mvccpb.KeyValue 保存到一个 changes 数组中。</li><li>在 put 事务结束时，它会将 KeyValue 转换成 Event 事件，然后回调 watchableStore.notify 函数（如下精简代码所示）。notify 会匹配出监听过此 key 并处于 synced watcherGroup 中的 watcher，同时事件中的版本号要大于等于 watcher 监听的最小版本号，才能将事件发送到此 watcher 的事件 channel 中。</li><li>serverWatchStream 的 sendLoop goroutine 监听到 channel 消息后，读出消息立即推送给 client，至此，完成一个最新修改事件推送。</li></ul><p>根据流程图可知，watch 机制分为图中的蓝色和橙色两部分：</p><ul><li>处理 WatchRequest 和发送 WatchResponse 的姑且叫做 serverWatchStream 模块。</li><li>处理具体 PUT 操作，并推送事件的 MVCC 模块。</li></ul><blockquote><p>注：etcd 中并没有serverWatchStream这么一个模块，这部分逻辑是在 server 中的，本文暂且称这部分逻辑为 serverWatchStream 模块。</p></blockquote><p>下面就从这两部分进行分析</p><h3 id=watcher-状态划分>watcher 状态划分</h3><p>etcd 中根据不同场景，对问题进行了分解，将 watcher 按场景分类，实现了轻重分离、低耦合。</p><p>具体如下：</p><ul><li><p><strong>synced watcher</strong>，顾名思义，表示此类 watcher 监听的数据都已经同步完毕，在等待新的变更。</p><ul><li>如果你创建的 watcher 未指定版本号 (默认 0)、或指定的版本号大于 etcd sever 当前最新的版本号 (currentRev)，那么它就会保存到 synced watcherGroup 中。</li></ul></li><li><p><strong>unsynced watcher</strong>，表示此类 watcher 监听的数据还未同步完成，落后于当前最新数据变更，正在努力追赶。</p><ul><li>如果你创建的 watcher 指定版本号小于 etcd server 当前最新版本号，那么它就会保存到 unsynced watcherGroup 中。</li></ul></li><li><p><strong>victim watcher</strong>：表示 watcher 存在事件堆积导致推送异常 ，需要由异步任务执行重试操作。</p></li></ul><p>从以上介绍中，我们可以将可靠的事件推送机制拆分成<code>最新事件推送</code>、<code>异常场景重试</code>、<code>历史事件推送</code>三个子问题来进行分析。</p><p>watcher 状态转换关系如下图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://github.com/barrypt/blog/raw/master/images/etcd/watch/watcher%20%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%85%B3%E7%B3%BB%E5%9B%BE.png data-srcset="https://github.com/barrypt/blog/raw/master/images/etcd/watch/watcher%20%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%85%B3%E7%B3%BB%E5%9B%BE.png, https://github.com/barrypt/blog/raw/master/images/etcd/watch/watcher%20%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%85%B3%E7%B3%BB%E5%9B%BE.png 1.5x, https://github.com/barrypt/blog/raw/master/images/etcd/watch/watcher%20%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%85%B3%E7%B3%BB%E5%9B%BE.png 2x" data-sizes=auto alt=https://github.com/barrypt/blog/raw/master/images/etcd/watch/watcher%20%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%85%B3%E7%B3%BB%E5%9B%BE.png title=etcd-watcher-state-change></p><h2 id=2-server>2. Server</h2><h3 id=概述>概述</h3><p>etcd server 启动时会注册多个 gRPC server，watch server 也是其中一个：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/etcdserver/api/v3rpc/grpc.go 39 行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Server</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>etcdserver</span><span class=p>.</span><span class=nx>EtcdServer</span><span class=p>,</span> <span class=nx>tls</span> <span class=o>*</span><span class=nx>tls</span><span class=p>.</span><span class=nx>Config</span><span class=p>,</span> <span class=nx>interceptor</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryServerInterceptor</span><span class=p>,</span> <span class=nx>gopts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>ServerOption</span><span class=p>)</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>Server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>grpcServer</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>gopts</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 省略无关逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 注册 WatchServer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterWatchServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nf>NewWatchServer</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>grpcServer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>WatchServer 只用于处理 Watch 方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>WatchServer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Watch</span><span class=p>(</span><span class=nx>Watch_WatchServer</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然后是 etcd 对外提供的 Watch 接口的定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=c1>// api/etcdserverpb/rpc.proto 66 行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>service</span> <span class=n>Watch</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=c1>// Watch watches for events happening or that have happened. Both input and output
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// are streams; the input stream is for creating and canceling watchers and the output
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// stream sends events. One watch RPC can watch on multiple key ranges, streaming events
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// for several watches at once. The entire event history can be watched starting from the
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// last compaction revision.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>rpc</span> <span class=n>Watch</span><span class=p>(</span><span class=n>stream</span> <span class=n>WatchRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>stream</span> <span class=n>WatchResponse</span><span class=p>)</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      <span class=k>option</span> <span class=p>(</span><span class=n>google.api.http</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>post</span><span class=o>:</span> <span class=s>&#34;/v3/watch&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>body</span><span class=o>:</span> <span class=s>&#34;*&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>};</span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>etcd v3 使用的是 <a href=https://github.com/grpc-ecosystem/grpc-gateway target=_blank rel="noopener noreffer">gRPC-Gateway</a> 以同时提供 RPC 和 HTTP 服务，不了解的朋友可以看一下 <a href=https://www.lixueduan.com/post/grpc/07-grpc-gateway/ target=_blank rel="noopener noreffer">gRPC(Go)教程(七)&mdash;利用Gateway同时提供HTTP和RPC服务</a>。</p><blockquote><p>实际上 gRPC-Gateway 这个库就是因为 etcd 更新到 v3 时需要同时提供 RPC 和 HTTP 服务而诞生的。</p></blockquote><p>Watch 接口的大致逻辑为：</p><p>当你通过 etcdctl 或 API 发起一个 watch key 请求的时候，etcd 的 gRPCWatchServer 收到 watch 请求后，会创建一个 serverWatchStream, 它负责接收 client 的 gRPC Stream 的 create/cancel watcher 请求 (recvLoop goroutine)，并将从 MVCC 模块接收的 Watch 事件转发给 client(sendLoop goroutine)。</p><blockquote><p>注：并不是每次调用 watch 就会创建一个 serverWatchStream，而是每个 gRPC Stream 只会创建一个，这个创建出来的 serverWatchStream 会接管这个 gRPC Stream 上的所有 watcher。</p><p>而一个连接上又可以创建多个 gRPC Stream，这也就是为什么 etcd v3的 watch 在资源占用上比 v2 有大幅降低。</p></blockquote><p>具体如下图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-model.webp data-srcset="https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-model.webp, https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-model.webp 1.5x, https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-model.webp 2x" data-sizes=auto alt=https://github.com/barrypt/blog/raw/master/images/etcd/watch/etcd-v3-watch-model.webp title=etcd-v3-watch-model></p><h3 id=watch>Watch</h3><p>具体实现如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/etcdserver/api/v3rpc/watch.go 152行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ws</span> <span class=o>*</span><span class=nx>watchServer</span><span class=p>)</span> <span class=nf>Watch</span><span class=p>(</span><span class=nx>stream</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Watch_WatchServer</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sws</span> <span class=o>:=</span> <span class=nx>serverWatchStream</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>lg</span><span class=p>:</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>lg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>clusterID</span><span class=p>:</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>clusterID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>memberID</span><span class=p>:</span>  <span class=nx>ws</span><span class=p>.</span><span class=nx>memberID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>maxRequestBytes</span><span class=p>:</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>maxRequestBytes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>sg</span><span class=p>:</span>        <span class=nx>ws</span><span class=p>.</span><span class=nx>sg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>watchable</span><span class=p>:</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>watchable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ag</span><span class=p>:</span>        <span class=nx>ws</span><span class=p>.</span><span class=nx>ag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>gRPCStream</span><span class=p>:</span>  <span class=nx>stream</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>watchStream</span><span class=p>:</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>watchable</span><span class=p>.</span><span class=nf>NewWatchStream</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=c1>// chan for sending control response like watcher created and canceled.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>ctrlStream</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>,</span> <span class=nx>ctrlStreamBufLen</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>progress</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>mvcc</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span><span class=kt>bool</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>prevKV</span><span class=p>:</span>   <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>mvcc</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span><span class=kt>bool</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>fragment</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>mvcc</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span><span class=kt>bool</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>closec</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>sws</span><span class=p>.</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 第一个 goroutine sendLoop 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sws</span><span class=p>.</span><span class=nf>sendLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>sws</span><span class=p>.</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>errc</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>error</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 第二个 goroutine recvLoop
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>rerr</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nf>recvLoop</span><span class=p>();</span> <span class=nx>rerr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nf>isClientCtxErr</span><span class=p>(</span><span class=nx>stream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Err</span><span class=p>(),</span> <span class=nx>rerr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;failed to receive watch request from gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>rerr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;failed to receive watch request from gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>rerr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=nx>streamFailures</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;receive&#34;</span><span class=p>,</span> <span class=s>&#34;watch&#34;</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>errc</span> <span class=o>&lt;-</span> <span class=nx>rerr</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>err</span> <span class=p>=</span> <span class=o>&lt;-</span><span class=nx>errc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Canceled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=p>=</span> <span class=nx>rpctypes</span><span class=p>.</span><span class=nx>ErrGRPCWatchCanceled</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>stream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Err</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Canceled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=p>=</span> <span class=nx>rpctypes</span><span class=p>.</span><span class=nx>ErrGRPCWatchCanceled</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>sws</span><span class=p>.</span><span class=nb>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>和流程图一致，创建 serverWatchStream 并分别启动了sendLoop 和 recvLoop。</p><p>接下来就分析这两个 Loop。</p><h2 id=3-sendloop>3. sendLoop</h2><p>sendLoop 主要负责把从 MVCC 模块接收的 Watch 事件转发给 client。</p><p>具体如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/etcdserver/api/v3rpc/watch.go 355行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>sws</span> <span class=o>*</span><span class=nx>serverWatchStream</span><span class=p>)</span> <span class=nf>sendLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// watch ids that are currently active
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ids</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>mvcc</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span><span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=c1>// watch responses pending on a watch id creation message
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pending</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>mvcc</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>][]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>interval</span> <span class=o>:=</span> <span class=nf>GetProgressReportInterval</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>progressTicker</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=nx>interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 省略部分逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>wresp</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Chan</span><span class=p>():</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>evs</span> <span class=o>:=</span> <span class=nx>wresp</span><span class=p>.</span><span class=nx>Events</span>
</span></span><span class=line><span class=cl>			<span class=nx>events</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>mvccpb</span><span class=p>.</span><span class=nx>Event</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>evs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>needPrevKV</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>prevKV</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>evs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>events</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>evs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>needPrevKV</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nf>IsCreateEvent</span><span class=p>(</span><span class=nx>evs</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>opt</span> <span class=o>:=</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nx>RangeOptions</span><span class=p>{</span><span class=nx>Rev</span><span class=p>:</span> <span class=nx>evs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Kv</span><span class=p>.</span><span class=nx>ModRevision</span> <span class=o>-</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>watchable</span><span class=p>.</span><span class=nf>Range</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>evs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Kv</span><span class=p>.</span><span class=nx>Key</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>opt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>KVs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>events</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>PrevKv</span> <span class=p>=</span> <span class=o>&amp;</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>KVs</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>canceled</span> <span class=o>:=</span> <span class=nx>wresp</span><span class=p>.</span><span class=nx>CompactRevision</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>			<span class=nx>wr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Header</span><span class=p>:</span>          <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>Revision</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>WatchId</span><span class=p>:</span>         <span class=nb>int64</span><span class=p>(</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Events</span><span class=p>:</span>          <span class=nx>events</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>CompactRevision</span><span class=p>:</span> <span class=nx>wresp</span><span class=p>.</span><span class=nx>CompactRevision</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Canceled</span><span class=p>:</span>        <span class=nx>canceled</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>okID</span> <span class=o>:=</span> <span class=nx>ids</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>];</span> <span class=p>!</span><span class=nx>okID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// buffer if id not yet announced
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>wrs</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>pending</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>],</span> <span class=nx>wr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>pending</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>wrs</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>mvcc</span><span class=p>.</span><span class=nf>ReportEventReceived</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>evs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>fragmented</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>fragment</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>serr</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>fragmented</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>serr</span> <span class=p>=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>wr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>serr</span> <span class=p>=</span> <span class=nf>sendFragments</span><span class=p>(</span><span class=nx>wr</span><span class=p>,</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>maxRequestBytes</span><span class=p>,</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nx>Send</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>serr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nf>isClientCtxErr</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Err</span><span class=p>(),</span> <span class=nx>serr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;failed to send watch response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>serr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;failed to send watch response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>serr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nx>streamFailures</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;send&#34;</span><span class=p>,</span> <span class=s>&#34;watch&#34;</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>evs</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// elide next progress update if sent a key update
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>c</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>c</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nf>isClientCtxErr</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Err</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;failed to send watch control response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;failed to send watch control response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nx>streamFailures</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;send&#34;</span><span class=p>,</span> <span class=s>&#34;watch&#34;</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// track id creation
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>wid</span> <span class=o>:=</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>WatchId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Canceled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>delete</span><span class=p>(</span><span class=nx>ids</span><span class=p>,</span> <span class=nx>wid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Created</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// flush buffered events
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>ids</span><span class=p>[</span><span class=nx>wid</span><span class=p>]</span> <span class=p>=</span> <span class=kd>struct</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pending</span><span class=p>[</span><span class=nx>wid</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>mvcc</span><span class=p>.</span><span class=nf>ReportEventReceived</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>v</span><span class=p>.</span><span class=nx>Events</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>v</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nf>isClientCtxErr</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Err</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;failed to send pending watch response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;failed to send pending watch response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>							<span class=nx>streamFailures</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;send&#34;</span><span class=p>,</span> <span class=s>&#34;watch&#34;</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nb>delete</span><span class=p>(</span><span class=nx>pending</span><span class=p>,</span> <span class=nx>wid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>progressTicker</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>RequestProgress</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>closec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>代码比较多，先看个大概流程：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>wresp</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Chan</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>c</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>progressTicker</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>closec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></div><p>这样就比较清晰了，for + select 的常规套路。</p><p>4个 case 中，最后一个 case 为 channel 关闭时的逻辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>closec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span></code></pre></div><p>channel 关闭后就直接退出循环，比较好理解。</p><p>倒数第二个 case 为一个定时器，主要用于维护 watcher 的进度（可以看做是类似心跳的东西）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>progressTicker</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>RequestProgress</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span></code></pre></div><p>因为如果 watch 的 key没有任何变化，那么 watcher 就不会收到任何消息，因为没有新的事件产生。因此 etcd 中 添加了 progress request，定时发送一个进度信息给 watcher，让 watcher 在没有事件产生的时候也能收到一些消息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 如果有新的 event 产生，就把 progress 改成 fasle 以忽略掉下次进度更新消息的发送
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>evs</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>具体如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>watchableStore</span><span class=p>)</span> <span class=nf>progress</span><span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>synced</span><span class=p>.</span><span class=nx>watchers</span><span class=p>[</span><span class=nx>w</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>send</span><span class=p>(</span><span class=nx>WatchResponse</span><span class=p>{</span><span class=nx>WatchID</span><span class=p>:</span> <span class=nx>w</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>Revision</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nf>rev</span><span class=p>()})</span>
</span></span><span class=line><span class=cl>		<span class=c1>// If the ch is full, this watcher is receiving events.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// We do not need to send progress at all.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到，只是会把当前收到的 Revision 发送过去，并不包含任何 event。</p><p>查了下，发送这个功能差不多也是为 Kubernetes 服务的，具体见<a href=https://github.com/etcd-io/etcd/issues/9855 target=_blank rel="noopener noreffer">#9855</a>和<a href=https://github.com/kubernetes/kubernetes/issues/73585 target=_blank rel="noopener noreffer">#73585</a>。</p><p>第一个 case 才是 sendLoop 的核心逻辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 从 chan 中取出 event 
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=nx>wresp</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Chan</span><span class=p>():</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>evs</span> <span class=o>:=</span> <span class=nx>wresp</span><span class=p>.</span><span class=nx>Events</span>
</span></span><span class=line><span class=cl>			<span class=nx>events</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>mvccpb</span><span class=p>.</span><span class=nx>Event</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>evs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>needPrevKV</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>prevKV</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>evs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>events</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>evs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>needPrevKV</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nf>IsCreateEvent</span><span class=p>(</span><span class=nx>evs</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>opt</span> <span class=o>:=</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nx>RangeOptions</span><span class=p>{</span><span class=nx>Rev</span><span class=p>:</span> <span class=nx>evs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Kv</span><span class=p>.</span><span class=nx>ModRevision</span> <span class=o>-</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>watchable</span><span class=p>.</span><span class=nf>Range</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>evs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Kv</span><span class=p>.</span><span class=nx>Key</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>opt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>KVs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>events</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>PrevKv</span> <span class=p>=</span> <span class=o>&amp;</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>KVs</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>canceled</span> <span class=o>:=</span> <span class=nx>wresp</span><span class=p>.</span><span class=nx>CompactRevision</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>			<span class=nx>wr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Header</span><span class=p>:</span>          <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>Revision</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>WatchId</span><span class=p>:</span>         <span class=nb>int64</span><span class=p>(</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Events</span><span class=p>:</span>          <span class=nx>events</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>CompactRevision</span><span class=p>:</span> <span class=nx>wresp</span><span class=p>.</span><span class=nx>CompactRevision</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Canceled</span><span class=p>:</span>        <span class=nx>canceled</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果 watcherID 还没注册到 ids 列表中，就先把这个 event 缓存起来
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>okID</span> <span class=o>:=</span> <span class=nx>ids</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>];</span> <span class=p>!</span><span class=nx>okID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// buffer if id not yet announced
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>wrs</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>pending</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>],</span> <span class=nx>wr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>pending</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>wrs</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>mvcc</span><span class=p>.</span><span class=nf>ReportEventReceived</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>evs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>fragmented</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>fragment</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>serr</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 然后发送给 client
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>!</span><span class=nx>fragmented</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>serr</span> <span class=p>=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>wr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>serr</span> <span class=p>=</span> <span class=nf>sendFragments</span><span class=p>(</span><span class=nx>wr</span><span class=p>,</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>maxRequestBytes</span><span class=p>,</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nx>Send</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>serr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nf>isClientCtxErr</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Err</span><span class=p>(),</span> <span class=nx>serr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;failed to send watch response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>serr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;failed to send watch response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>serr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nx>streamFailures</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;send&#34;</span><span class=p>,</span> <span class=s>&#34;watch&#34;</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>evs</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// elide next progress update if sent a key update
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>wresp</span><span class=p>.</span><span class=nx>WatchID</span><span class=p>]</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span></code></pre></div><p>一个大的 for 循环不断从 watchStream chan 中获取 event，并转发给 client。如果对应的 watcherID 还有注册到 ids 列表中就先将这些 event 缓存起来。</p><blockquote><p>因为是先在 recvLoop 中创建了 watcher，然后通过消息异步将 watchID 注册到 sendLoop 的 ids 列表中的，所以可能会出现 event 产生了但是 id 还没注册的情况。</p></blockquote><p>根据流程图可以知道，这个 watchStream.Chan() 是 MVCC 模块中的，当 WatchableKV 有更新时会通知 WatchStream，然后 sendLoop 取出消息并发送给 client。</p><p>第二个 case 为控制逻辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>c</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>c</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nf>isClientCtxErr</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Err</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;failed to send watch control response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;failed to send watch control response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nx>streamFailures</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;send&#34;</span><span class=p>,</span> <span class=s>&#34;watch&#34;</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// track id creation
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>wid</span> <span class=o>:=</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>WatchId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果是被取消了，就从ids中移除
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Canceled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>delete</span><span class=p>(</span><span class=nx>ids</span><span class=p>,</span> <span class=nx>wid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果创建则把 watcherID 注册到 ids 列表中，然后把缓存的event都发送到 client
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Created</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// flush buffered events
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>ids</span><span class=p>[</span><span class=nx>wid</span><span class=p>]</span> <span class=p>=</span> <span class=kd>struct</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pending</span><span class=p>[</span><span class=nx>wid</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>mvcc</span><span class=p>.</span><span class=nf>ReportEventReceived</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>v</span><span class=p>.</span><span class=nx>Events</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>v</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nf>isClientCtxErr</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Err</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;failed to send pending watch response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>sws</span><span class=p>.</span><span class=nx>lg</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;failed to send pending watch response to gRPC stream&#34;</span><span class=p>,</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>							<span class=nx>streamFailures</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;send&#34;</span><span class=p>,</span> <span class=s>&#34;watch&#34;</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nb>delete</span><span class=p>(</span><span class=nx>pending</span><span class=p>,</span> <span class=nx>wid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span></code></pre></div><p>主要包括了 watcher 的 create 和 cancel。</p><ul><li>cancel 则是将 watcherID 从 ids 列表中移除</li><li>create 则是将 watcherID 注册到 ids 列表中，并把之前缓存的消息（如果有的话）全部发送给 client。</li></ul><p>这个控制逻辑消息由 recvLoop 产生，recvLoop 收到用户发送的 create 或者 cancel 请求后先调用 watchStream 的方法 create 或者 cancel watcher，然后在通过 chan 异步传递到 sendLoop 中，以维护 sendLoop 中的活跃watcherID 列表。</p><h2 id=4-recvloop>4. recvLoop</h2><p>recvLoop 主要负责接收 client 的 create/cancel watcher 请求。</p><p>具体如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/etcdserver/api/v3rpc/watch.go 238行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>sws</span> <span class=o>*</span><span class=nx>serverWatchStream</span><span class=p>)</span> <span class=nf>recvLoop</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>uv</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>RequestUnion</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_CreateRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>CreateRequest</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>creq</span> <span class=o>:=</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>CreateRequest</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>creq</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>creq</span><span class=p>.</span><span class=nx>Key</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{</span><span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>sws</span><span class=p>.</span><span class=nf>isWatchPermitted</span><span class=p>(</span><span class=nx>creq</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>wr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Header</span><span class=p>:</span>       <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Rev</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>WatchId</span><span class=p>:</span>      <span class=nx>creq</span><span class=p>.</span><span class=nx>WatchId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Canceled</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Created</span><span class=p>:</span>      <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>CancelReason</span><span class=p>:</span> <span class=nx>rpctypes</span><span class=p>.</span><span class=nx>ErrGRPCPermissionDenied</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span> <span class=o>&lt;-</span> <span class=nx>wr</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>closec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>filters</span> <span class=o>:=</span> <span class=nf>FiltersFromRequest</span><span class=p>(</span><span class=nx>creq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>wsrev</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Rev</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>rev</span> <span class=o>:=</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>StartRevision</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>rev</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>rev</span> <span class=p>=</span> <span class=nx>wsrev</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Watch</span><span class=p>(</span><span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>creq</span><span class=p>.</span><span class=nx>WatchId</span><span class=p>),</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>Key</span><span class=p>,</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span><span class=p>,</span> <span class=nx>rev</span><span class=p>,</span> <span class=nx>filters</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>ProgressNotify</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>PrevKv</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>prevKV</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>Fragment</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>fragment</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>wr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Header</span><span class=p>:</span>   <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>wsrev</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>WatchId</span><span class=p>:</span>  <span class=nb>int64</span><span class=p>(</span><span class=nx>id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Created</span><span class=p>:</span>  <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Canceled</span><span class=p>:</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>wr</span><span class=p>.</span><span class=nx>CancelReason</span> <span class=p>=</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span> <span class=o>&lt;-</span> <span class=nx>wr</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>closec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_CancelRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>CancelRequest</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>id</span> <span class=o>:=</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>CancelRequest</span><span class=p>.</span><span class=nx>WatchId</span>
</span></span><span class=line><span class=cl>				<span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Cancel</span><span class=p>(</span><span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>Header</span><span class=p>:</span>   <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Rev</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>						<span class=nx>WatchId</span><span class=p>:</span>  <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=nx>Canceled</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=nb>delete</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>,</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nb>delete</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>prevKV</span><span class=p>,</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nb>delete</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>fragment</span><span class=p>,</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_ProgressRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>ProgressRequest</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Header</span><span class=p>:</span>  <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Rev</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>WatchId</span><span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=c1>// response is not associated with any WatchId and will be broadcast to all watch channels
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>同样也是先看下大致逻辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>req</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>gRPCStream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=nx>uv</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>RequestUnion</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_CreateRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_CancelRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_ProgressRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>可以看出主要是接收 client 的请求，然后根据请求类型做不同处理。</p><p>create 请求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_CreateRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>CreateRequest</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 组装参数
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>creq</span> <span class=o>:=</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>CreateRequest</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>creq</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// \x00 is the smallest key
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>creq</span><span class=p>.</span><span class=nx>Key</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{</span><span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// force nil since watchstream.Watch distinguishes
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// between nil and []byte{} for single key / &gt;=
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// support  &gt;= key queries
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 校验是否能够执行 watch 请求，主要是判断用户有没有操作这个key的权限
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>!</span><span class=nx>sws</span><span class=p>.</span><span class=nf>isWatchPermitted</span><span class=p>(</span><span class=nx>creq</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 如果没有权限就发送一个同时携带 Created 和 Canceled 标记的消息给前面的 sendLoop
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>wr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Header</span><span class=p>:</span>       <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Rev</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>WatchId</span><span class=p>:</span>      <span class=nx>creq</span><span class=p>.</span><span class=nx>WatchId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Canceled</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Created</span><span class=p>:</span>      <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>CancelReason</span><span class=p>:</span> <span class=nx>rpctypes</span><span class=p>.</span><span class=nx>ErrGRPCPermissionDenied</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span> <span class=o>&lt;-</span> <span class=nx>wr</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>closec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 若有权限则发送一个带 Created  标记的消息给前面的 sendLoop，以创建 watcher
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>filters</span> <span class=o>:=</span> <span class=nf>FiltersFromRequest</span><span class=p>(</span><span class=nx>creq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>wsrev</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Rev</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>rev</span> <span class=o>:=</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>StartRevision</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>rev</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>rev</span> <span class=p>=</span> <span class=nx>wsrev</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 创建一个 watcher，并返回其 id
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Watch</span><span class=p>(</span><span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>creq</span><span class=p>.</span><span class=nx>WatchId</span><span class=p>),</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>Key</span><span class=p>,</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>RangeEnd</span><span class=p>,</span> <span class=nx>rev</span><span class=p>,</span> <span class=nx>filters</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>ProgressNotify</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>PrevKv</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>prevKV</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>creq</span><span class=p>.</span><span class=nx>Fragment</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>fragment</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>wr</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Header</span><span class=p>:</span>   <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>wsrev</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>WatchId</span><span class=p>:</span>  <span class=nb>int64</span><span class=p>(</span><span class=nx>id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Created</span><span class=p>:</span>  <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Canceled</span><span class=p>:</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>wr</span><span class=p>.</span><span class=nx>CancelReason</span> <span class=p>=</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span> <span class=o>&lt;-</span> <span class=nx>wr</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>sws</span><span class=p>.</span><span class=nx>closec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span></code></pre></div><p>解析请求，组装参数和权限校验，然后调用 watchStream 的方法创建一个 watcher，并发送消息给 sendLoop 使其将 watcherID 注册到自己的 watcherID 列表中。</p><blockquote><p>注意这里调用<code>sws.watchStream.Watch()</code>就已经创建好 watcher 了，通过消息发送到 sendLoop 只是为了将 watcherID 注册到 sendLoop 的 ids 列表中而已。</p><p>因为 sendLoop 只会把关注在自己的 ids 列表中的 watcher</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/storage/mvcc/watcher.go 108行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ws</span> <span class=o>*</span><span class=nx>watchStream</span><span class=p>)</span> <span class=nf>Watch</span><span class=p>(</span><span class=nx>id</span> <span class=nx>WatchID</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>end</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>startRev</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>fcs</span> <span class=o>...</span><span class=nx>FilterFunc</span><span class=p>)</span> <span class=p>(</span><span class=nx>WatchID</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>end</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>Compare</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>end</span><span class=p>)</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=nx>ErrEmptyWatcherRange</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>closed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=nx>ErrEmptyWatcherRange</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>id</span> <span class=o>==</span> <span class=nx>AutoWatchID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>watchers</span><span class=p>[</span><span class=nx>ws</span><span class=p>.</span><span class=nx>nextID</span><span class=p>]</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ws</span><span class=p>.</span><span class=nx>nextID</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>id</span> <span class=p>=</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>nextID</span>
</span></span><span class=line><span class=cl>		<span class=nx>ws</span><span class=p>.</span><span class=nx>nextID</span><span class=o>++</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>watchers</span><span class=p>[</span><span class=nx>id</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=nx>ErrWatcherDuplicateID</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 可以看到这里直接调用了 MVCC模块中的watchable 的 watch 方法来创建 watcher 了
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>w</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>watchable</span><span class=p>.</span><span class=nf>watch</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>end</span><span class=p>,</span> <span class=nx>startRev</span><span class=p>,</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>ch</span><span class=p>,</span> <span class=nx>fcs</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ws</span><span class=p>.</span><span class=nx>cancels</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=nx>c</span>
</span></span><span class=line><span class=cl>	<span class=nx>ws</span><span class=p>.</span><span class=nx>watchers</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=nx>w</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>id</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里就已经在 MVCC 中创建了 watcher，并存到 watchStream.watchers 中。</p><p>具体 watch 实现如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// server/storage/mvcc/watchable_store.go 106行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>watchableStore</span><span class=p>)</span> <span class=nf>watch</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>end</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>startRev</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>id</span> <span class=nx>WatchID</span><span class=p>,</span> <span class=nx>ch</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=nx>WatchResponse</span><span class=p>,</span> <span class=nx>fcs</span> <span class=o>...</span><span class=nx>FilterFunc</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>watcher</span><span class=p>,</span> <span class=nx>cancelFunc</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>wa</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>watcher</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>key</span><span class=p>:</span>    <span class=nx>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>end</span><span class=p>:</span>    <span class=nx>end</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>minRev</span><span class=p>:</span> <span class=nx>startRev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>id</span><span class=p>:</span>     <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ch</span><span class=p>:</span>     <span class=nx>ch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>fcs</span><span class=p>:</span>    <span class=nx>fcs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>revMu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>synced</span> <span class=o>:=</span> <span class=nx>startRev</span> <span class=p>&gt;</span> <span class=nx>s</span><span class=p>.</span><span class=nx>store</span><span class=p>.</span><span class=nx>currentRev</span> <span class=o>||</span> <span class=nx>startRev</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>synced</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>wa</span><span class=p>.</span><span class=nx>minRev</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>store</span><span class=p>.</span><span class=nx>currentRev</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>startRev</span> <span class=p>&gt;</span> <span class=nx>wa</span><span class=p>.</span><span class=nx>minRev</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>wa</span><span class=p>.</span><span class=nx>minRev</span> <span class=p>=</span> <span class=nx>startRev</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>synced</span><span class=p>.</span><span class=nf>add</span><span class=p>(</span><span class=nx>wa</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>slowWatcherGauge</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>unsynced</span><span class=p>.</span><span class=nf>add</span><span class=p>(</span><span class=nx>wa</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>revMu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>watcherGauge</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>wa</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nx>s</span><span class=p>.</span><span class=nf>cancelWatcher</span><span class=p>(</span><span class=nx>wa</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Cancel 请求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_CancelRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>CancelRequest</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>id</span> <span class=o>:=</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>CancelRequest</span><span class=p>.</span><span class=nx>WatchId</span>
</span></span><span class=line><span class=cl>				<span class=nx>err</span> <span class=o>:=</span> <span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Cancel</span><span class=p>(</span><span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>Header</span><span class=p>:</span>   <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Rev</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>						<span class=nx>WatchId</span><span class=p>:</span>  <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=nx>Canceled</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=nb>delete</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>progress</span><span class=p>,</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nb>delete</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>prevKV</span><span class=p>,</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nb>delete</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>fragment</span><span class=p>,</span> <span class=nx>mvcc</span><span class=p>.</span><span class=nf>WatchID</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nx>sws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span></code></pre></div><p>cancel 请求则比较简单， 先调用 watchStream.Cancel() 把 watcher cancel 掉，然后从 serverWatchStream 的几个 map 中移除掉对应数据，并发送一个带 Canceled 标记的消息给 sendLoop 以同步watcherID列表。</p><p>具体 watchStream.Cancel 实现如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>ws</span> <span class=o>*</span><span class=nx>watchStream</span><span class=p>)</span> <span class=nf>Cancel</span><span class=p>(</span><span class=nx>id</span> <span class=nx>WatchID</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>cancel</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>cancels</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>watchers</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=nx>ok</span> <span class=p>=</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>ws</span><span class=p>.</span><span class=nx>closed</span>
</span></span><span class=line><span class=cl>	<span class=nx>ws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ErrWatcherNotExist</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>ww</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>watchers</span><span class=p>[</span><span class=nx>id</span><span class=p>];</span> <span class=nx>ww</span> <span class=o>==</span> <span class=nx>w</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>delete</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nx>cancels</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>delete</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nx>watchers</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>ws</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>同样是，从列表中把对应的 id 移除。</p><p>progress 请求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchRequest_ProgressRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>uv</span><span class=p>.</span><span class=nx>ProgressRequest</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>sws</span><span class=p>.</span><span class=nx>ctrlStream</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>WatchResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Header</span><span class=p>:</span>  <span class=nx>sws</span><span class=p>.</span><span class=nf>newResponseHeader</span><span class=p>(</span><span class=nx>sws</span><span class=p>.</span><span class=nx>watchStream</span><span class=p>.</span><span class=nf>Rev</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>WatchId</span><span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=c1>// response is not associated with any WatchId and will be broadcast to all watch channels
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span></code></pre></div><p>这里就只是更新进度，不带任何标记，只是借助 sendLoop 发送一个进度消息发送给 client。</p><h2 id=5-小结>5. 小结</h2><p><strong>sendLoop</strong> 主要接收两种消息：</p><ul><li>1） watchStream 推送的 event 消息，sendLoop 收到后并转发给 client</li><li>2）recvLoop 发来的 control 消息，包括watcher的create或者cancel，用以维护活跃 watcher 列表</li></ul><p><strong>recvLoop</strong> 则负责接收 client 的请求：</p><ul><li>1）接收 client 的create/cancel watcher 消息，并调用 watchStream 的对应方法 create/cancel watcher</li><li>2）最后通过 ctlStream 和 sendLoop 进行通信，以维护 sendLoop 中的活跃 watchID 列表。</li></ul><blockquote><p>至此上篇结束，剩下的部分在下篇 <a href=https://www.lixueduan.com/post/etcd/14-watch-analyze-2/ target=_blank rel="noopener noreffer">etcd教程(十四)&mdash;watch 机制源码分析（下）</a>。</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-01-21</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.yudlk.com/posts/etcd/13-watch-analyze-1/ data-title="etcd教程(十三)---watch 机制源码分析（上）" data-hashtags=etcd><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.yudlk.com/posts/etcd/13-watch-analyze-1/ data-hashtag=etcd><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.yudlk.com/posts/etcd/13-watch-analyze-1/ data-title="etcd教程(十三)---watch 机制源码分析（上）"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.yudlk.com/posts/etcd/13-watch-analyze-1/ data-title="etcd教程(十三)---watch 机制源码分析（上）"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.yudlk.com/posts/etcd/13-watch-analyze-1/ data-title="etcd教程(十三)---watch 机制源码分析（上）"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/etcd/>etcd</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/etcd/12-mvcc-analyze/ class=prev rel=prev title="etcd教程(十二)---etcd mvcc 源码分析"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>etcd教程(十二)---etcd mvcc 源码分析</a>
<a href=/posts/etcd/14-watch-analyze-2/ class=next rel=next title="etcd教程(十四)---watch 机制源码分析（下）">etcd教程(十四)---watch 机制源码分析（下）<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/barrypt target=_blank>qpt</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.480e58b2c2a8605d406f34667e92ff8f1ae50cfee5b653bead570f004839a983.js integrity="sha256-SA5YssKoYF1AbzRmfpL/jxrlDP7ltlO+rVcPAEg5qYM="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-FL23FNP7CM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-FL23FNP7CM" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b7c98449a6edf8492a8f3404e6d06a0",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7693630257897132" crossorigin=anonymous></script></body></html>