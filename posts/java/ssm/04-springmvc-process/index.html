<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>SSM系列(四)---SpringMVC执行流程分析 -</title><meta name=Description content="通过源码分析SpringMVC 框架执行流程"><meta property="og:title" content="SSM系列(四)---SpringMVC执行流程分析"><meta property="og:description" content="通过源码分析SpringMVC 框架执行流程"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.yudlk.com/posts/java/ssm/04-springmvc-process/"><meta property="og:image" content="https://blog.yudlk.com/img/jinx.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-17T00:00:00+00:00"><meta property="article:modified_time" content="2018-10-17T00:00:00+00:00"><meta property="og:site_name" content="qpt的个人博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.yudlk.com/img/jinx.png"><meta name=twitter:title content="SSM系列(四)---SpringMVC执行流程分析"><meta name=twitter:description content="通过源码分析SpringMVC 框架执行流程"><meta name=application-name content="指月小筑"><meta name=apple-mobile-web-app-title content="指月小筑"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.yudlk.com/posts/java/ssm/04-springmvc-process/><link rel=prev href=https://blog.yudlk.com/posts/java/ssm/03-beanfactory-applicationcontext-diff/><link rel=next href=https://blog.yudlk.com/posts/java/ssm/05-mybatis/><link rel=stylesheet href=/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"SSM系列(四)---SpringMVC执行流程分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.yudlk.com\/posts\/java\/ssm\/04-springmvc-process\/"},"image":["https:\/\/blog.yudlk.com\/img\/jinx.png"],"genre":"posts","keywords":"SpringMVC","wordcount":10690,"url":"https:\/\/blog.yudlk.com\/posts\/java\/ssm\/04-springmvc-process\/","datePublished":"2018-10-17T00:00:00+00:00","dateModified":"2018-10-17T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"qpt"},"description":"通过源码分析SpringMVC 框架执行流程"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title>指月小筑</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=指月小筑>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/ title=关于>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title>指月小筑</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title=指月小筑>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">SSM系列(四)---SpringMVC执行流程分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/lixd title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>qpt</a></span>&nbsp;<span class=post-category>included in <a href=/categories/java/><i class="far fa-folder fa-fw" aria-hidden=true></i>Java</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2018-10-17>2018-10-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;10690 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;22 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-servlet-执行流程>1. Servlet 执行流程</a></li><li><a href=#2-springmvc-执行流程>2. SpringMVC 执行流程</a><ul><li><a href=#运行过程分析>运行过程分析</a></li></ul></li><li><a href=#3-具体过程分析>3. 具体过程分析</a><ul><li><a href=#1-建立-mapurlscontroller-的关系>1. 建立 Map&lt;urls,Controller> 的关系</a></li><li><a href=#2根据访问url-找到对应-controller-中处理请求的方法>2.根据访问url 找到对应 Controller 中处理请求的方法</a></li><li><a href=#3-参数绑定>3. 参数绑定</a></li></ul></li><li><a href=#4-源码分析>4. 源码分析</a><ul><li><a href=#1-建立mapurlcontroller的关系>1. 建立Map&lt;url,controller>的关系</a></li><li><a href=#2-根据访问url找到对应controller中处理请求的方法>2. 根据访问url找到对应controller中处理请求的方法</a></li><li><a href=#3-反射调用处理请求的方法返回结果视图>3. 反射调用处理请求的方法,返回结果视图</a></li><li><a href=#4-参数绑定>4. 参数绑定</a></li><li><a href=#5-反射源码分析>5. 反射源码分析</a></li></ul></li><li><a href=#5-小结>5. 小结</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><p>本文主要通过源码详细分析了 SpringMVC 框架的执行流程，包括建立 url 和 controller 的关系，通过 url 找到具体的方法，通过反射执行 controller 中的方法等。</p><h2 id=1-servlet-执行流程>1. Servlet 执行流程</h2><p>传统servlet的执行过程分为如下几步：</p><p>1、浏览器向服务器发送请求<code>http://localhost:8080/demo/hello</code></p><p>2、服务器接受到请求，并从地址中得到项目名称<code>webproject</code></p><p>3、然后再从地址中找到名称<code>hello</code>，并与<code>webproject</code>下的<code>web.xml</code>文件进行匹配</p><p>4、在<code>web.xml</code>中找到一个<code> &lt;url-pattern>hello&lt;/url-pattern></code>的标签，并且通过他找到<code>servlet-name</code>进而找到<code>&lt;servlet-class></code></p><p>5、再拿到<code>servlet-class</code>之后，这个服务器便知道了这个<code>servlet</code>的全类名，通过<code>反射</code>创建这个类的对象，并且调用<code>doGet/doPost</code>方法</p><p>6、方法执行完毕，结果返回到浏览器。结束。</p><h2 id=2-springmvc-执行流程>2. SpringMVC 执行流程</h2><p>SpringMVC 中也配置了一个 Servlet,配置的是 org.springframework.web.servlet.DispatcherServlet，所有的请求过来都会找这个 servlet (前端控制器)，DispatcherServlet 继承了 HttpServlet。</p><h3 id=运行过程分析>运行过程分析</h3><p>1、 用户发送请求至前端控制器<code>DispatcherServlet</code>。</p><p>2、 <code>DispatcherServlet</code>收到请求调用<code>HandlerMapping</code>处理器映射器。</p><p>3、 处理器映射器找到具体的处理器(可以根据xml配置、注解进行查找)，生成处理器对象及处理器拦截器(如果有则生成)<code>HandlerExcutorChain</code>并返回给 DispatcherServlet。</p><p>4、 <code>DispatcherServlet</code>调用<code>HandlerAdapter</code>处理器适配器。</p><p>5、 <code>HandlerAdapter</code>经过适配调用具体的处理器(就是我们写的 Controller )。</p><p>6、 <code>Controller</code>执行完成返回<code>ModelAndView</code>。</p><p>7、 <code>HandlerAdapter</code>将 Controller 执行结果<code>ModelAndView</code>返回给<code>DispatcherServlet</code>。</p><p>8、 <code>DispatcherServlet</code>将 ModelAndView 传给<code>ViewReslover</code>视图解析器。</p><p>9、 <code>ViewReslover</code>解析后返回具体<code>View</code>(这就是为什么<code>reurn "index"</code>会自动找到 index.html)</p><p>10、<code>DispatcherServle</code>t根据<code>View</code>进行渲染视图（即将模型数据填充至视图中）。</p><p>11、 DispatcherServlet响应用户。</p><h2 id=3-具体过程分析>3. 具体过程分析</h2><h3 id=1-建立-mapurlscontroller-的关系>1. 建立 Map&lt;urls,Controller> 的关系</h3><h4 id=概述>概述</h4><p>在容器初始化时会建立所有<code>url</code> 和 <code>controller</code>的对应关系,保存到<code>Map&lt;url,controller></code>中。</p><p><code>DispatcherServlet-->initApplicationContext</code>初始化容器 建立<code>Map&lt;url,controller></code>关系的部分</p><p>Tomcat启动时会通知 Spring 初始化容器(加载 bean 的定义信息和初始化所有单例 bean ),然后 SpringMVC 会遍历容器中的bean,获取每一个 Controller 中的所有方法访问的 url,然后将 url和 Controller 保存到一个 Map 中;</p><h3 id=2根据访问url-找到对应-controller-中处理请求的方法>2.根据访问url 找到对应 Controller 中处理请求的方法</h3><h4 id=概述-1>概述</h4><p><code>DispatcherServlet-->doDispatch()</code></p><p>有了前面的 Map 就可以根据 Request快速定位到 Controller,因为最终处理 Request 的是 Controller 中的方法,Map 中只保留了 url 和 Controller 中的对应关系,所以要根据 Request 的 url 进一步确认 Controller 中的 Method.</p><h4 id=原理>原理</h4><p>这一步工作的原理就是拼接 Controller 的 url(controller上@RequestMapping的值) 和方法的 url(method 上@RequestMapping的值),与 Request 的 url 进行匹配,找到匹配的那个方法;　　</p><h3 id=3-参数绑定>3. 参数绑定</h3><p>确定处理请求的 Method 后,接下来的任务就是参数绑定,把 Request 中参数绑定到方法的形式参数上,这一步是整个请求处理过程中最复杂的一个步骤。SpringMVC 提供了两种 Request 参数与方法形参的绑定方法:</p><h4 id=注解>注解</h4><p>使用注解进行绑定,我们只要在方法参数前面声明 <code>@RequestParam("a")</code>,就可以将 <code>Request</code> 中参数 <code>a</code> 的值绑定到方法的该参数上。</p><h4 id=参数名称>参数名称</h4><p>使用参数名称进行绑定的前提是必须要获取方法中参数的名称,Java 反射只提供了获取方法的参数的类型,并没有提供获取参数名称的方法。SpringMVC 解决这个问题的方法是用 asm 框架读取字节码文件,来获取方法的参数名称。asm 框架是一个字节码操作框架,关于a sm 更多介绍可以参考它的官网。</p><p>个人建议,使用注解来完成参数绑定,这样就可以省去 asm 框架的读取字节码的操作。</p><h2 id=4-源码分析>4. 源码分析</h2><h3 id=1-建立mapurlcontroller的关系>1. 建立Map&lt;url,controller>的关系</h3><p>我们首先看第一个步骤,也就是建立<code>Map&lt;url,controller></code>关系的部分.第一部分的入口类<code>ApplicationObjectSupport</code>的<code>setApplicationContext</code>方法.<code>setApplicationContext</code>方法中核心部分就是初始化容器<code>initApplicationContext(context)</code>,子类<code>AbstractDetectingUrlHandlerMapping</code>实现了该方法,所以我们直接看子类中的初始化容器方法.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//ApplicationObjectSupport类
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>setApplicationContext</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>ApplicationContext</span> <span class=n>context</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>BeansException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>context</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isContextRequired</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Reset internal context state.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>this</span><span class=o>.</span><span class=na>applicationContext</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>messageSourceAccessor</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>applicationContext</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Initialize with passed-in context.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=o>(!</span><span class=n>requiredContextClass</span><span class=o>().</span><span class=na>isInstance</span><span class=o>(</span><span class=n>context</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=k>new</span> <span class=n>ApplicationContextException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;Invalid application context: needs to be of type [&#34;</span> <span class=o>+</span> <span class=n>requiredContextClass</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>messageSourceAccessor</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageSourceAccessor</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>initApplicationContext</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Ignore reinitialization if same context passed in.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>applicationContext</span> <span class=o>!=</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=k>new</span> <span class=n>ApplicationContextException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;Cannot reinitialize with different application context: current one is [&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>						<span class=k>this</span><span class=o>.</span><span class=na>applicationContext</span> <span class=o>+</span> <span class=s>&#34;], passed-in one is [&#34;</span> <span class=o>+</span> <span class=n>context</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span></code></pre></div><p>其中<code>initApplicationContext(context)</code>由子类<code>AbstractDetectingUrlHandlerMapping</code>实现,具体如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Calls the {@link #detectHandlers()} method in addition to the
</span></span></span><span class=line><span class=cl><span class=cm>	 * superclass&#39;s initialization.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>initApplicationContext</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>ApplicationContextException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>super</span><span class=o>.</span><span class=na>initApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=n>detectHandlers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/** 建立当前ApplicationContext中的所有controller和url的对应关系
</span></span></span><span class=line><span class=cl><span class=cm>	 * Register all handlers found in the current ApplicationContext.
</span></span></span><span class=line><span class=cl><span class=cm>	 * &lt;p&gt;The actual URL determination for a handler is up to the concrete
</span></span></span><span class=line><span class=cl><span class=cm>	 * {@link #determineUrlsForHandler(String)} implementation. A bean for
</span></span></span><span class=line><span class=cl><span class=cm>	 * which no such URLs could be determined is simply not considered a handler.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @throws org.springframework.beans.BeansException if the handler couldn&#39;t be registered
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see #determineUrlsForHandler(String)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>detectHandlers</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>BeansException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>ApplicationContext</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>obtainApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=n>String</span><span class=o>[]</span> <span class=n>beanNames</span> <span class=o>=</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>detectHandlersInAncestorContexts</span> <span class=o>?</span>
</span></span><span class=line><span class=cl>				<span class=n>BeanFactoryUtils</span><span class=o>.</span><span class=na>beanNamesForTypeIncludingAncestors</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>,</span> <span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>applicationContext</span><span class=o>.</span><span class=na>getBeanNamesForType</span><span class=o>(</span><span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取ApplicationContext容器中所有bean的Name
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// Take any bean name that we can determine URLs for.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 遍历beanNames,并找到这些bean对应的url
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>beanName</span> <span class=o>:</span> <span class=n>beanNames</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		     <span class=c1>// 找bean上的所有url(controller上的url+方法上的url),该方法由对应的子类实现
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>String</span><span class=o>[]</span> <span class=n>urls</span> <span class=o>=</span> <span class=n>determineUrlsForHandler</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(!</span><span class=n>ObjectUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>urls</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// URL paths found: Let&#39;s consider it a handler.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 保存urls和beanName的对应关系,put it to Map&lt;urls,beanName&gt;,该方法在父类AbstractUrlHandlerMapping中实现
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>registerHandler</span><span class=o>(</span><span class=n>urls</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>((</span><span class=n>logger</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>getHandlerMap</span><span class=o>().</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>||</span> <span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>logger</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Detected &#34;</span> <span class=o>+</span> <span class=n>getHandlerMap</span><span class=o>().</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; mappings in &#34;</span> <span class=o>+</span> <span class=n>formatMappingName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>       
</span></span><span class=line><span class=cl>		<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    	 * Determine the URLs for the given handler bean.
</span></span></span><span class=line><span class=cl><span class=cm>    	 * @param beanName the name of the candidate bean
</span></span></span><span class=line><span class=cl><span class=cm>    	 * @return the URLs determined for the bean, or an empty array if none
</span></span></span><span class=line><span class=cl><span class=cm>    	 */</span>
</span></span><span class=line><span class=cl>		    <span class=cm>/** 获取controller中所有方法的url,由子类实现,典型的模板模式 **/</span>
</span></span><span class=line><span class=cl>    	<span class=kd>protected</span> <span class=kd>abstract</span> <span class=n>String</span><span class=o>[]</span> <span class=nf>determineUrlsForHandler</span><span class=o>(</span><span class=n>String</span> <span class=n>beanName</span><span class=o>);</span>
</span></span></code></pre></div><p><code>determineUrlsForHandler(String beanName)</code>方法的作用是获取每个<code>Controller</code>中的<code>url</code>,不同的子类有不同的实现,这是一个典型的模板设计模式.因为开发中我们用的最多的就是用注解来配置<code>Controller``中的url</code>,<code>BeanNameUrlHandlerMapping</code>是<code>AbstractDetectingUrlHandlerMapping</code>的子类,我们看<code>BeanNameUrlHandlerMapping</code>是如何查<code>beanName</code>上所有映射的<code>url</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BeanNameUrlHandlerMapping</span> <span class=kd>extends</span> <span class=n>AbstractDetectingUrlHandlerMapping</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Checks name and aliases of the given bean for URLs, starting with &#34;/&#34;.
</span></span></span><span class=line><span class=cl><span class=cm>	 * 找出名字或者别名是以 / 开头的bean
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>protected</span> <span class=n>String</span><span class=o>[]</span> <span class=nf>determineUrlsForHandler</span><span class=o>(</span><span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>urls</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>beanName</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;/&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>urls</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=n>String</span><span class=o>[]</span> <span class=n>aliases</span> <span class=o>=</span> <span class=n>obtainApplicationContext</span><span class=o>().</span><span class=na>getAliases</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>alias</span> <span class=o>:</span> <span class=n>aliases</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>alias</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;/&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>urls</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>alias</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>StringUtils</span><span class=o>.</span><span class=na>toStringArray</span><span class=o>(</span><span class=n>urls</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=2-根据访问url找到对应controller中处理请求的方法>2. 根据访问url找到对应controller中处理请求的方法</h3><p>下面我们开始分析第二个步骤,第二个步骤是由请求触发的,所以入口为<code>DispatcherServlet.DispatcherServlet</code>的核心方法为<code>doService()</code>,<code>doService()</code>中的核心逻辑由<code>doDispatch()</code>实现,我们查看<code>doDispatch()</code>的源代码.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Process the actual dispatching to the handler.
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;The handler will be obtained by applying the servlet&#39;s HandlerMappings in order.
</span></span></span><span class=line><span class=cl><span class=cm> * The HandlerAdapter will be obtained by querying the servlet&#39;s installed HandlerAdapters
</span></span></span><span class=line><span class=cl><span class=cm> * to find the first that supports the handler class.
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;All HTTP methods are handled by this method. It&#39;s up to HandlerAdapters or handlers
</span></span></span><span class=line><span class=cl><span class=cm> * themselves to decide which methods are acceptable.
</span></span></span><span class=line><span class=cl><span class=cm> * @param request current HTTP request
</span></span></span><span class=line><span class=cl><span class=cm> * @param response current HTTP response
</span></span></span><span class=line><span class=cl><span class=cm> * @throws Exception in case of any kind of processing failure
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cm>/** 中央控制器,控制请求的转发 **/</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doDispatch</span><span class=o>(</span><span class=n>HttpServletRequest</span> <span class=n>request</span><span class=o>,</span> <span class=n>HttpServletResponse</span> <span class=n>response</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>HttpServletRequest</span> <span class=n>processedRequest</span> <span class=o>=</span> <span class=n>request</span><span class=o>;</span>
</span></span><span class=line><span class=cl>   <span class=n>HandlerExecutionChain</span> <span class=n>mappedHandler</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>boolean</span> <span class=n>multipartRequestParsed</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>WebAsyncManager</span> <span class=n>asyncManager</span> <span class=o>=</span> <span class=n>WebAsyncUtils</span><span class=o>.</span><span class=na>getAsyncManager</span><span class=o>(</span><span class=n>request</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ModelAndView</span> <span class=n>mv</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>Exception</span> <span class=n>dispatchException</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 1.检查是否是文件上传的请求
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>processedRequest</span> <span class=o>=</span> <span class=n>checkMultipart</span><span class=o>(</span><span class=n>request</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=n>multipartRequestParsed</span> <span class=o>=</span> <span class=o>(</span><span class=n>processedRequest</span> <span class=o>!=</span> <span class=n>request</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// Determine handler for the current request.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>// 2.取得处理当前请求的controller,这里也称为hanlder,处理器
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>// 第一个步骤的意义就在这里体现了.这里并不是直接返回controller,
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>// 而是返回的HandlerExecutionChain请求处理器链对象,
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>// 该对象封装了handler和interceptors.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>mappedHandler</span> <span class=o>=</span> <span class=n>getHandler</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=o>(</span><span class=n>mappedHandler</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>noHandlerFound</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// Determine handler adapter for the current request.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>//3. 获取处理request的处理器适配器handler adapter 
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>HandlerAdapter</span> <span class=n>ha</span> <span class=o>=</span> <span class=n>getHandlerAdapter</span><span class=o>(</span><span class=n>mappedHandler</span><span class=o>.</span><span class=na>getHandler</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// Process last-modified header, if supported by the handler.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>// 处理 last-modified 请求头
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>String</span> <span class=n>method</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=na>getMethod</span><span class=o>();</span>
</span></span><span class=line><span class=cl>         <span class=kt>boolean</span> <span class=n>isGet</span> <span class=o>=</span> <span class=s>&#34;GET&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=o>(</span><span class=n>isGet</span> <span class=o>||</span> <span class=s>&#34;HEAD&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>method</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>long</span> <span class=n>lastModified</span> <span class=o>=</span> <span class=n>ha</span><span class=o>.</span><span class=na>getLastModified</span><span class=o>(</span><span class=n>request</span><span class=o>,</span> <span class=n>mappedHandler</span><span class=o>.</span><span class=na>getHandler</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=k>new</span> <span class=n>ServletWebRequest</span><span class=o>(</span><span class=n>request</span><span class=o>,</span> <span class=n>response</span><span class=o>).</span><span class=na>checkNotModified</span><span class=o>(</span><span class=n>lastModified</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>isGet</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>               <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>			 <span class=c1>// 4.拦截器的预处理方法
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=k>if</span> <span class=o>(!</span><span class=n>mappedHandler</span><span class=o>.</span><span class=na>applyPreHandle</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>response</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// Actually invoke the handler.
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=c1>// 5.实际的处理器处理请求,返回结果视图对象
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>mv</span> <span class=o>=</span> <span class=n>ha</span><span class=o>.</span><span class=na>handle</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>response</span><span class=o>,</span> <span class=n>mappedHandler</span><span class=o>.</span><span class=na>getHandler</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=o>(</span><span class=n>asyncManager</span><span class=o>.</span><span class=na>isConcurrentHandlingStarted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>		 <span class=c1>// 结果视图对象的处理
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>applyDefaultViewName</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>mv</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=c1>// 6.拦截器的后处理方法
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>mappedHandler</span><span class=o>.</span><span class=na>applyPostHandle</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>response</span><span class=o>,</span> <span class=n>mv</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=n>dispatchException</span> <span class=o>=</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>err</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=c1>// As of 4.3, we&#39;re processing Errors thrown from handler methods as well,
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>// making them available for @ExceptionHandler methods and other scenarios.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>dispatchException</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NestedServletException</span><span class=o>(</span><span class=s>&#34;Handler dispatch failed&#34;</span><span class=o>,</span> <span class=n>err</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>       <span class=c1>//将结果解析为ModelAndView
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>processDispatchResult</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>response</span><span class=o>,</span> <span class=n>mappedHandler</span><span class=o>,</span> <span class=n>mv</span><span class=o>,</span> <span class=n>dispatchException</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 请求成功响应之后的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>triggerAfterCompletion</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>response</span><span class=o>,</span> <span class=n>mappedHandler</span><span class=o>,</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>err</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>triggerAfterCompletion</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>response</span><span class=o>,</span> <span class=n>mappedHandler</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>NestedServletException</span><span class=o>(</span><span class=s>&#34;Handler processing failed&#34;</span><span class=o>,</span> <span class=n>err</span><span class=o>));</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>asyncManager</span><span class=o>.</span><span class=na>isConcurrentHandlingStarted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=c1>// Instead of postHandle and afterCompletion
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=k>if</span> <span class=o>(</span><span class=n>mappedHandler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mappedHandler</span><span class=o>.</span><span class=na>applyAfterConcurrentHandlingStarted</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=c1>// Clean up any resources used by a multipart request.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=k>if</span> <span class=o>(</span><span class=n>multipartRequestParsed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cleanupMultipart</span><span class=o>(</span><span class=n>processedRequest</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>第2步:<code>getHandler(processedRequest)</code>方法实际上就是从<code>HandlerMapping</code>中找到<code>url</code>和<code>Controller</code>的对应关系.这也就是第一个步骤:建立<code>Map&lt;url,Controller></code>的意义.我们知道,最终处理<code>Request</code>的是<code>Controller</code>中的方法,我们现在只是知道了<code>Controller</code>,还要进一步确认<code>Controller</code>中处理<code>Request</code>的方法.由于下面的步骤和第三个步骤关系更加紧密,直接转到第三个步骤.</p><h3 id=3-反射调用处理请求的方法返回结果视图>3. 反射调用处理请求的方法,返回结果视图</h3><p>上面的方法中,第2步其实就是从第一个步骤中的<code>Map&lt;urls,beanName></code>中取得<code>Controller</code>,然后经过拦截器的预处理方法,到最核心的部分&ndash;第5步调用<code>Controller</code>的方法处理请求.在第2步中我们可以知道处理<code>Request</code>的<code>Controller</code>,第5步就是要根据<code>url</code>确定<code>Controller</code>中处理请求的方法,然后通过反射获取该方法上的注解和参数,解析方法和参数上的注解,最后反射调用方法获取<code>ModelAndView</code>结果视图。</p><p>第5步调用的就是<code>RequestMappingHandlerAdapter</code>的<code>handle().handle()</code>中的核心逻辑由<code>invokeHandlerMethod(request, response, handler)</code>实现。</p><blockquote><p>handle().handle()&ndash;>handleInternal(request, response, (HandlerMethod) handler)&ndash;>invokeHandlerMethod(request, response, handlerMethod)</p></blockquote><p><code>RequestMappingHandlerAdapter类</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Invoke the {@link RequestMapping} handler method preparing a {@link ModelAndView}
</span></span></span><span class=line><span class=cl><span class=cm>	 * if view resolution is required.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see #createInvocableHandlerMethod(HandlerMethod)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>protected</span> <span class=n>ModelAndView</span> <span class=nf>invokeHandlerMethod</span><span class=o>(</span><span class=n>HttpServletRequest</span> <span class=n>request</span><span class=o>,</span>
</span></span><span class=line><span class=cl>			<span class=n>HttpServletResponse</span> <span class=n>response</span><span class=o>,</span> <span class=n>HandlerMethod</span> <span class=n>handlerMethod</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>ServletWebRequest</span> <span class=n>webRequest</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServletWebRequest</span><span class=o>(</span><span class=n>request</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>WebDataBinderFactory</span> <span class=n>binderFactory</span> <span class=o>=</span> <span class=n>getDataBinderFactory</span><span class=o>(</span><span class=n>handlerMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>ModelFactory</span> <span class=n>modelFactory</span> <span class=o>=</span> <span class=n>getModelFactory</span><span class=o>(</span><span class=n>handlerMethod</span><span class=o>,</span> <span class=n>binderFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=c1>//创建invocableMetho
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>ServletInvocableHandlerMethod</span> <span class=n>invocableMethod</span> <span class=o>=</span> <span class=n>createInvocableHandlerMethod</span><span class=o>(</span><span class=n>handlerMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>argumentResolvers</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>invocableMethod</span><span class=o>.</span><span class=na>setHandlerMethodArgumentResolvers</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>argumentResolvers</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>returnValueHandlers</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>invocableMethod</span><span class=o>.</span><span class=na>setHandlerMethodReturnValueHandlers</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>returnValueHandlers</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=n>invocableMethod</span><span class=o>.</span><span class=na>setDataBinderFactory</span><span class=o>(</span><span class=n>binderFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>invocableMethod</span><span class=o>.</span><span class=na>setParameterNameDiscoverer</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>parameterNameDiscoverer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>ModelAndViewContainer</span> <span class=n>mavContainer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ModelAndViewContainer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=n>mavContainer</span><span class=o>.</span><span class=na>addAllAttributes</span><span class=o>(</span><span class=n>RequestContextUtils</span><span class=o>.</span><span class=na>getInputFlashMap</span><span class=o>(</span><span class=n>request</span><span class=o>));</span>
</span></span><span class=line><span class=cl>			<span class=n>modelFactory</span><span class=o>.</span><span class=na>initModel</span><span class=o>(</span><span class=n>webRequest</span><span class=o>,</span> <span class=n>mavContainer</span><span class=o>,</span> <span class=n>invocableMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>mavContainer</span><span class=o>.</span><span class=na>setIgnoreDefaultModelOnRedirect</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>ignoreDefaultModelOnRedirect</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>AsyncWebRequest</span> <span class=n>asyncWebRequest</span> <span class=o>=</span> <span class=n>WebAsyncUtils</span><span class=o>.</span><span class=na>createAsyncWebRequest</span><span class=o>(</span><span class=n>request</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>asyncWebRequest</span><span class=o>.</span><span class=na>setTimeout</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>asyncRequestTimeout</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>WebAsyncManager</span> <span class=n>asyncManager</span> <span class=o>=</span> <span class=n>WebAsyncUtils</span><span class=o>.</span><span class=na>getAsyncManager</span><span class=o>(</span><span class=n>request</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>asyncManager</span><span class=o>.</span><span class=na>setTaskExecutor</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>taskExecutor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>asyncManager</span><span class=o>.</span><span class=na>setAsyncWebRequest</span><span class=o>(</span><span class=n>asyncWebRequest</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>asyncManager</span><span class=o>.</span><span class=na>registerCallableInterceptors</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>callableInterceptors</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>asyncManager</span><span class=o>.</span><span class=na>registerDeferredResultInterceptors</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>deferredResultInterceptors</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>asyncManager</span><span class=o>.</span><span class=na>hasConcurrentResult</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Object</span> <span class=n>result</span> <span class=o>=</span> <span class=n>asyncManager</span><span class=o>.</span><span class=na>getConcurrentResult</span><span class=o>();</span>
</span></span><span class=line><span class=cl>				<span class=n>mavContainer</span> <span class=o>=</span> <span class=o>(</span><span class=n>ModelAndViewContainer</span><span class=o>)</span> <span class=n>asyncManager</span><span class=o>.</span><span class=na>getConcurrentResultContext</span><span class=o>()[</span><span class=n>0</span><span class=o>];</span>
</span></span><span class=line><span class=cl>				<span class=n>asyncManager</span><span class=o>.</span><span class=na>clearConcurrentResult</span><span class=o>();</span>
</span></span><span class=line><span class=cl>				<span class=n>LogFormatUtils</span><span class=o>.</span><span class=na>traceDebug</span><span class=o>(</span><span class=n>logger</span><span class=o>,</span> <span class=n>traceOn</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>String</span> <span class=n>formatted</span> <span class=o>=</span> <span class=n>LogFormatUtils</span><span class=o>.</span><span class=na>formatValue</span><span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=o>!</span><span class=n>traceOn</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=s>&#34;Resume with async result [&#34;</span> <span class=o>+</span> <span class=n>formatted</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>				<span class=o>});</span>
</span></span><span class=line><span class=cl>				<span class=n>invocableMethod</span> <span class=o>=</span> <span class=n>invocableMethod</span><span class=o>.</span><span class=na>wrapConcurrentResult</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>//执行ServletInvocableHandlerMethod的invokeAndHandle方法		
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>invocableMethod</span><span class=o>.</span><span class=na>invokeAndHandle</span><span class=o>(</span><span class=n>webRequest</span><span class=o>,</span> <span class=n>mavContainer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>asyncManager</span><span class=o>.</span><span class=na>isConcurrentHandlingStarted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 封装结果视图
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=n>getModelAndView</span><span class=o>(</span><span class=n>mavContainer</span><span class=o>,</span> <span class=n>modelFactory</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>webRequest</span><span class=o>.</span><span class=na>requestCompleted</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span></code></pre></div><p><code>invocableMethod.setHandlerMethodArgumentResolvers(this.argumentResolvers);</code>为参数绑定，后面说</p><p>其中<code>invokeAndHandle</code>如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Invoke the method and handle the return value through one of the
</span></span></span><span class=line><span class=cl><span class=cm>	 * configured {@link HandlerMethodReturnValueHandler HandlerMethodReturnValueHandlers}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param webRequest the current request
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param mavContainer the ModelAndViewContainer for this request
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param providedArgs &#34;given&#34; arguments matched by type (not resolved)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>invokeAndHandle</span><span class=o>(</span><span class=n>ServletWebRequest</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>ModelAndViewContainer</span> <span class=n>mavContainer</span><span class=o>,</span>
</span></span><span class=line><span class=cl>			<span class=n>Object</span><span class=o>...</span> <span class=n>providedArgs</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>//执行请求对应的方法，并获得返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>Object</span> <span class=n>returnValue</span> <span class=o>=</span> <span class=n>invokeForRequest</span><span class=o>(</span><span class=n>webRequest</span><span class=o>,</span> <span class=n>mavContainer</span><span class=o>,</span> <span class=n>providedArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>setResponseStatus</span><span class=o>(</span><span class=n>webRequest</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>returnValue</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>isRequestNotModified</span><span class=o>(</span><span class=n>webRequest</span><span class=o>)</span> <span class=o>||</span> <span class=n>getResponseStatus</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>mavContainer</span><span class=o>.</span><span class=na>isRequestHandled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>mavContainer</span><span class=o>.</span><span class=na>setRequestHandled</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>getResponseStatusReason</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>mavContainer</span><span class=o>.</span><span class=na>setRequestHandled</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>mavContainer</span><span class=o>.</span><span class=na>setRequestHandled</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>Assert</span><span class=o>.</span><span class=na>state</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>returnValueHandlers</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>,</span> <span class=s>&#34;No return value handlers&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>returnValueHandlers</span><span class=o>.</span><span class=na>handleReturnValue</span><span class=o>(</span>
</span></span><span class=line><span class=cl>					<span class=n>returnValue</span><span class=o>,</span> <span class=n>getReturnValueType</span><span class=o>(</span><span class=n>returnValue</span><span class=o>),</span> <span class=n>mavContainer</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=n>formatErrorForReturnValue</span><span class=o>(</span><span class=n>returnValue</span><span class=o>),</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span></code></pre></div><p><code>invokeForRequest</code>中的操作也是比较简单的，首先获取<code>request</code>中的参数，然后调用<code>doInvoke(args)</code>方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>Object</span> <span class=nf>invokeForRequest</span><span class=o>(</span><span class=n>NativeWebRequest</span> <span class=n>request</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>ModelAndViewContainer</span> <span class=n>mavContainer</span><span class=o>,</span>
</span></span><span class=line><span class=cl>			<span class=n>Object</span><span class=o>...</span> <span class=n>providedArgs</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=c1>//首先会获取请求的参数，其实就是Controller方法中的参数
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>Object</span><span class=o>[]</span> <span class=n>args</span> <span class=o>=</span> <span class=n>getMethodArgumentValues</span><span class=o>(</span><span class=n>request</span><span class=o>,</span> <span class=n>mavContainer</span><span class=o>,</span> <span class=n>providedArgs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;Arguments: &#34;</span> <span class=o>+</span> <span class=n>Arrays</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>args</span><span class=o>));</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//调用Controller中的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=n>doInvoke</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span></code></pre></div><p><code>doInvoke</code>方法是在<code>InvocableHandlerMethod``类中，最重要的是调用getBridgedMethod().invoke(getBean(),args)</code>，通过反射机制完成对<code>Controller</code>中的函数的调用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//InvocableHandlerMethod类	
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/** 
</span></span></span><span class=line><span class=cl><span class=cm>	 * Invoke the handler method with the given argument values.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>protected</span> <span class=n>Object</span> <span class=nf>doInvoke</span><span class=o>(</span><span class=n>Object</span><span class=o>...</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//反射之前 取消Java的权限控制检查
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>ReflectionUtils</span><span class=o>.</span><span class=na>makeAccessible</span><span class=o>(</span><span class=n>getBridgedMethod</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>//通过执行controller中的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=n>getBridgedMethod</span><span class=o>().</span><span class=na>invoke</span><span class=o>(</span><span class=n>getBean</span><span class=o>(),</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>catch</span> <span class=o>(</span><span class=n>IllegalArgumentException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>assertTargetBean</span><span class=o>(</span><span class=n>getBridgedMethod</span><span class=o>(),</span> <span class=n>getBean</span><span class=o>(),</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>String</span> <span class=n>text</span> <span class=o>=</span> <span class=o>(</span><span class=n>ex</span><span class=o>.</span><span class=na>getMessage</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>ex</span><span class=o>.</span><span class=na>getMessage</span><span class=o>()</span> <span class=o>:</span> <span class=s>&#34;Illegal argument&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=n>formatInvokeError</span><span class=o>(</span><span class=n>text</span><span class=o>,</span> <span class=n>args</span><span class=o>),</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>catch</span> <span class=o>(</span><span class=n>InvocationTargetException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Unwrap for HandlerExceptionResolvers ...
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>Throwable</span> <span class=n>targetException</span> <span class=o>=</span> <span class=n>ex</span><span class=o>.</span><span class=na>getTargetException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>targetException</span> <span class=k>instanceof</span> <span class=n>RuntimeException</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=o>(</span><span class=n>RuntimeException</span><span class=o>)</span> <span class=n>targetException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>targetException</span> <span class=k>instanceof</span> <span class=n>Error</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=o>(</span><span class=n>Error</span><span class=o>)</span> <span class=n>targetException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>targetException</span> <span class=k>instanceof</span> <span class=n>Exception</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=o>(</span><span class=n>Exception</span><span class=o>)</span> <span class=n>targetException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=n>formatInvokeError</span><span class=o>(</span><span class=s>&#34;Invocation failure&#34;</span><span class=o>,</span> <span class=n>args</span><span class=o>),</span> <span class=n>targetException</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span></code></pre></div><p><strong>注</strong>：桥接方法是 JDK 1.5 引入泛型后，为了使Java的泛型方法生成的字节码和 1.5 版本前的字节码相兼容，由编译器自动生成的方法。</p><p>反正最终就是通过反射来调用<code>Controller</code>中的方法。</p><h3 id=4-参数绑定>4. 参数绑定</h3><p>resolveHandlerArguments方法实现代码比较长,它最终要实现的目的就是:完成request中的参数和方法参数上数据的绑定.</p><p>springmvc中提供两种request参数到方法中参数的绑定方式:</p><h4 id=注解-1>注解</h4><p>使用注解进行绑定,我们只要在方法参数前面声明 <code>@RequestParam("a")</code>,就可以将 <code>Request</code> 中参数 <code>a</code> 的值绑定到方法的该参数上。</p><h4 id=参数名称-1>参数名称</h4><p>使用参数名称进行绑定的前提是必须要获取方法中参数的名称,Java 反射只提供了获取方法的参数的类型,并没有提供获取参数名称的方法。SpringMVC 解决这个问题的方法是用 asm 框架读取字节码文件,来获取方法的参数名称。asm 框架是一个字节码操作框架,关于a sm 更多介绍可以参考它的官网。</p><p>个人建议,使用注解来完成参数绑定,这样就可以省去 asm 框架的读取字节码的操作。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>Object</span><span class=o>[]</span> <span class=nf>resolveHandlerArguments</span><span class=o>(</span><span class=n>Method</span> <span class=n>handlerMethod</span><span class=o>,</span> <span class=n>Object</span> <span class=n>handler</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>NativeWebRequest</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>ExtendedModelMap</span> <span class=n>implicitModel</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>　　　　 <span class=c1>// 1.获取方法参数类型的数组
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Class</span><span class=o>[]</span> <span class=n>paramTypes</span> <span class=o>=</span> <span class=n>handlerMethod</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>　　　　<span class=c1>// 声明数组,存参数的值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>paramTypes</span><span class=o>.</span><span class=na>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>　　　　<span class=c1>//2.遍历参数数组,获取每个参数的值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>args</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>MethodParameter</span> <span class=n>methodParam</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MethodParameter</span><span class=o>(</span><span class=n>handlerMethod</span><span class=o>,</span> <span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>methodParam</span><span class=o>.</span><span class=na>initParameterNameDiscovery</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>parameterNameDiscoverer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>GenericTypeResolver</span><span class=o>.</span><span class=na>resolveParameterType</span><span class=o>(</span><span class=n>methodParam</span><span class=o>,</span> <span class=n>handler</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>paramName</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>headerName</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>requestBodyFound</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>cookieName</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>pathVarName</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>attrName</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>required</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>defaultValue</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>validate</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>annotationsFound</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>Annotation</span><span class=o>[]</span> <span class=n>paramAnns</span> <span class=o>=</span> <span class=n>methodParam</span><span class=o>.</span><span class=na>getParameterAnnotations</span><span class=o>();</span>
</span></span><span class=line><span class=cl>　　　　　　 <span class=c1>// 处理参数上的注解
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=n>Annotation</span> <span class=n>paramAnn</span> <span class=o>:</span> <span class=n>paramAnns</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>RequestParam</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isInstance</span><span class=o>(</span><span class=n>paramAnn</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>RequestParam</span> <span class=n>requestParam</span> <span class=o>=</span> <span class=o>(</span><span class=n>RequestParam</span><span class=o>)</span> <span class=n>paramAnn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>paramName</span> <span class=o>=</span> <span class=n>requestParam</span><span class=o>.</span><span class=na>value</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>required</span> <span class=o>=</span> <span class=n>requestParam</span><span class=o>.</span><span class=na>required</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>defaultValue</span> <span class=o>=</span> <span class=n>parseDefaultValueAttribute</span><span class=o>(</span><span class=n>requestParam</span><span class=o>.</span><span class=na>defaultValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>annotationsFound</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>RequestHeader</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isInstance</span><span class=o>(</span><span class=n>paramAnn</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>RequestHeader</span> <span class=n>requestHeader</span> <span class=o>=</span> <span class=o>(</span><span class=n>RequestHeader</span><span class=o>)</span> <span class=n>paramAnn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>headerName</span> <span class=o>=</span> <span class=n>requestHeader</span><span class=o>.</span><span class=na>value</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>required</span> <span class=o>=</span> <span class=n>requestHeader</span><span class=o>.</span><span class=na>required</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>defaultValue</span> <span class=o>=</span> <span class=n>parseDefaultValueAttribute</span><span class=o>(</span><span class=n>requestHeader</span><span class=o>.</span><span class=na>defaultValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>annotationsFound</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>RequestBody</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isInstance</span><span class=o>(</span><span class=n>paramAnn</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>requestBodyFound</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>annotationsFound</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>CookieValue</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isInstance</span><span class=o>(</span><span class=n>paramAnn</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>CookieValue</span> <span class=n>cookieValue</span> <span class=o>=</span> <span class=o>(</span><span class=n>CookieValue</span><span class=o>)</span> <span class=n>paramAnn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>cookieName</span> <span class=o>=</span> <span class=n>cookieValue</span><span class=o>.</span><span class=na>value</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>required</span> <span class=o>=</span> <span class=n>cookieValue</span><span class=o>.</span><span class=na>required</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>defaultValue</span> <span class=o>=</span> <span class=n>parseDefaultValueAttribute</span><span class=o>(</span><span class=n>cookieValue</span><span class=o>.</span><span class=na>defaultValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>annotationsFound</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>PathVariable</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isInstance</span><span class=o>(</span><span class=n>paramAnn</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>PathVariable</span> <span class=n>pathVar</span> <span class=o>=</span> <span class=o>(</span><span class=n>PathVariable</span><span class=o>)</span> <span class=n>paramAnn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>pathVarName</span> <span class=o>=</span> <span class=n>pathVar</span><span class=o>.</span><span class=na>value</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>annotationsFound</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>ModelAttribute</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isInstance</span><span class=o>(</span><span class=n>paramAnn</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ModelAttribute</span> <span class=n>attr</span> <span class=o>=</span> <span class=o>(</span><span class=n>ModelAttribute</span><span class=o>)</span> <span class=n>paramAnn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>attrName</span> <span class=o>=</span> <span class=n>attr</span><span class=o>.</span><span class=na>value</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>annotationsFound</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Value</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isInstance</span><span class=o>(</span><span class=n>paramAnn</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>defaultValue</span> <span class=o>=</span> <span class=o>((</span><span class=n>Value</span><span class=o>)</span> <span class=n>paramAnn</span><span class=o>).</span><span class=na>value</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;Valid&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>paramAnn</span><span class=o>.</span><span class=na>annotationType</span><span class=o>().</span><span class=na>getSimpleName</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>validate</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>　　
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>annotationsFound</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Handler parameter annotations are exclusive choices - &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;do not specify more than one such annotation on the same parameter: &#34;</span> <span class=o>+</span> <span class=n>handlerMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>annotationsFound</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span><span class=c1>// 如果没有注解
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Object</span> <span class=n>argValue</span> <span class=o>=</span> <span class=n>resolveCommonArgument</span><span class=o>(</span><span class=n>methodParam</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>argValue</span> <span class=o>!=</span> <span class=n>WebArgumentResolver</span><span class=o>.</span><span class=na>UNRESOLVED</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>argValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>defaultValue</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>resolveDefaultValue</span><span class=o>(</span><span class=n>defaultValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Class</span> <span class=n>paramType</span> <span class=o>=</span> <span class=n>methodParam</span><span class=o>.</span><span class=na>getParameterType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>　　　　　　　　　　  <span class=c1>// 将方法声明中的Map和Model参数,放到request中,用于将数据放到request中带回页面
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>Model</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>paramType</span><span class=o>)</span> <span class=o>||</span> <span class=n>Map</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>paramType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>implicitModel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>SessionStatus</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>paramType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>sessionStatus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>HttpEntity</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>paramType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>resolveHttpEntityRequest</span><span class=o>(</span><span class=n>methodParam</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Errors</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>paramType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Errors/BindingResult argument declared &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s>&#34;without preceding model attribute. Check your handler method signature!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>BeanUtils</span><span class=o>.</span><span class=na>isSimpleProperty</span><span class=o>(</span><span class=n>paramType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>paramName</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>attrName</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>　　　　　　　<span class=c1>// 从request中取值,并进行赋值操作
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>paramName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>　　　　　　　　　<span class=c1>// 根据paramName从request中取值,如果没有通过RequestParam注解指定paramName,则使用asm读取class文件来获取paramName
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>resolveRequestParam</span><span class=o>(</span><span class=n>paramName</span><span class=o>,</span> <span class=n>required</span><span class=o>,</span> <span class=n>defaultValue</span><span class=o>,</span> <span class=n>methodParam</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>headerName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>resolveRequestHeader</span><span class=o>(</span><span class=n>headerName</span><span class=o>,</span> <span class=n>required</span><span class=o>,</span> <span class=n>defaultValue</span><span class=o>,</span> <span class=n>methodParam</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>requestBodyFound</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>resolveRequestBody</span><span class=o>(</span><span class=n>methodParam</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>cookieName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>resolveCookieValue</span><span class=o>(</span><span class=n>cookieName</span><span class=o>,</span> <span class=n>required</span><span class=o>,</span> <span class=n>defaultValue</span><span class=o>,</span> <span class=n>methodParam</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>pathVarName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>resolvePathVariable</span><span class=o>(</span><span class=n>pathVarName</span><span class=o>,</span> <span class=n>methodParam</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>attrName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>WebDataBinder</span> <span class=n>binder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                        <span class=n>resolveModelAttribute</span><span class=o>(</span><span class=n>attrName</span><span class=o>,</span> <span class=n>methodParam</span><span class=o>,</span> <span class=n>implicitModel</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=kt>boolean</span> <span class=n>assignBindingResult</span> <span class=o>=</span> <span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=n>i</span> <span class=o>+</span> <span class=n>1</span> <span class=o>&amp;&amp;</span> <span class=n>Errors</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>paramTypes</span><span class=o>[</span><span class=n>i</span> <span class=o>+</span> <span class=n>1</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>binder</span><span class=o>.</span><span class=na>getTarget</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>doBind</span><span class=o>(</span><span class=n>binder</span><span class=o>,</span> <span class=n>webRequest</span><span class=o>,</span> <span class=n>validate</span><span class=o>,</span> <span class=o>!</span><span class=n>assignBindingResult</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=n>args</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>binder</span><span class=o>.</span><span class=na>getTarget</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>assignBindingResult</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>args</span><span class=o>[</span><span class=n>i</span> <span class=o>+</span> <span class=n>1</span><span class=o>]</span> <span class=o>=</span> <span class=n>binder</span><span class=o>.</span><span class=na>getBindingResult</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=n>implicitModel</span><span class=o>.</span><span class=na>putAll</span><span class=o>(</span><span class=n>binder</span><span class=o>.</span><span class=na>getBindingResult</span><span class=o>().</span><span class=na>getModel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>　　　　 <span class=c1>// 返回参数值数组
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>args</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><h3 id=5-反射源码分析>5. 反射源码分析</h3><p>反射相关分析来源于：<code>http://www.sczyh30.com/posts/Java/java-reflection-2/</code></p><p>第三步中的<code>invoke</code>方法如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=nd>@CallerSensitive</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span> <span class=n>obj</span><span class=o>,</span> <span class=n>Object</span><span class=o>...</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>IllegalAccessException</span><span class=o>,</span> <span class=n>IllegalArgumentException</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=n>InvocationTargetException</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>override</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//quickCheckMemberAccess 检查方法是否为public 如果是的话跳出本步
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(!</span><span class=n>Reflection</span><span class=o>.</span><span class=na>quickCheckMemberAccess</span><span class=o>(</span><span class=n>clazz</span><span class=o>,</span> <span class=n>modifiers</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//如果不是public方法，那么用Reflection.getCallerClass()方法获取调用这个方法的Class对象，这是一个native方法:
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>caller</span> <span class=o>=</span> <span class=n>Reflection</span><span class=o>.</span><span class=na>getCallerClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>checkAccess</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=n>clazz</span><span class=o>,</span> <span class=n>obj</span><span class=o>,</span> <span class=n>modifiers</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>MethodAccessor</span> <span class=n>ma</span> <span class=o>=</span> <span class=n>methodAccessor</span><span class=o>;</span>             <span class=c1>// read volatile
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>ma</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ma</span> <span class=o>=</span> <span class=n>acquireMethodAccessor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ma</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>obj</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><p>getCallerClass()是一个native方法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@CallerSensitive</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>native</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>getCallerClass</span><span class=o>();</span>
</span></span></code></pre></div><p>在OpenJDK的源码中找到此方法的JNI入口(Reflection.c):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>JNIEXPORT</span> <span class=n>jclass</span> <span class=n>JNICALL</span> <span class=nf>Java_sun_reflect_Reflection_getCallerClass__</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>JNIEnv</span> <span class=o>*</span><span class=n>env</span><span class=p>,</span> <span class=n>jclass</span> <span class=n>unused</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>JVM_GetCallerClass</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>JVM_CALLER_DEPTH</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>获取了这个Class对象caller后用checkAccess方法做一次快速的权限校验，其实现为:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>volatile</span> <span class=n>Object</span> <span class=n>securityCheckCache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>checkAccess</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>caller</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span><span class=o>,</span> <span class=n>Object</span> <span class=n>obj</span><span class=o>,</span> <span class=kt>int</span> <span class=n>modifiers</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>IllegalAccessException</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>caller</span> <span class=o>==</span> <span class=n>clazz</span><span class=o>)</span> <span class=o>{</span>  <span class=c1>// 快速校验
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span><span class=o>;</span>             <span class=c1>// 权限通过校验
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>cache</span> <span class=o>=</span> <span class=n>securityCheckCache</span><span class=o>;</span>  <span class=c1>// read volatile
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>targetClass</span> <span class=o>=</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>obj</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>Modifier</span><span class=o>.</span><span class=na>isProtected</span><span class=o>(</span><span class=n>modifiers</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=o>((</span><span class=n>targetClass</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=na>getClass</span><span class=o>())</span> <span class=o>!=</span> <span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Must match a 2-list of { caller, targetClass }.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>cache</span> <span class=k>instanceof</span> <span class=n>Class</span><span class=o>[])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>cache2</span> <span class=o>=</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;[])</span> <span class=n>cache</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>cache2</span><span class=o>[</span><span class=n>1</span><span class=o>]</span> <span class=o>==</span> <span class=n>targetClass</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                    <span class=n>cache2</span><span class=o>[</span><span class=n>0</span><span class=o>]</span> <span class=o>==</span> <span class=n>caller</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span><span class=o>;</span>     <span class=c1>// ACCESS IS OK
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// (Test cache[1] first since range check for [1]
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// subsumes range check for [0].)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>cache</span> <span class=o>==</span> <span class=n>caller</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Non-protected case (or obj.class == this.clazz).
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span><span class=o>;</span>             <span class=c1>// ACCESS IS OK
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// If no return, fall through to the slow path.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>slowCheckMemberAccess</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=n>clazz</span><span class=o>,</span> <span class=n>obj</span><span class=o>,</span> <span class=n>modifiers</span><span class=o>,</span> <span class=n>targetClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><p>首先先执行一次快速校验，一旦调用方法的Class正确则权限检查通过。
若未通过，则创建一个缓存，中间再进行一堆检查（比如检验是否为protected属性）。
如果上面的所有权限检查都未通过，那么将执行更详细的检查，其实现为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Keep all this slow stuff out of line:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>slowCheckMemberAccess</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>caller</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span><span class=o>,</span> <span class=n>Object</span> <span class=n>obj</span><span class=o>,</span> <span class=kt>int</span> <span class=n>modifiers</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>targetClass</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>throws</span> <span class=n>IllegalAccessException</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Reflection</span><span class=o>.</span><span class=na>ensureMemberAccess</span><span class=o>(</span><span class=n>caller</span><span class=o>,</span> <span class=n>clazz</span><span class=o>,</span> <span class=n>obj</span><span class=o>,</span> <span class=n>modifiers</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Success: Update the cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Object</span> <span class=n>cache</span> <span class=o>=</span> <span class=o>((</span><span class=n>targetClass</span> <span class=o>==</span> <span class=n>clazz</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>?</span> <span class=n>caller</span>
</span></span><span class=line><span class=cl>                    <span class=o>:</span> <span class=k>new</span> <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=o>{</span> <span class=n>caller</span><span class=o>,</span> <span class=n>targetClass</span> <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Note:  The two cache elements are not volatile,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// but they are effectively final.  The Java memory model
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// guarantees that the initializing stores for the cache
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// elements will occur before the volatile write.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>securityCheckCache</span> <span class=o>=</span> <span class=n>cache</span><span class=o>;</span>         <span class=c1>// write volatile
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><p>大体意思就是，用Reflection.ensureMemberAccess方法继续检查权限，若检查通过就更新缓存，这样下一次同一个类调用同一个方法时就不用执行权限检查了，这是一种简单的缓存机制。由于JMM的happens-before规则能够保证缓存初始化能够在写缓存之前发生，因此两个cache不需要声明为volatile。
到这里，前期的权限检查工作就结束了。如果没有通过检查则会抛出异常，如果通过了检查则会到下一步。</p><h4 id=调用methodaccessor的invoke方法>调用MethodAccessor的invoke方法</h4><p>Method.invoke()实际上并不是自己实现的反射调用逻辑，而是委托给sun.reflect.MethodAccessor来处理。
首先要了解Method对象的基本构成，每个Java方法有且只有一个Method对象作为root，它相当于根对象，对用户不可见。当我们创建Method对象时，我们代码中获得的Method对象都相当于它的副本（或引用）。root对象持有一个MethodAccessor对象，所以所有获取到的Method对象都共享这一个MethodAccessor对象，因此必须保证它在内存中的可见性。root对象其声明及注释为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>volatile</span> <span class=n>MethodAccessor</span> <span class=n>methodAccessor</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>// For sharing of MethodAccessors. This branching structure is
</span></span></span><span class=line><span class=cl><span class=c1>// currently only two levels deep (i.e., one root Method and
</span></span></span><span class=line><span class=cl><span class=c1>// potentially many Method objects pointing to it.)
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// If this branching structure would ever contain cycles, deadlocks can
</span></span></span><span class=line><span class=cl><span class=c1>// occur in annotation code.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=n>Method</span>  <span class=n>root</span><span class=o>;</span>
</span></span></code></pre></div><p>那么MethodAccessor到底是个啥玩意呢？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/** This interface provides the declaration for
</span></span></span><span class=line><span class=cl><span class=cm>    java.lang.reflect.Method.invoke(). Each Method object is
</span></span></span><span class=line><span class=cl><span class=cm>    configured with a (possibly dynamically-generated) class which
</span></span></span><span class=line><span class=cl><span class=cm>    implements this interface.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MethodAccessor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/** Matches specification in {@link java.lang.reflect.Method} */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span> <span class=n>obj</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>IllegalArgumentException</span><span class=o>,</span> <span class=n>InvocationTargetException</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>可以看到MethodAccessor是一个接口，定义了invoke方法。分析其Usage可得它的具体实现类有:</p><ul><li>sun.reflect.DelegatingMethodAccessorImpl</li><li>sun.reflect.MethodAccessorImpl</li><li>sun.reflect.NativeMethodAccessorImpl</li></ul><p>第一次调用一个Java方法对应的Method对象的invoke()方法之前，实现调用逻辑的MethodAccessor对象还没有创建；等第一次调用时才新创建MethodAccessor并更新给root，然后调用MethodAccessor.invoke()完成反射调用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// NOTE that there is no synchronization used here. It is correct
</span></span></span><span class=line><span class=cl><span class=c1>// (though not efficient) to generate more than one MethodAccessor
</span></span></span><span class=line><span class=cl><span class=c1>// for a given Method. However, avoiding synchronization will
</span></span></span><span class=line><span class=cl><span class=c1>// probably make the implementation more scalable.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=n>MethodAccessor</span> <span class=nf>acquireMethodAccessor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// First check to see if one has been created yet, and take it
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// if so
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>MethodAccessor</span> <span class=n>tmp</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>root</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=n>tmp</span> <span class=o>=</span> <span class=n>root</span><span class=o>.</span><span class=na>getMethodAccessor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>tmp</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>methodAccessor</span> <span class=o>=</span> <span class=n>tmp</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Otherwise fabricate one and propagate it up to the root
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>tmp</span> <span class=o>=</span> <span class=n>reflectionFactory</span><span class=o>.</span><span class=na>newMethodAccessor</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>setMethodAccessor</span><span class=o>(</span><span class=n>tmp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tmp</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>可以看到methodAccessor实例由reflectionFactory对象操控生成，它在AccessibleObject下的声明如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Reflection factory used by subclasses for creating field,
</span></span></span><span class=line><span class=cl><span class=c1>// method, and constructor accessors. Note that this is called
</span></span></span><span class=line><span class=cl><span class=c1>// very early in the bootstrapping process.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>static</span> <span class=kd>final</span> <span class=n>ReflectionFactory</span> <span class=n>reflectionFactory</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>AccessController</span><span class=o>.</span><span class=na>doPrivileged</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>sun</span><span class=o>.</span><span class=na>reflect</span><span class=o>.</span><span class=na>ReflectionFactory</span><span class=o>.</span><span class=na>GetReflectionFactoryAction</span><span class=o>());</span>
</span></span></code></pre></div><p>再研究一下sun.reflect.ReflectionFactory类的源码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ReflectionFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=n>initted</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Permission</span> <span class=n>reflectionFactoryAccessPerm</span>
</span></span><span class=line><span class=cl>        <span class=o>=</span> <span class=k>new</span> <span class=n>RuntimePermission</span><span class=o>(</span><span class=s>&#34;reflectionFactoryAccess&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ReflectionFactory</span> <span class=n>soleInstance</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReflectionFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Provides access to package-private mechanisms in java.lang.reflect
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>volatile</span> <span class=n>LangReflectAccess</span> <span class=n>langReflectAccess</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里设计得非常巧妙
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// &#34;Inflation&#34; mechanism. Loading bytecodes to implement
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Method.invoke() and Constructor.newInstance() currently costs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 3-4x more than an invocation via native code for the first
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// invocation (though subsequent invocations have been benchmarked
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// to be over 20x faster). Unfortunately this cost increases
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// startup time for certain applications that use reflection
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// intensively (but only once per class) to bootstrap themselves.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// To avoid this penalty we reuse the existing JVM entry points
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// for the first few invocations of Methods and Constructors and
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// then switch to the bytecode-based implementations.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Package-private to be accessible to NativeMethodAccessorImpl
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// and NativeConstructorAccessorImpl
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=n>noInflation</span>        <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span>     <span class=n>inflationThreshold</span> <span class=o>=</span> <span class=n>15</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>//这是生成MethodAccessor的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=n>MethodAccessor</span> <span class=nf>newMethodAccessor</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>checkInitted</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>noInflation</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>ReflectUtil</span><span class=o>.</span><span class=na>isVMAnonymousClass</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>MethodAccessorGenerator</span><span class=o>().</span>
</span></span><span class=line><span class=cl>                <span class=n>generateMethod</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                               <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                               <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                               <span class=n>method</span><span class=o>.</span><span class=na>getReturnType</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                               <span class=n>method</span><span class=o>.</span><span class=na>getExceptionTypes</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                               <span class=n>method</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>NativeMethodAccessorImpl</span> <span class=n>acc</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>NativeMethodAccessorImpl</span><span class=o>(</span><span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>DelegatingMethodAccessorImpl</span> <span class=n>res</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>DelegatingMethodAccessorImpl</span><span class=o>(</span><span class=n>acc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>acc</span><span class=o>.</span><span class=na>setParent</span><span class=o>(</span><span class=n>res</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>res</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=cm>/** We have to defer full initialization of this class until after
</span></span></span><span class=line><span class=cl><span class=cm>    the static initializer is run since java.lang.reflect.Method&#39;s
</span></span></span><span class=line><span class=cl><span class=cm>    static initializer (more properly, that for
</span></span></span><span class=line><span class=cl><span class=cm>    java.lang.reflect.AccessibleObject) causes this class&#39;s to be
</span></span></span><span class=line><span class=cl><span class=cm>    run, before the system properties are set up. */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>checkInitted</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>initted</span><span class=o>)</span> <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>AccessController</span><span class=o>.</span><span class=na>doPrivileged</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>PrivilegedAction</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=n>Void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// Tests to ensure the system properties table is fully
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// initialized. This is needed because reflection code is
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// called very early in the initialization process (before
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// command-line arguments have been parsed and therefore
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// these user-settable properties installed.) We assume that
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// if System.out is non-null then the System class has been
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// fully initialized and that the bulk of the startup code
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// has been run.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>out</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// java.lang.System not yet fully initialized
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>String</span> <span class=n>val</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;sun.reflect.noInflation&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>val</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>val</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;true&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>noInflation</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>val</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;sun.reflect.inflationThreshold&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>val</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>inflationThreshold</span> <span class=o>=</span> <span class=n>Integer</span><span class=o>.</span><span class=na>parseInt</span><span class=o>(</span><span class=n>val</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NumberFormatException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Unable to parse property sun.reflect.inflationThreshold&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>initted</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>观察前面的声明部分的注释，我们可以发现一些有趣的东西。就像注释里说的，实际的MethodAccessor实现有两个版本，一个是Java版本，一个是native版本，两者各有特点。初次启动时Method.invoke()和Constructor.newInstance()方法采用native方法要比Java方法快3-4倍，而启动后native方法又要消耗额外的性能而慢于Java方法。也就是说，Java实现的版本在初始化时需要较多时间，但长久来说性能较好；native版本正好相反，启动时相对较快，但运行时间长了之后速度就比不过Java版了。这是HotSpot的优化方式带来的性能特性，同时也是许多虚拟机的共同点：跨越native边界会对优化有阻碍作用，它就像个黑箱一样让虚拟机难以分析也将其内联，于是运行时间长了之后反而是托管版本的代码更快些。</p><p>为了尽可能地减少性能损耗，HotSpot JDK采用“inflation”的技巧：让Java方法在被反射调用时，开头若干次使用native版，等反射调用次数超过阈值时则生成一个专用的MethodAccessor实现类，生成其中的invoke()方法的字节码，以后对该Java方法的反射调用就会使用Java版本。 这项优化是从JDK 1.4开始的。</p><p>研究ReflectionFactory.newMethodAccessor()生产MethodAccessor对象的逻辑，一开始(native版)会生产NativeMethodAccessorImpl和DelegatingMethodAccessorImpl两个对象。
DelegatingMethodAccessorImpl的源码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/** Delegates its invocation to another MethodAccessorImpl and can
</span></span></span><span class=line><span class=cl><span class=cm>    change its delegate at run time. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DelegatingMethodAccessorImpl</span> <span class=kd>extends</span> <span class=n>MethodAccessorImpl</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>MethodAccessorImpl</span> <span class=n>delegate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>DelegatingMethodAccessorImpl</span><span class=o>(</span><span class=n>MethodAccessorImpl</span> <span class=n>delegate</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setDelegate</span><span class=o>(</span><span class=n>delegate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span> <span class=n>obj</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>IllegalArgumentException</span><span class=o>,</span> <span class=n>InvocationTargetException</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>delegate</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>obj</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>setDelegate</span><span class=o>(</span><span class=n>MethodAccessorImpl</span> <span class=n>delegate</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>delegate</span> <span class=o>=</span> <span class=n>delegate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>它其实是一个中间层，方便在native版与Java版的MethodAccessor之间进行切换。
然后下面就是native版MethodAccessor的Java方面的声明：
sun.reflect.NativeMethodAccessorImpl：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/** Used only for the first few invocations of a Method; afterward,
</span></span></span><span class=line><span class=cl><span class=cm>    switches to bytecode-based implementation */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>NativeMethodAccessorImpl</span> <span class=kd>extends</span> <span class=n>MethodAccessorImpl</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Method</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>DelegatingMethodAccessorImpl</span> <span class=n>parent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>numInvocations</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>NativeMethodAccessorImpl</span><span class=o>(</span><span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>method</span> <span class=o>=</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span> <span class=n>obj</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>IllegalArgumentException</span><span class=o>,</span> <span class=n>InvocationTargetException</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We can&#39;t inflate methods belonging to vm-anonymous classes because
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// that kind of class can&#39;t be referred to by name, hence can&#39;t be
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// found from the generated bytecode.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(++</span><span class=n>numInvocations</span> <span class=o>&gt;</span> <span class=n>ReflectionFactory</span><span class=o>.</span><span class=na>inflationThreshold</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>ReflectUtil</span><span class=o>.</span><span class=na>isVMAnonymousClass</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>MethodAccessorImpl</span> <span class=n>acc</span> <span class=o>=</span> <span class=o>(</span><span class=n>MethodAccessorImpl</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>MethodAccessorGenerator</span><span class=o>().</span>
</span></span><span class=line><span class=cl>                    <span class=n>generateMethod</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getDeclaringClass</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                                   <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                                   <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                                   <span class=n>method</span><span class=o>.</span><span class=na>getReturnType</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                                   <span class=n>method</span><span class=o>.</span><span class=na>getExceptionTypes</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                                   <span class=n>method</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>parent</span><span class=o>.</span><span class=na>setDelegate</span><span class=o>(</span><span class=n>acc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>invoke0</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>obj</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>setParent</span><span class=o>(</span><span class=n>DelegatingMethodAccessorImpl</span> <span class=n>parent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>parent</span> <span class=o>=</span> <span class=n>parent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>native</span> <span class=n>Object</span> <span class=nf>invoke0</span><span class=o>(</span><span class=n>Method</span> <span class=n>m</span><span class=o>,</span> <span class=n>Object</span> <span class=n>obj</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>每次NativeMethodAccessorImpl.invoke()方法被调用时，程序调用计数器都会增加1，看看是否超过阈值；一旦超过，则调用MethodAccessorGenerator.generateMethod()来生成Java版的MethodAccessor的实现类，并且改变DelegatingMethodAccessorImpl所引用的MethodAccessor为Java版。后续经由DelegatingMethodAccessorImpl.invoke()调用到的就是Java版的实现了。
到这里，我们已经追寻到native版的invoke方法在Java一侧声明的最底层 - invoke0了，下面我们将深入到HotSpot JVM中去研究其具体实现。</p><h4 id=寻根溯源---在jvm层面探究invoke0方法>寻根溯源 - 在JVM层面探究invoke0方法</h4><p>invoke0方法是一个native方法,它在HotSpot JVM里调用JVM_InvokeMethod函数:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>JNIEXPORT</span> <span class=n>jobject</span> <span class=n>JNICALL</span> <span class=nf>Java_sun_reflect_NativeMethodAccessorImpl_invoke0</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>JNIEnv</span> <span class=o>*</span><span class=n>env</span><span class=p>,</span> <span class=n>jclass</span> <span class=n>unused</span><span class=p>,</span> <span class=n>jobject</span> <span class=n>m</span><span class=p>,</span> <span class=n>jobject</span> <span class=n>obj</span><span class=p>,</span> <span class=n>jobjectArray</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>JVM_InvokeMethod</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>obj</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>openjdk/hotspot/src/share/vm/prims/jvm.cpp</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>JVM_ENTRY</span><span class=p>(</span><span class=n>jobject</span><span class=p>,</span> <span class=n>JVM_InvokeMethod</span><span class=p>(</span><span class=n>JNIEnv</span> <span class=o>*</span><span class=n>env</span><span class=p>,</span> <span class=n>jobject</span> <span class=n>method</span><span class=p>,</span> <span class=n>jobject</span> <span class=n>obj</span><span class=p>,</span> <span class=n>jobjectArray</span> <span class=n>args0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=n>JVMWrapper</span><span class=p>(</span><span class=s>&#34;JVM_InvokeMethod&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Handle</span> <span class=n>method_handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>stack_available</span><span class=p>((</span><span class=n>address</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>method_handle</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>JVMInvokeMethodSlack</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>method_handle</span> <span class=o>=</span> <span class=n>Handle</span><span class=p>(</span><span class=n>THREAD</span><span class=p>,</span> <span class=n>JNIHandles</span><span class=o>::</span><span class=n>resolve</span><span class=p>(</span><span class=n>method</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>Handle</span> <span class=nf>receiver</span><span class=p>(</span><span class=n>THREAD</span><span class=p>,</span> <span class=n>JNIHandles</span><span class=o>::</span><span class=n>resolve</span><span class=p>(</span><span class=n>obj</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>objArrayHandle</span> <span class=nf>args</span><span class=p>(</span><span class=n>THREAD</span><span class=p>,</span> <span class=n>objArrayOop</span><span class=p>(</span><span class=n>JNIHandles</span><span class=o>::</span><span class=n>resolve</span><span class=p>(</span><span class=n>args0</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>oop</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Reflection</span><span class=o>::</span><span class=n>invoke_method</span><span class=p>(</span><span class=n>method_handle</span><span class=p>(),</span> <span class=n>receiver</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>CHECK_NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>jobject</span> <span class=n>res</span> <span class=o>=</span> <span class=n>JNIHandles</span><span class=o>::</span><span class=n>make_local</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>JvmtiExport</span><span class=o>::</span><span class=n>should_post_vm_object_alloc</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>oop</span> <span class=n>ret_type</span> <span class=o>=</span> <span class=n>java_lang_reflect_Method</span><span class=o>::</span><span class=n>return_type</span><span class=p>(</span><span class=n>method_handle</span><span class=p>());</span>
</span></span><span class=line><span class=cl>      <span class=n>assert</span><span class=p>(</span><span class=n>ret_type</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=s>&#34;sanity check: ret_type oop must not be NULL!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>java_lang_Class</span><span class=o>::</span><span class=n>is_primitive</span><span class=p>(</span><span class=n>ret_type</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Only for primitive type vm allocates memory for java object.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// See box() method.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>JvmtiExport</span><span class=o>::</span><span class=n>post_vm_object_alloc</span><span class=p>(</span><span class=n>JavaThread</span><span class=o>::</span><span class=n>current</span><span class=p>(),</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>THROW_0</span><span class=p>(</span><span class=n>vmSymbols</span><span class=o>::</span><span class=n>java_lang_StackOverflowError</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>JVM_END</span>
</span></span></code></pre></div><p>其关键部分为Reflection::invoke_method:</p><ul><li>openjdk/hotspot/src/share/vm/runtime/reflection.cpp</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>oop</span> <span class=n>Reflection</span><span class=o>::</span><span class=n>invoke_method</span><span class=p>(</span><span class=n>oop</span> <span class=n>method_mirror</span><span class=p>,</span> <span class=n>Handle</span> <span class=n>receiver</span><span class=p>,</span> <span class=n>objArrayHandle</span> <span class=n>args</span><span class=p>,</span> <span class=n>TRAPS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>oop</span> <span class=n>mirror</span>             <span class=o>=</span> <span class=n>java_lang_reflect_Method</span><span class=o>::</span><span class=n>clazz</span><span class=p>(</span><span class=n>method_mirror</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>slot</span>               <span class=o>=</span> <span class=n>java_lang_reflect_Method</span><span class=o>::</span><span class=n>slot</span><span class=p>(</span><span class=n>method_mirror</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=n>override</span>          <span class=o>=</span> <span class=n>java_lang_reflect_Method</span><span class=o>::</span><span class=n>override</span><span class=p>(</span><span class=n>method_mirror</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>objArrayHandle</span> <span class=nf>ptypes</span><span class=p>(</span><span class=n>THREAD</span><span class=p>,</span> <span class=n>objArrayOop</span><span class=p>(</span><span class=n>java_lang_reflect_Method</span><span class=o>::</span><span class=n>parameter_types</span><span class=p>(</span><span class=n>method_mirror</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>oop</span> <span class=n>return_type_mirror</span> <span class=o>=</span> <span class=n>java_lang_reflect_Method</span><span class=o>::</span><span class=n>return_type</span><span class=p>(</span><span class=n>method_mirror</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>BasicType</span> <span class=n>rtype</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>java_lang_Class</span><span class=o>::</span><span class=n>is_primitive</span><span class=p>(</span><span class=n>return_type_mirror</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>rtype</span> <span class=o>=</span> <span class=n>basic_type_mirror_to_basic_type</span><span class=p>(</span><span class=n>return_type_mirror</span><span class=p>,</span> <span class=n>CHECK_NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>rtype</span> <span class=o>=</span> <span class=n>T_OBJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>instanceKlassHandle</span> <span class=n>klass</span><span class=p>(</span><span class=n>THREAD</span><span class=p>,</span> <span class=n>java_lang_Class</span><span class=o>::</span><span class=n>as_Klass</span><span class=p>(</span><span class=n>mirror</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>Method</span><span class=o>*</span> <span class=n>m</span> <span class=o>=</span> <span class=n>klass</span><span class=o>-&gt;</span><span class=n>method_with_idnum</span><span class=p>(</span><span class=n>slot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>m</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>THROW_MSG_0</span><span class=p>(</span><span class=n>vmSymbols</span><span class=o>::</span><span class=n>java_lang_InternalError</span><span class=p>(),</span> <span class=s>&#34;invoke&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>methodHandle</span> <span class=n>method</span><span class=p>(</span><span class=n>THREAD</span><span class=p>,</span> <span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>invoke</span><span class=p>(</span><span class=n>klass</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>receiver</span><span class=p>,</span> <span class=n>override</span><span class=p>,</span> <span class=n>ptypes</span><span class=p>,</span> <span class=n>rtype</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=nb>true</span><span class=p>,</span> <span class=n>THREAD</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里面又会涉及到Java的对象模型(klass和oop)，以后继续补充。笑容逐渐消失。</p><h4 id=寻根溯源---java版的实现>寻根溯源 - Java版的实现</h4><p>Java版MethodAccessor的生成使用MethodAccessorGenerator实现，由于代码太长，这里就不贴代码了，只贴一下开头的注释：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/** Generator for sun.reflect.MethodAccessor and
</span></span></span><span class=line><span class=cl><span class=cm>    sun.reflect.ConstructorAccessor objects using bytecodes to
</span></span></span><span class=line><span class=cl><span class=cm>    implement reflection. A java.lang.reflect.Method or
</span></span></span><span class=line><span class=cl><span class=cm>    java.lang.reflect.Constructor object can delegate its invoke or
</span></span></span><span class=line><span class=cl><span class=cm>    newInstance method to an accessor using native code or to one
</span></span></span><span class=line><span class=cl><span class=cm>    generated by this class. (Methods and Constructors were merged
</span></span></span><span class=line><span class=cl><span class=cm>    together in this class to ensure maximum code sharing.) */</span>
</span></span></code></pre></div><p>这里又运用了asm动态生成字节码技术（sun.reflect.ClassFileAssembler)。</p><h2 id=5-小结>5. 小结</h2><p>大致流程如下：</p><ul><li>1.建立 Map&lt;url,comtroller> 的关系</li><li>2.根据 url 找到具体的处理方法</li><li>3.通过反射调用 controller 中的方法</li><li>4.通过<code>注解</code>或<code>参数名称</code>实现参数绑定</li></ul><h2 id=参考>参考</h2><p><code>https://www.cnblogs.com/heavenyes/p/3905844.html#t1</code></p><p><code>sczyh30: http://www.sczyh30.com/posts/Java/java-reflection-2/</code>　</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2018-10-17</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.yudlk.com/posts/java/ssm/04-springmvc-process/ data-title=SSM系列(四)---SpringMVC执行流程分析 data-hashtags=SpringMVC><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.yudlk.com/posts/java/ssm/04-springmvc-process/ data-hashtag=SpringMVC><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.yudlk.com/posts/java/ssm/04-springmvc-process/ data-title=SSM系列(四)---SpringMVC执行流程分析><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.yudlk.com/posts/java/ssm/04-springmvc-process/ data-title=SSM系列(四)---SpringMVC执行流程分析><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.yudlk.com/posts/java/ssm/04-springmvc-process/ data-title=SSM系列(四)---SpringMVC执行流程分析><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/springmvc/>SpringMVC</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/java/ssm/03-beanfactory-applicationcontext-diff/ class=prev rel=prev title="SSM系列(三)---BeanFactory 与 ApplicationContext"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>SSM系列(三)---BeanFactory 与 ApplicationContext</a>
<a href=/posts/java/ssm/05-mybatis/ class=next rel=next title="SSM系列(五)---Mybatis SQL 执行流程分析">SSM系列(五)---Mybatis SQL 执行流程分析<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/lixd target=_blank>qpt</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a rel="license external nofollow noopener noreffer" href=https://beian.miit.gov.cn/ target=_blank>渝ICP备20005680号-1</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.480e58b2c2a8605d406f34667e92ff8f1ae50cfee5b653bead570f004839a983.js integrity="sha256-SA5YssKoYF1AbzRmfpL/jxrlDP7ltlO+rVcPAEg5qYM="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-FL23FNP7CM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-FL23FNP7CM" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b7c98449a6edf8492a8f3404e6d06a0",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7693630257897132" crossorigin=anonymous></script></body></html>